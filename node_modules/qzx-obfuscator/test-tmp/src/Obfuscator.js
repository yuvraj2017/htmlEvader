"use strict";

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var inversify_1 = require("inversify");
var ServiceIdentifiers_1 = require("./container/ServiceIdentifiers");
var estraverse = require("estraverse");
var NodeTransformer_1 = require("./enums/container/node-transformers/NodeTransformer");
var ObfuscationEvent_1 = require("./enums/event-emitters/ObfuscationEvent");
var VisitorDirection_1 = require("./enums/VisitorDirection");
var Node_1 = require("./node/Node");
var NodeUtils_1 = require("./node/NodeUtils");
var Obfuscator = Obfuscator_1 = function () {
    function Obfuscator(stackTraceAnalyzer, obfuscationEventEmitter, customNodeGroupStorage, nodeTransformerFactory, options) {
        _classCallCheck(this, Obfuscator);

        this.stackTraceAnalyzer = stackTraceAnalyzer;
        this.obfuscationEventEmitter = obfuscationEventEmitter;
        this.customNodeGroupStorage = customNodeGroupStorage;
        this.nodeTransformerFactory = nodeTransformerFactory;
        this.options = options;
    }

    _createClass(Obfuscator, [{
        key: "obfuscateAstTree",
        value: function obfuscateAstTree(astTree) {
            var _this = this;

            if (Node_1.Node.isProgramNode(astTree) && !astTree.body.length) {
                return astTree;
            }
            astTree = NodeUtils_1.NodeUtils.parentize(astTree);
            var stackTraceData = this.stackTraceAnalyzer.analyze(astTree.body);
            this.customNodeGroupStorage.getStorage().forEach(function (customNodeGroup) {
                customNodeGroup.initialize();
                _this.obfuscationEventEmitter.once(customNodeGroup.getAppendEvent(), customNodeGroup.appendCustomNodes.bind(customNodeGroup));
            });
            this.obfuscationEventEmitter.emit(ObfuscationEvent_1.ObfuscationEvent.BeforeObfuscation, astTree, stackTraceData);
            astTree = this.transformAstTree(astTree, [].concat(_toConsumableArray(this.options.deadCodeInjection ? Obfuscator_1.deadCodeInjectionTransformersList : [])));
            astTree = this.transformAstTree(astTree, [].concat(_toConsumableArray(this.options.controlFlowFlattening ? Obfuscator_1.controlFlowTransformersList : [])));
            astTree = this.transformAstTree(astTree, [].concat(_toConsumableArray(Obfuscator_1.convertingTransformersList), _toConsumableArray(Obfuscator_1.obfuscatingTransformersList)));
            this.obfuscationEventEmitter.emit(ObfuscationEvent_1.ObfuscationEvent.AfterObfuscation, astTree, stackTraceData);
            return astTree;
        }
    }, {
        key: "transformAstTree",
        value: function transformAstTree(astTree, nodeTransformers) {
            if (!nodeTransformers.length) {
                return astTree;
            }
            var enterVisitors = [];
            var leaveVisitors = [];
            var nodeTransformersLength = nodeTransformers.length;
            var visitor = void 0;
            for (var i = 0; i < nodeTransformersLength; i++) {
                visitor = this.nodeTransformerFactory(nodeTransformers[i]).getVisitor();
                if (visitor.enter) {
                    enterVisitors.push(visitor);
                }
                if (visitor.leave) {
                    leaveVisitors.push(visitor);
                }
            }
            estraverse.replace(astTree, {
                enter: this.mergeVisitorsForDirection(enterVisitors, VisitorDirection_1.VisitorDirection.Enter),
                leave: this.mergeVisitorsForDirection(leaveVisitors, VisitorDirection_1.VisitorDirection.Leave)
            });
            return astTree;
        }
    }, {
        key: "mergeVisitorsForDirection",
        value: function mergeVisitorsForDirection(visitors, direction) {
            if (!visitors.length) {
                return function (node, parentNode) {
                    return node;
                };
            }
            var visitorsLength = visitors.length;
            var visitor = void 0;
            return function (node, parentNode) {
                for (var i = 0; i < visitorsLength; i++) {
                    visitor = visitors[i];
                    var visitorFunction = visitor[direction];
                    if (!visitorFunction) {
                        continue;
                    }
                    var visitorResult = visitorFunction(node, parentNode);
                    if (!visitorResult) {
                        continue;
                    }
                    node = visitorResult;
                }
                return node;
            };
        }
    }]);

    return Obfuscator;
}();
Obfuscator.controlFlowTransformersList = [NodeTransformer_1.NodeTransformer.BlockStatementControlFlowTransformer, NodeTransformer_1.NodeTransformer.FunctionControlFlowTransformer];
Obfuscator.convertingTransformersList = [NodeTransformer_1.NodeTransformer.MemberExpressionTransformer, NodeTransformer_1.NodeTransformer.MethodDefinitionTransformer, NodeTransformer_1.NodeTransformer.TemplateLiteralTransformer];
Obfuscator.deadCodeInjectionTransformersList = [NodeTransformer_1.NodeTransformer.DeadCodeInjectionTransformer];
Obfuscator.obfuscatingTransformersList = [NodeTransformer_1.NodeTransformer.CatchClauseTransformer, NodeTransformer_1.NodeTransformer.FunctionDeclarationTransformer, NodeTransformer_1.NodeTransformer.FunctionTransformer, NodeTransformer_1.NodeTransformer.LabeledStatementTransformer, NodeTransformer_1.NodeTransformer.LiteralTransformer, NodeTransformer_1.NodeTransformer.ObjectExpressionTransformer, NodeTransformer_1.NodeTransformer.VariableDeclarationTransformer];
Obfuscator = Obfuscator_1 = tslib_1.__decorate([inversify_1.injectable(), tslib_1.__param(0, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.IStackTraceAnalyzer)), tslib_1.__param(1, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.IObfuscationEventEmitter)), tslib_1.__param(2, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.TCustomNodeGroupStorage)), tslib_1.__param(3, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.Factory__INodeTransformer)), tslib_1.__param(4, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.IOptions)), tslib_1.__metadata("design:paramtypes", [Object, Object, Object, Function, Object])], Obfuscator);
exports.Obfuscator = Obfuscator;
var Obfuscator_1;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT2JmdXNjYXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9PYmZ1c2NhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQSwwQkFBK0M7QUFDL0MsbUNBQW9FO0FBRXBFLHlCQUF5QztBQWdCekMsZ0NBQXNGO0FBQ3RGLGlDQUEyRTtBQUMzRSxpQ0FBNEQ7QUFFNUQscUJBQW1DO0FBQ25DLDBCQUE2QztBQUc3QyxJQUFhLEFBQVU7QUFzRW5CLHdCQUNvRCxBQUF1QyxvQkFDbEMsQUFBaUQseUJBQ2xELEFBQWtELHdCQUNoRCxBQUErQyx3QkFDaEUsQUFBaUI7OztBQUV0RCxBQUFJLGFBQUMsQUFBa0IscUJBQUcsQUFBa0IsQUFBQztBQUM3QyxBQUFJLGFBQUMsQUFBdUIsMEJBQUcsQUFBdUIsQUFBQztBQUN2RCxBQUFJLGFBQUMsQUFBc0IseUJBQUcsQUFBc0IsQUFBQztBQUNyRCxBQUFJLGFBQUMsQUFBc0IseUJBQUcsQUFBc0IsQUFBQztBQUNyRCxBQUFJLGFBQUMsQUFBTyxVQUFHLEFBQU8sQUFBQyxBQUMzQjtBQUFDLEFBTU0sQUFBZ0I7O0FBeEYzQjs7eUNBd0Y2QixBQUF1Qjs7O0FBQzVDLEFBQUUsQUFBQyxnQkFBQyxPQUFJLEtBQUMsQUFBYSxjQUFDLEFBQU8sQUFBQyxZQUFJLENBQUMsQUFBTyxRQUFDLEFBQUksS0FBQyxBQUFNLEFBQUMsUUFBQyxBQUFDO0FBQ3RELEFBQU0sdUJBQUMsQUFBTyxBQUFDLEFBQ25CO0FBQUM7QUFFRCxBQUFPLHNCQUFtQixZQUFTLFVBQUMsQUFBUyxVQUFDLEFBQU8sQUFBQyxBQUFDO0FBRXZELGdCQUFNLEFBQWMsaUJBQXNCLEFBQUksS0FBQyxBQUFrQixtQkFBQyxBQUFPLFFBQUMsQUFBTyxRQUFDLEFBQUksQUFBQyxBQUFDO0FBR3hGLEFBQUksaUJBQUMsQUFBc0IsdUJBQ3RCLEFBQVUsQUFBRSxhQUNaLEFBQU8sUUFBQyxVQUFDLEFBQWlDO0FBQ3ZD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Qix3QkFDdEMsa0JBQWUsZ0JBQUMsQUFBOEIsZ0NBQzlDLGtCQUFlLGdCQUFDLEFBQW1CLHFCQUNuQyxrQkFBZSxnQkFBQyxBQUEyQiw2QkFDM0Msa0JBQWUsZ0JBQUMsQUFBa0Isb0JBQ2xDLGtCQUFlLGdCQUFDLEFBQTJCLDZCQUMzQyxrQkFBZSxnQkFBQyxBQUE4QixBQUNqRCxBQUFDO0FBcENPLEFBQVUsZ0RBRHRCLFlBQVUsQUFBRSxjQXdFSixtQkFBQSxZQUFNLE9BQUMscUJBQWtCLG1CQUFDLEFBQW1CLEFBQUMsdUJBQzlDLG1CQUFBLFlBQU0sT0FBQyxxQkFBa0IsbUJBQUMsQUFBd0IsQUFBQyw0QkFDbkQsbUJBQUEsWUFBTSxPQUFDLHFCQUFrQixtQkFBQyxBQUF1QixBQUFDLDJCQUNsRCxtQkFBQSxZQUFNLE9BQUMscUJBQWtCLG1CQUFDLEFBQXlCLEFBQUMsNkJBQ3BELG1CQUFBLFlBQU0sT0FBQyxxQkFBa0IsbUJBQUMsQUFBUSxBQUFDLGtHQTNFL0IsQUFBVSxBQStNdEI7QUEvTVkscUJBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpbmplY3RhYmxlLCBpbmplY3QgfSBmcm9tICdpbnZlcnNpZnknO1xuaW1wb3J0IHsgU2VydmljZUlkZW50aWZpZXJzIH0gZnJvbSAnLi9jb250YWluZXIvU2VydmljZUlkZW50aWZpZXJzJztcblxuaW1wb3J0ICogYXMgZXN0cmF2ZXJzZSBmcm9tICdlc3RyYXZlcnNlJztcbmltcG9ydCAqIGFzIEVTVHJlZSBmcm9tICdlc3RyZWUnO1xuXG5pbXBvcnQgeyBUTm9kZVRyYW5zZm9ybWVyRmFjdG9yeSB9IGZyb20gJy4vdHlwZXMvY29udGFpbmVyL25vZGUtdHJhbnNmb3JtZXJzL1ROb2RlVHJhbnNmb3JtZXJGYWN0b3J5JztcbmltcG9ydCB7IFRWaXNpdG9yRGlyZWN0aW9uIH0gZnJvbSAnLi90eXBlcy9UVmlzaXRvckRpcmVjdGlvbic7XG5pbXBvcnQgeyBUVmlzaXRvckZ1bmN0aW9uIH0gZnJvbSAnLi90eXBlcy9UVmlzaXRvckZ1bmN0aW9uJztcblxuaW1wb3J0IHsgSUN1c3RvbU5vZGVHcm91cCB9IGZyb20gJy4vaW50ZXJmYWNlcy9jdXN0b20tbm9kZXMvSUN1c3RvbU5vZGVHcm91cCc7XG5pbXBvcnQgeyBJT2JmdXNjYXRpb25FdmVudEVtaXR0ZXIgfSBmcm9tICcuL2ludGVyZmFjZXMvZXZlbnQtZW1pdHRlcnMvSU9iZnVzY2F0aW9uRXZlbnRFbWl0dGVyJztcbmltcG9ydCB7IElPYmZ1c2NhdG9yIH0gZnJvbSAnLi9pbnRlcmZhY2VzL0lPYmZ1c2NhdG9yJztcbmltcG9ydCB7IElPcHRpb25zIH0gZnJvbSAnLi9pbnRlcmZhY2VzL29wdGlvbnMvSU9wdGlvbnMnO1xuaW1wb3J0IHsgSVN0YWNrVHJhY2VBbmFseXplciB9IGZyb20gJy4vaW50ZXJmYWNlcy9zdGFjay10cmFjZS1hbmFseXplci9JU3RhY2tUcmFjZUFuYWx5emVyJztcbmltcG9ydCB7IElTdGFja1RyYWNlRGF0YSB9IGZyb20gJy4vaW50ZXJmYWNlcy9zdGFjay10cmFjZS1hbmFseXplci9JU3RhY2tUcmFjZURhdGEnO1xuaW1wb3J0IHsgSVN0b3JhZ2UgfSBmcm9tICcuL2ludGVyZmFjZXMvc3RvcmFnZXMvSVN0b3JhZ2UnO1xuaW1wb3J0IHsgSVZpc2l0b3IgfSBmcm9tICcuL2ludGVyZmFjZXMvSVZpc2l0b3InO1xuXG5pbXBvcnQgeyBOb2RlVHJhbnNmb3JtZXIgfSBmcm9tICcuL2VudW1zL2NvbnRhaW5lci9ub2RlLXRyYW5zZm9ybWVycy9Ob2RlVHJhbnNmb3JtZXInO1xuaW1wb3J0IHsgT2JmdXNjYXRpb25FdmVudCB9IGZyb20gJy4vZW51bXMvZXZlbnQtZW1pdHRlcnMvT2JmdXNjYXRpb25FdmVudCc7XG5pbXBvcnQgeyBWaXNpdG9yRGlyZWN0aW9uIH0gZnJvbSAnLi9lbnVtcy9WaXNpdG9yRGlyZWN0aW9uJztcblxuaW1wb3J0IHsgTm9kZSB9IGZyb20gJy4vbm9kZS9Ob2RlJztcbmltcG9ydCB7IE5vZGVVdGlscyB9IGZyb20gJy4vbm9kZS9Ob2RlVXRpbHMnO1xuXG5AaW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgT2JmdXNjYXRvciBpbXBsZW1lbnRzIElPYmZ1c2NhdG9yIHtcbiAgICAvKipcbiAgICAgKiBAdHlwZSB7Tm9kZVRyYW5zZm9ybWVyW119XG4gICAgICovXG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgY29udHJvbEZsb3dUcmFuc2Zvcm1lcnNMaXN0OiBOb2RlVHJhbnNmb3JtZXJbXSA9IFtcbiAgICAgICAgTm9kZVRyYW5zZm9ybWVyLkJsb2NrU3RhdGVtZW50Q29udHJvbEZsb3dUcmFuc2Zvcm1lcixcbiAgICAgICAgTm9kZVRyYW5zZm9ybWVyLkZ1bmN0aW9uQ29udHJvbEZsb3dUcmFuc2Zvcm1lclxuICAgIF07XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7Tm9kZVRyYW5zZm9ybWVyW119XG4gICAgICovXG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgY29udmVydGluZ1RyYW5zZm9ybWVyc0xpc3Q6IE5vZGVUcmFuc2Zvcm1lcltdID0gW1xuICAgICAgICBOb2RlVHJhbnNmb3JtZXIuTWVtYmVyRXhwcmVzc2lvblRyYW5zZm9ybWVyLFxuICAgICAgICBOb2RlVHJhbnNmb3JtZXIuTWV0aG9kRGVmaW5pdGlvblRyYW5zZm9ybWVyLFxuICAgICAgICBOb2RlVHJhbnNmb3JtZXIuVGVtcGxhdGVMaXRlcmFsVHJhbnNmb3JtZXJcbiAgICBdO1xuXG4gICAgLyoqXG4gICAgICogQHR5cGUge05vZGVUcmFuc2Zvcm1lcltdfVxuICAgICAqL1xuICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IGRlYWRDb2RlSW5qZWN0aW9uVHJhbnNmb3JtZXJzTGlzdDogTm9kZVRyYW5zZm9ybWVyW10gPSBbXG4gICAgICAgIE5vZGVUcmFuc2Zvcm1lci5EZWFkQ29kZUluamVjdGlvblRyYW5zZm9ybWVyXG4gICAgXTtcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtOb2RlVHJhbnNmb3JtZXJbXX1cbiAgICAgKi9cbiAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBvYmZ1c2NhdGluZ1RyYW5zZm9ybWVyc0xpc3Q6IE5vZGVUcmFuc2Zvcm1lcltdID0gW1xuICAgICAgICBOb2RlVHJhbnNmb3JtZXIuQ2F0Y2hDbGF1c2VUcmFuc2Zvcm1lcixcbiAgICAgICAgTm9kZVRyYW5zZm9ybWVyLkZ1bmN0aW9uRGVjbGFyYXRpb25UcmFuc2Zvcm1lcixcbiAgICAgICAgTm9kZVRyYW5zZm9ybWVyLkZ1bmN0aW9uVHJhbnNmb3JtZXIsXG4gICAgICAgIE5vZGVUcmFuc2Zvcm1lci5MYWJlbGVkU3RhdGVtZW50VHJhbnNmb3JtZXIsXG4gICAgICAgIE5vZGVUcmFuc2Zvcm1lci5MaXRlcmFsVHJhbnNmb3JtZXIsXG4gICAgICAgIE5vZGVUcmFuc2Zvcm1lci5PYmplY3RFeHByZXNzaW9uVHJhbnNmb3JtZXIsXG4gICAgICAgIE5vZGVUcmFuc2Zvcm1lci5WYXJpYWJsZURlY2xhcmF0aW9uVHJhbnNmb3JtZXJcbiAgICBdO1xuXG4gICAgLyoqXG4gICAgICogQHR5cGUge0lTdG9yYWdlPElDdXN0b21Ob2RlR3JvdXA+fVxuICAgICAqL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgY3VzdG9tTm9kZUdyb3VwU3RvcmFnZTogSVN0b3JhZ2U8SUN1c3RvbU5vZGVHcm91cD47XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7VE5vZGVUcmFuc2Zvcm1lckZhY3Rvcnl9XG4gICAgICovXG4gICAgcHJpdmF0ZSByZWFkb25seSBub2RlVHJhbnNmb3JtZXJGYWN0b3J5OiBUTm9kZVRyYW5zZm9ybWVyRmFjdG9yeTtcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtJT2JmdXNjYXRpb25FdmVudEVtaXR0ZXJ9XG4gICAgICovXG4gICAgcHJpdmF0ZSByZWFkb25seSBvYmZ1c2NhdGlvbkV2ZW50RW1pdHRlcjogSU9iZnVzY2F0aW9uRXZlbnRFbWl0dGVyO1xuXG4gICAgLyoqXG4gICAgICogQHR5cGUge0lPcHRpb25zfVxuICAgICAqL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgb3B0aW9uczogSU9wdGlvbnM7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7SVN0YWNrVHJhY2VBbmFseXplcn1cbiAgICAgKi9cbiAgICBwcml2YXRlIHJlYWRvbmx5IHN0YWNrVHJhY2VBbmFseXplcjogSVN0YWNrVHJhY2VBbmFseXplcjtcblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7SVN0YWNrVHJhY2VBbmFseXplcn0gc3RhY2tUcmFjZUFuYWx5emVyXG4gICAgICogQHBhcmFtIHtJT2JmdXNjYXRpb25FdmVudEVtaXR0ZXJ9IG9iZnVzY2F0aW9uRXZlbnRFbWl0dGVyXG4gICAgICogQHBhcmFtIHtJU3RvcmFnZTxJQ3VzdG9tTm9kZUdyb3VwPn0gY3VzdG9tTm9kZUdyb3VwU3RvcmFnZVxuICAgICAqIEBwYXJhbSB7VE5vZGVUcmFuc2Zvcm1lckZhY3Rvcnl9IG5vZGVUcmFuc2Zvcm1lckZhY3RvcnlcbiAgICAgKiBAcGFyYW0ge0lPcHRpb25zfSBvcHRpb25zXG4gICAgICovXG4gICAgY29uc3RydWN0b3IgKFxuICAgICAgICBAaW5qZWN0KFNlcnZpY2VJZGVudGlmaWVycy5JU3RhY2tUcmFjZUFuYWx5emVyKSBzdGFja1RyYWNlQW5hbHl6ZXI6IElTdGFja1RyYWNlQW5hbHl6ZXIsXG4gICAgICAgIEBpbmplY3QoU2VydmljZUlkZW50aWZpZXJzLklPYmZ1c2NhdGlvbkV2ZW50RW1pdHRlcikgb2JmdXNjYXRpb25FdmVudEVtaXR0ZXI6IElPYmZ1c2NhdGlvbkV2ZW50RW1pdHRlcixcbiAgICAgICAgQGluamVjdChTZXJ2aWNlSWRlbnRpZmllcnMuVEN1c3RvbU5vZGVHcm91cFN0b3JhZ2UpIGN1c3RvbU5vZGVHcm91cFN0b3JhZ2U6IElTdG9yYWdlPElDdXN0b21Ob2RlR3JvdXA+LFxuICAgICAgICBAaW5qZWN0KFNlcnZpY2VJZGVudGlmaWVycy5GYWN0b3J5X19JTm9kZVRyYW5zZm9ybWVyKSBub2RlVHJhbnNmb3JtZXJGYWN0b3J5OiBUTm9kZVRyYW5zZm9ybWVyRmFjdG9yeSxcbiAgICAgICAgQGluamVjdChTZXJ2aWNlSWRlbnRpZmllcnMuSU9wdGlvbnMpIG9wdGlvbnM6IElPcHRpb25zXG4gICAgKSB7XG4gICAgICAgIHRoaXMuc3RhY2tUcmFjZUFuYWx5emVyID0gc3RhY2tUcmFjZUFuYWx5emVyO1xuICAgICAgICB0aGlzLm9iZnVzY2F0aW9uRXZlbnRFbWl0dGVyID0gb2JmdXNjYXRpb25FdmVudEVtaXR0ZXI7XG4gICAgICAgIHRoaXMuY3VzdG9tTm9kZUdyb3VwU3RvcmFnZSA9IGN1c3RvbU5vZGVHcm91cFN0b3JhZ2U7XG4gICAgICAgIHRoaXMubm9kZVRyYW5zZm9ybWVyRmFjdG9yeSA9IG5vZGVUcmFuc2Zvcm1lckZhY3Rvcnk7XG4gICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtQcm9ncmFtfSBhc3RUcmVlXG4gICAgICogQHJldHVybnMge1Byb2dyYW19XG4gICAgICovXG4gICAgcHVibGljIG9iZnVzY2F0ZUFzdFRyZWUgKGFzdFRyZWU6IEVTVHJlZS5Qcm9ncmFtKTogRVNUcmVlLlByb2dyYW0ge1xuICAgICAgICBpZiAoTm9kZS5pc1Byb2dyYW1Ob2RlKGFzdFRyZWUpICYmICFhc3RUcmVlLmJvZHkubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm4gYXN0VHJlZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGFzdFRyZWUgPSA8RVNUcmVlLlByb2dyYW0+Tm9kZVV0aWxzLnBhcmVudGl6ZShhc3RUcmVlKTtcblxuICAgICAgICBjb25zdCBzdGFja1RyYWNlRGF0YTogSVN0YWNrVHJhY2VEYXRhW10gPSB0aGlzLnN0YWNrVHJhY2VBbmFseXplci5hbmFseXplKGFzdFRyZWUuYm9keSk7XG5cbiAgICAgICAgLy8gaW5pdGlhbGl6ZSBjdXN0b20gbm9kZSBncm91cHMgYW5kIGNvbmZpZ3VyZSBjdXN0b20gbm9kZXNcbiAgICAgICAgdGhpcy5jdXN0b21Ob2RlR3JvdXBTdG9yYWdlXG4gICAgICAgICAgICAuZ2V0U3RvcmFnZSgpXG4gICAgICAgICAgICAuZm9yRWFjaCgoY3VzdG9tTm9kZUdyb3VwOiBJQ3VzdG9tTm9kZUdyb3VwKSA9PiB7XG4gICAgICAgICAgICAgICAgY3VzdG9tTm9kZUdyb3VwLmluaXRpYWxpemUoKTtcblxuICAgICAgICAgICAgICAgIHRoaXMub2JmdXNjYXRpb25FdmVudEVtaXR0ZXIub25jZShcbiAgICAgICAgICAgICAgICAgICAgY3VzdG9tTm9kZUdyb3VwLmdldEFwcGVuZEV2ZW50KCksXG4gICAgICAgICAgICAgICAgICAgIGN1c3RvbU5vZGVHcm91cC5hcHBlbmRDdXN0b21Ob2Rlcy5iaW5kKGN1c3RvbU5vZGVHcm91cClcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5vYmZ1c2NhdGlvbkV2ZW50RW1pdHRlci5lbWl0KE9iZnVzY2F0aW9uRXZlbnQuQmVmb3JlT2JmdXNjYXRpb24sIGFzdFRyZWUsIHN0YWNrVHJhY2VEYXRhKTtcblxuICAgICAgICAvLyBmaXJzdCBwYXNzIHRyYW5zZm9ybWVyczogZGVhZCBjb2RlIGluamVjdGlvbiB0cmFuc2Zvcm1lclxuICAgICAgICBhc3RUcmVlID0gdGhpcy50cmFuc2Zvcm1Bc3RUcmVlKGFzdFRyZWUsIFtcbiAgICAgICAgICAgIC4uLnRoaXMub3B0aW9ucy5kZWFkQ29kZUluamVjdGlvbiA/IE9iZnVzY2F0b3IuZGVhZENvZGVJbmplY3Rpb25UcmFuc2Zvcm1lcnNMaXN0IDogW11cbiAgICAgICAgXSk7XG5cbiAgICAgICAgLy8gc2Vjb25kIHBhc3MgdHJhbnNmb3JtZXJzOiBjb250cm9sIGZsb3cgZmxhdHRlbmluZyB0cmFuc2Zvcm1lcnNcbiAgICAgICAgYXN0VHJlZSA9IHRoaXMudHJhbnNmb3JtQXN0VHJlZShhc3RUcmVlLCBbXG4gICAgICAgICAgICAuLi50aGlzLm9wdGlvbnMuY29udHJvbEZsb3dGbGF0dGVuaW5nID8gT2JmdXNjYXRvci5jb250cm9sRmxvd1RyYW5zZm9ybWVyc0xpc3QgOiBbXVxuICAgICAgICBdKTtcblxuICAgICAgICAvLyB0aGlyZCBwYXNzOiBjb252ZXJ0aW5nIGFuZCBvYmZ1c2NhdGluZyB0cmFuc2Zvcm1lcnNcbiAgICAgICAgYXN0VHJlZSA9IHRoaXMudHJhbnNmb3JtQXN0VHJlZShhc3RUcmVlLCBbXG4gICAgICAgICAgICAuLi5PYmZ1c2NhdG9yLmNvbnZlcnRpbmdUcmFuc2Zvcm1lcnNMaXN0LFxuICAgICAgICAgICAgLi4uT2JmdXNjYXRvci5vYmZ1c2NhdGluZ1RyYW5zZm9ybWVyc0xpc3RcbiAgICAgICAgXSk7XG5cbiAgICAgICAgdGhpcy5vYmZ1c2NhdGlvbkV2ZW50RW1pdHRlci5lbWl0KE9iZnVzY2F0aW9uRXZlbnQuQWZ0ZXJPYmZ1c2NhdGlvbiwgYXN0VHJlZSwgc3RhY2tUcmFjZURhdGEpO1xuXG4gICAgICAgIHJldHVybiBhc3RUcmVlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7UHJvZ3JhbX0gYXN0VHJlZVxuICAgICAqIEBwYXJhbSB7Tm9kZVRyYW5zZm9ybWVyW119IG5vZGVUcmFuc2Zvcm1lcnNcbiAgICAgKiBAcmV0dXJucyB7UHJvZ3JhbX1cbiAgICAgKi9cbiAgICBwcml2YXRlIHRyYW5zZm9ybUFzdFRyZWUgKFxuICAgICAgICBhc3RUcmVlOiBFU1RyZWUuUHJvZ3JhbSxcbiAgICAgICAgbm9kZVRyYW5zZm9ybWVyczogTm9kZVRyYW5zZm9ybWVyW11cbiAgICApOiBFU1RyZWUuUHJvZ3JhbSB7XG4gICAgICAgIGlmICghbm9kZVRyYW5zZm9ybWVycy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiBhc3RUcmVlO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZW50ZXJWaXNpdG9yczogSVZpc2l0b3JbXSA9IFtdO1xuICAgICAgICBjb25zdCBsZWF2ZVZpc2l0b3JzOiBJVmlzaXRvcltdID0gW107XG4gICAgICAgIGNvbnN0IG5vZGVUcmFuc2Zvcm1lcnNMZW5ndGg6IG51bWJlciA9IG5vZGVUcmFuc2Zvcm1lcnMubGVuZ3RoO1xuXG4gICAgICAgIGxldCB2aXNpdG9yOiBJVmlzaXRvcjtcblxuICAgICAgICBmb3IgKGxldCBpOiBudW1iZXIgPSAwOyBpIDwgbm9kZVRyYW5zZm9ybWVyc0xlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICB2aXNpdG9yID0gdGhpcy5ub2RlVHJhbnNmb3JtZXJGYWN0b3J5KG5vZGVUcmFuc2Zvcm1lcnNbaV0pLmdldFZpc2l0b3IoKTtcblxuICAgICAgICAgICAgaWYgKHZpc2l0b3IuZW50ZXIpIHtcbiAgICAgICAgICAgICAgICBlbnRlclZpc2l0b3JzLnB1c2godmlzaXRvcik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh2aXNpdG9yLmxlYXZlKSB7XG4gICAgICAgICAgICAgICAgbGVhdmVWaXNpdG9ycy5wdXNoKHZpc2l0b3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgZXN0cmF2ZXJzZS5yZXBsYWNlKGFzdFRyZWUsIHtcbiAgICAgICAgICAgIGVudGVyOiB0aGlzLm1lcmdlVmlzaXRvcnNGb3JEaXJlY3Rpb24oZW50ZXJWaXNpdG9ycywgVmlzaXRvckRpcmVjdGlvbi5FbnRlciksXG4gICAgICAgICAgICBsZWF2ZTogdGhpcy5tZXJnZVZpc2l0b3JzRm9yRGlyZWN0aW9uKGxlYXZlVmlzaXRvcnMsIFZpc2l0b3JEaXJlY3Rpb24uTGVhdmUpXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBhc3RUcmVlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7SVZpc2l0b3JbXX0gdmlzaXRvcnNcbiAgICAgKiBAcGFyYW0ge1RWaXNpdG9yRGlyZWN0aW9ufSBkaXJlY3Rpb25cbiAgICAgKiBAcmV0dXJucyB7VFZpc2l0b3JGdW5jdGlvbn1cbiAgICAgKi9cbiAgICBwcml2YXRlIG1lcmdlVmlzaXRvcnNGb3JEaXJlY3Rpb24gKHZpc2l0b3JzOiBJVmlzaXRvcltdLCBkaXJlY3Rpb246IFRWaXNpdG9yRGlyZWN0aW9uKTogVFZpc2l0b3JGdW5jdGlvbiB7XG4gICAgICAgIGlmICghdmlzaXRvcnMubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm4gKG5vZGU6IEVTVHJlZS5Ob2RlLCBwYXJlbnROb2RlOiBFU1RyZWUuTm9kZSkgPT4gbm9kZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHZpc2l0b3JzTGVuZ3RoOiBudW1iZXIgPSB2aXNpdG9ycy5sZW5ndGg7XG5cbiAgICAgICAgbGV0IHZpc2l0b3I6IElWaXNpdG9yO1xuXG4gICAgICAgIHJldHVybiAobm9kZTogRVNUcmVlLk5vZGUsIHBhcmVudE5vZGU6IEVTVHJlZS5Ob2RlKSA9PiB7XG4gICAgICAgICAgICBmb3IgKGxldCBpOiBudW1iZXIgPSAwOyBpIDwgdmlzaXRvcnNMZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHZpc2l0b3IgPSB2aXNpdG9yc1tpXTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IHZpc2l0b3JGdW5jdGlvbjogVFZpc2l0b3JGdW5jdGlvbiB8IHVuZGVmaW5lZCA9IHZpc2l0b3JbZGlyZWN0aW9uXTtcblxuICAgICAgICAgICAgICAgIGlmICghdmlzaXRvckZ1bmN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGNvbnN0IHZpc2l0b3JSZXN1bHQ6IEVTVHJlZS5Ob2RlIHwgdm9pZCA9IHZpc2l0b3JGdW5jdGlvbihub2RlLCBwYXJlbnROb2RlKTtcblxuICAgICAgICAgICAgICAgIGlmICghdmlzaXRvclJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBub2RlID0gdmlzaXRvclJlc3VsdDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIG5vZGU7XG4gICAgICAgIH07XG4gICAgfVxufVxuIl19