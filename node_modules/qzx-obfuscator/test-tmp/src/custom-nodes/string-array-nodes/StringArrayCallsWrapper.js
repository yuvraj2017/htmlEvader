"use strict";

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var inversify_1 = require("inversify");
var ServiceIdentifiers_1 = require("../../container/ServiceIdentifiers");
var format = require("string-template");
var StringArrayEncoding_1 = require("../../enums/StringArrayEncoding");
var Initializable_1 = require("../../decorators/Initializable");
var NoCustomNodes_1 = require("../../options/presets/NoCustomNodes");
var AtobTemplate_1 = require("../../templates/custom-nodes/AtobTemplate");
var Rc4Template_1 = require("../../templates/custom-nodes/Rc4Template");
var SelfDefendingTemplate_1 = require("../../templates/custom-nodes/string-array-nodes/string-array-calls-wrapper/SelfDefendingTemplate");
var StringArrayBase64DecodeNodeTemplate_1 = require("../../templates/custom-nodes/string-array-nodes/string-array-calls-wrapper/StringArrayBase64DecodeNodeTemplate");
var StringArrayCallsWrapperTemplate_1 = require("../../templates/custom-nodes/string-array-nodes/string-array-calls-wrapper/StringArrayCallsWrapperTemplate");
var StringArrayRC4DecodeNodeTemplate_1 = require("../../templates/custom-nodes/string-array-nodes/string-array-calls-wrapper/StringArrayRC4DecodeNodeTemplate");
var AbstractCustomNode_1 = require("../AbstractCustomNode");
var JavaScriptObfuscator_1 = require("../../JavaScriptObfuscator");
var NodeUtils_1 = require("../../node/NodeUtils");
var StringArrayCallsWrapper = function (_AbstractCustomNode_) {
    _inherits(StringArrayCallsWrapper, _AbstractCustomNode_);

    function StringArrayCallsWrapper(escapeSequenceEncoder, options) {
        _classCallCheck(this, StringArrayCallsWrapper);

        var _this = _possibleConstructorReturn(this, (StringArrayCallsWrapper.__proto__ || Object.getPrototypeOf(StringArrayCallsWrapper)).call(this, options));

        _this.escapeSequenceEncoder = escapeSequenceEncoder;
        return _this;
    }

    _createClass(StringArrayCallsWrapper, [{
        key: "initialize",
        value: function initialize(stringArrayStorage, stringArrayName, stringArrayCallsWrapperName) {
            this.stringArrayStorage = stringArrayStorage;
            this.stringArrayName = stringArrayName;
            this.stringArrayCallsWrapperName = stringArrayCallsWrapperName;
        }
    }, {
        key: "getNodeStructure",
        value: function getNodeStructure() {
            return NodeUtils_1.NodeUtils.convertCodeToStructure(this.getTemplate());
        }
    }, {
        key: "getTemplate",
        value: function getTemplate() {
            var decodeNodeTemplate = this.getDecodeStringArrayTemplate();
            return JavaScriptObfuscator_1.JavaScriptObfuscator.obfuscate(format(StringArrayCallsWrapperTemplate_1.StringArrayCallsWrapperTemplate(), {
                decodeNodeTemplate: decodeNodeTemplate,
                stringArrayCallsWrapperName: this.stringArrayCallsWrapperName,
                stringArrayName: this.stringArrayName
            }), Object.assign({}, NoCustomNodes_1.NO_CUSTOM_NODES_PRESET, { seed: this.options.seed })).getObfuscatedCode();
        }
    }, {
        key: "getDecodeStringArrayTemplate",
        value: function getDecodeStringArrayTemplate() {
            var decodeStringArrayTemplate = '',
                selfDefendingCode = '';
            if (this.options.selfDefending) {
                selfDefendingCode = format(SelfDefendingTemplate_1.SelfDefendingTemplate(this.escapeSequenceEncoder), {
                    stringArrayCallsWrapperName: this.stringArrayCallsWrapperName,
                    stringArrayName: this.stringArrayName
                });
            }
            switch (this.options.stringArrayEncoding) {
                case StringArrayEncoding_1.StringArrayEncoding.Rc4:
                    decodeStringArrayTemplate = format(StringArrayRC4DecodeNodeTemplate_1.StringArrayRc4DecodeNodeTemplate(), {
                        atobPolyfill: AtobTemplate_1.AtobTemplate(),
                        rc4Polyfill: Rc4Template_1.Rc4Template(),
                        selfDefendingCode: selfDefendingCode,
                        stringArrayCallsWrapperName: this.stringArrayCallsWrapperName
                    });
                    break;
                case StringArrayEncoding_1.StringArrayEncoding.Base64:
                    decodeStringArrayTemplate = format(StringArrayBase64DecodeNodeTemplate_1.StringArrayBase64DecodeNodeTemplate(), {
                        atobPolyfill: AtobTemplate_1.AtobTemplate(),
                        selfDefendingCode: selfDefendingCode,
                        stringArrayCallsWrapperName: this.stringArrayCallsWrapperName
                    });
                    break;
            }
            return decodeStringArrayTemplate;
        }
    }]);

    return StringArrayCallsWrapper;
}(AbstractCustomNode_1.AbstractCustomNode);
tslib_1.__decorate([Initializable_1.initializable(), tslib_1.__metadata("design:type", Object)], StringArrayCallsWrapper.prototype, "stringArrayStorage", void 0);
tslib_1.__decorate([Initializable_1.initializable(), tslib_1.__metadata("design:type", String)], StringArrayCallsWrapper.prototype, "stringArrayName", void 0);
tslib_1.__decorate([Initializable_1.initializable(), tslib_1.__metadata("design:type", String)], StringArrayCallsWrapper.prototype, "stringArrayCallsWrapperName", void 0);
StringArrayCallsWrapper = tslib_1.__decorate([inversify_1.injectable(), tslib_1.__param(0, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.IEscapeSequenceEncoder)), tslib_1.__param(1, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.IOptions)), tslib_1.__metadata("design:paramtypes", [Object, Object])], StringArrayCallsWrapper);
exports.StringArrayCallsWrapper = StringArrayCallsWrapper;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3RyaW5nQXJyYXlDYWxsc1dyYXBwZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY3VzdG9tLW5vZGVzL3N0cmluZy1hcnJheS1ub2Rlcy9TdHJpbmdBcnJheUNhbGxzV3JhcHBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQSwwQkFBK0M7QUFDL0MsbUNBQXdFO0FBRXhFLHFCQUEwQztBQVExQyxvQ0FBc0U7QUFFdEUsOEJBQStEO0FBRS9ELDhCQUE2RTtBQUU3RSw2QkFBeUU7QUFDekUsNEJBQXVFO0FBQ3ZFLHNDQUF5STtBQUN6SSxvREFBcUs7QUFDckssZ0RBQTZKO0FBQzdKLGlEQUErSjtBQUUvSixtQ0FBMkQ7QUFDM0QscUNBQWtFO0FBQ2xFLDBCQUFpRDtBQUdqRDtBQUFBLEFBQWEsQUFBdUIsQUFBQzs7QUE0QmpDLHFDQUN1RCxBQUE2Qyx1QkFDM0QsQUFBaUI7QUFFdEQsQUFBSzs7c0pBQUMsQUFBTyxBQUFDLEFBQUM7O0FBRWYsQUFBSSxjQUFDLEFBQXFCLHdCQUFHLEFBQXFCLEFBQUMsQUFDdkQ7O0FBQUMsQUFPTSxBQUFVOzs7O21DQUNiLEFBQXFDLG9CQUNyQyxBQUF1QixpQkFDdkIsQUFBbUM7QUFFbkMsQUFBSSxpQkFBQyxBQUFrQixxQkFBRyxBQUFrQixBQUFDO0FBQzdDLEFBQUksaUJBQUMsQUFBZSxrQkFBRyxBQUFlLEFBQUM7QUFDdkMsQUFBSSxpQkFBQyxBQUEyQiw4QkFBRyxBQUEyQixBQUFDLEFBQ25FO0FBQUMsQUFLUyxBQUFnQjs7OztBQUN0QixBQUFNLG1CQUFDLFlBQVMsVUFBQyxBQUFzQix1QkFBQyxBQUFJLEtBQUMsQUFBVyxBQUFFLEFBQUMsQUFBQyxBQUNoRTtBQUFDLEFBS1MsQUFBVzs7OztBQUNqQixnQkFBTSxBQUFrQixxQkFBVyxBQUFJLEtBQUMsQUFBNEIsQUFBRSxBQUFDO0FBRXZFLEFBQU0sMENBQXFCLHFCQUFDLEFBQVMsaUJBQzFCLGtDQUErQixBQUFFO0FBQ3BDLEFBQWtCO0FBQ2xCLEFBQTJCLDZDQUFFLEFBQUksS0FBQyxBQUEyQjtBQUM3RCxBQUFlLGlDQUFFLEFBQUksS0FBQyxBQUFlLEFBQ3hDLEFBQUM7QUFKd0MsYUFBMUMsQUFBTSxDQURILG9CQU9JLGdCQUFzQiwwQkFDekIsQUFBSSxNQUFFLEFBQUksS0FBQyxBQUFPLFFBQUMsQUFBSSxBQUU5QixTQUFDLEFBQWlCLEFBQUUsQUFBQyxBQUMxQjtBQUFDLEFBS08sQUFBNEI7Ozs7QUFDaEMsZ0JBQUksQUFBeUIsNEJBQVcsQUFBRTtnQkFDdEMsQUFBaUIsb0JBQVcsQUFBRSxBQUFDO0FBRW5DLEFBQUUsQUFBQyxnQkFBQyxBQUFJLEtBQUMsQUFBTyxRQUFDLEFBQWEsQUFBQyxlQUFDLEFBQUM7QUFDN0IsQUFBaUIsMkNBQVUsd0JBQXFCLHNCQUFDLEFBQUksS0FBQyxBQUFxQixBQUFDO0FBQ3hFLEFBQTJCLGlEQUFFLEFBQUksS0FBQyxBQUEyQjtBQUM3RCxBQUFlLHFDQUFFLEFBQUksS0FBQyxBQUFlLEFBQ3hDLEFBQUMsQUFBQyxBQUNQO0FBSmtGLGlCQUExRCxBQUFNO0FBSTdCO0FBRUQsQUFBTSxBQUFDLG9CQUFDLEFBQUksS0FBQyxBQUFPLFFBQUMsQUFBbUIsQUFBQyxBQUFDLEFBQUM7QUFDdkMscUJBQUssc0JBQW1CLG9CQUFDLEFBQUc7QUFDeEIsQUFBeUIsdURBQVUsbUNBQWdDLEFBQUU7QUFDakUsQUFBWSxzQ0FBRSxlQUFZLEFBQUU7QUFDNUIsQUFBVyxxQ0FBRSxjQUFXLEFBQUU7QUFDMUIsQUFBaUI7QUFDakIsQUFBMkIscURBQUUsQUFBSSxLQUFDLEFBQTJCLEFBQ2hFLEFBQUMsQUFBQztBQUxvRSxxQkFBM0MsQUFBTTtBQU9sQyxBQUFLLEFBQUM7QUFFVixxQkFBSyxzQkFBbUIsb0JBQUMsQUFBTTtBQUMzQixBQUF5Qix1REFBVSxzQ0FBbUMsQUFBRTtBQUNwRSxBQUFZLHNDQUFFLGVBQVksQUFBRTtBQUM1QixBQUFpQjtBQUNqQixBQUEyQixxREFBRSxBQUFJLEtBQUMsQUFBMkIsQUFDaEUsQUFBQyxBQUFDO0FBSnVFLHFCQUE5QyxBQUFNO0FBTWxDLEFBQUssQUFBQyxBQUNkLEFBQUM7O0FBRUQsQUFBTSxtQkFBQyxBQUF5QixBQUFDLEFBQ3JDO0FBQUMsQUFDSjs7OztFQW5INEMscUJBQWtCO0FBVTNELG9CQURDLGdCQUFhLEFBQUUsMkhBQzhCO0FBTTlDLG9CQURDLGdCQUFhLEFBQUUsd0hBQ2dCO0FBTWhDLG9CQURDLGdCQUFhLEFBQUUsb0lBQzRCO0FBdEJuQyxBQUF1Qiw4Q0FEbkMsWUFBVSxBQUFFLGNBOEJKLG1CQUFBLFlBQU0sT0FBQyxxQkFBa0IsbUJBQUMsQUFBc0IsQUFBQywwQkFDakQsbUJBQUEsWUFBTSxPQUFDLHFCQUFrQixtQkFBQyxBQUFRLEFBQUMsd0VBOUIvQixBQUF1QixBQW1IbkM7QUFuSFksa0NBQXVCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaW5qZWN0YWJsZSwgaW5qZWN0IH0gZnJvbSAnaW52ZXJzaWZ5JztcbmltcG9ydCB7IFNlcnZpY2VJZGVudGlmaWVycyB9IGZyb20gJy4uLy4uL2NvbnRhaW5lci9TZXJ2aWNlSWRlbnRpZmllcnMnO1xuXG5pbXBvcnQgKiBhcyBmb3JtYXQgZnJvbSAnc3RyaW5nLXRlbXBsYXRlJztcblxuaW1wb3J0IHsgVFN0YXRlbWVudCB9IGZyb20gJy4uLy4uL3R5cGVzL25vZGUvVFN0YXRlbWVudCc7XG5cbmltcG9ydCB7IElFc2NhcGVTZXF1ZW5jZUVuY29kZXIgfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL3V0aWxzL0lFc2NhcGVTZXF1ZW5jZUVuY29kZXInO1xuaW1wb3J0IHsgSU9wdGlvbnMgfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL29wdGlvbnMvSU9wdGlvbnMnO1xuaW1wb3J0IHsgSVN0b3JhZ2UgfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL3N0b3JhZ2VzL0lTdG9yYWdlJztcblxuaW1wb3J0IHsgU3RyaW5nQXJyYXlFbmNvZGluZyB9IGZyb20gJy4uLy4uL2VudW1zL1N0cmluZ0FycmF5RW5jb2RpbmcnO1xuXG5pbXBvcnQgeyBpbml0aWFsaXphYmxlIH0gZnJvbSAnLi4vLi4vZGVjb3JhdG9ycy9Jbml0aWFsaXphYmxlJztcblxuaW1wb3J0IHsgTk9fQ1VTVE9NX05PREVTX1BSRVNFVCB9IGZyb20gJy4uLy4uL29wdGlvbnMvcHJlc2V0cy9Ob0N1c3RvbU5vZGVzJztcblxuaW1wb3J0IHsgQXRvYlRlbXBsYXRlIH0gZnJvbSAnLi4vLi4vdGVtcGxhdGVzL2N1c3RvbS1ub2Rlcy9BdG9iVGVtcGxhdGUnO1xuaW1wb3J0IHsgUmM0VGVtcGxhdGUgfSBmcm9tICcuLi8uLi90ZW1wbGF0ZXMvY3VzdG9tLW5vZGVzL1JjNFRlbXBsYXRlJztcbmltcG9ydCB7IFNlbGZEZWZlbmRpbmdUZW1wbGF0ZSB9IGZyb20gJy4uLy4uL3RlbXBsYXRlcy9jdXN0b20tbm9kZXMvc3RyaW5nLWFycmF5LW5vZGVzL3N0cmluZy1hcnJheS1jYWxscy13cmFwcGVyL1NlbGZEZWZlbmRpbmdUZW1wbGF0ZSc7XG5pbXBvcnQgeyBTdHJpbmdBcnJheUJhc2U2NERlY29kZU5vZGVUZW1wbGF0ZSB9IGZyb20gJy4uLy4uL3RlbXBsYXRlcy9jdXN0b20tbm9kZXMvc3RyaW5nLWFycmF5LW5vZGVzL3N0cmluZy1hcnJheS1jYWxscy13cmFwcGVyL1N0cmluZ0FycmF5QmFzZTY0RGVjb2RlTm9kZVRlbXBsYXRlJztcbmltcG9ydCB7IFN0cmluZ0FycmF5Q2FsbHNXcmFwcGVyVGVtcGxhdGUgfSBmcm9tICcuLi8uLi90ZW1wbGF0ZXMvY3VzdG9tLW5vZGVzL3N0cmluZy1hcnJheS1ub2Rlcy9zdHJpbmctYXJyYXktY2FsbHMtd3JhcHBlci9TdHJpbmdBcnJheUNhbGxzV3JhcHBlclRlbXBsYXRlJztcbmltcG9ydCB7IFN0cmluZ0FycmF5UmM0RGVjb2RlTm9kZVRlbXBsYXRlIH0gZnJvbSAnLi4vLi4vdGVtcGxhdGVzL2N1c3RvbS1ub2Rlcy9zdHJpbmctYXJyYXktbm9kZXMvc3RyaW5nLWFycmF5LWNhbGxzLXdyYXBwZXIvU3RyaW5nQXJyYXlSQzREZWNvZGVOb2RlVGVtcGxhdGUnO1xuXG5pbXBvcnQgeyBBYnN0cmFjdEN1c3RvbU5vZGUgfSBmcm9tICcuLi9BYnN0cmFjdEN1c3RvbU5vZGUnO1xuaW1wb3J0IHsgSmF2YVNjcmlwdE9iZnVzY2F0b3IgfSBmcm9tICcuLi8uLi9KYXZhU2NyaXB0T2JmdXNjYXRvcic7XG5pbXBvcnQgeyBOb2RlVXRpbHMgfSBmcm9tICcuLi8uLi9ub2RlL05vZGVVdGlscyc7XG5cbkBpbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTdHJpbmdBcnJheUNhbGxzV3JhcHBlciBleHRlbmRzIEFic3RyYWN0Q3VzdG9tTm9kZSB7XG4gICAgLyoqXG4gICAgICogQHR5cGUge0lFc2NhcGVTZXF1ZW5jZUVuY29kZXJ9XG4gICAgICovXG4gICAgcHJpdmF0ZSByZWFkb25seSBlc2NhcGVTZXF1ZW5jZUVuY29kZXI6IElFc2NhcGVTZXF1ZW5jZUVuY29kZXI7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7SVN0b3JhZ2UgPHN0cmluZz59XG4gICAgICovXG4gICAgQGluaXRpYWxpemFibGUoKVxuICAgIHByaXZhdGUgc3RyaW5nQXJyYXlTdG9yYWdlOiBJU3RvcmFnZSA8c3RyaW5nPjtcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtzdHJpbmd9XG4gICAgICovXG4gICAgQGluaXRpYWxpemFibGUoKVxuICAgIHByaXZhdGUgc3RyaW5nQXJyYXlOYW1lOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7c3RyaW5nfVxuICAgICAqL1xuICAgIEBpbml0aWFsaXphYmxlKClcbiAgICBwcml2YXRlIHN0cmluZ0FycmF5Q2FsbHNXcmFwcGVyTmFtZTogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtJRXNjYXBlU2VxdWVuY2VFbmNvZGVyfSBlc2NhcGVTZXF1ZW5jZUVuY29kZXJcbiAgICAgKiBAcGFyYW0ge0lPcHRpb25zfSBvcHRpb25zXG4gICAgICovXG4gICAgY29uc3RydWN0b3IgKFxuICAgICAgICBAaW5qZWN0KFNlcnZpY2VJZGVudGlmaWVycy5JRXNjYXBlU2VxdWVuY2VFbmNvZGVyKSBlc2NhcGVTZXF1ZW5jZUVuY29kZXI6IElFc2NhcGVTZXF1ZW5jZUVuY29kZXIsXG4gICAgICAgIEBpbmplY3QoU2VydmljZUlkZW50aWZpZXJzLklPcHRpb25zKSBvcHRpb25zOiBJT3B0aW9uc1xuICAgICkge1xuICAgICAgICBzdXBlcihvcHRpb25zKTtcblxuICAgICAgICB0aGlzLmVzY2FwZVNlcXVlbmNlRW5jb2RlciA9IGVzY2FwZVNlcXVlbmNlRW5jb2RlcjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge0lTdG9yYWdlPHN0cmluZz59IHN0cmluZ0FycmF5U3RvcmFnZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdHJpbmdBcnJheU5hbWVcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nQXJyYXlDYWxsc1dyYXBwZXJOYW1lXG4gICAgICovXG4gICAgcHVibGljIGluaXRpYWxpemUgKFxuICAgICAgICBzdHJpbmdBcnJheVN0b3JhZ2U6IElTdG9yYWdlIDxzdHJpbmc+LFxuICAgICAgICBzdHJpbmdBcnJheU5hbWU6IHN0cmluZyxcbiAgICAgICAgc3RyaW5nQXJyYXlDYWxsc1dyYXBwZXJOYW1lOiBzdHJpbmdcbiAgICApOiB2b2lkIHtcbiAgICAgICAgdGhpcy5zdHJpbmdBcnJheVN0b3JhZ2UgPSBzdHJpbmdBcnJheVN0b3JhZ2U7XG4gICAgICAgIHRoaXMuc3RyaW5nQXJyYXlOYW1lID0gc3RyaW5nQXJyYXlOYW1lO1xuICAgICAgICB0aGlzLnN0cmluZ0FycmF5Q2FsbHNXcmFwcGVyTmFtZSA9IHN0cmluZ0FycmF5Q2FsbHNXcmFwcGVyTmFtZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcmV0dXJucyB7VFN0YXRlbWVudFtdfVxuICAgICAqL1xuICAgIHByb3RlY3RlZCBnZXROb2RlU3RydWN0dXJlICgpOiBUU3RhdGVtZW50W10ge1xuICAgICAgICByZXR1cm4gTm9kZVV0aWxzLmNvbnZlcnRDb2RlVG9TdHJ1Y3R1cmUodGhpcy5nZXRUZW1wbGF0ZSgpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfVxuICAgICAqL1xuICAgIHByb3RlY3RlZCBnZXRUZW1wbGF0ZSAoKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgZGVjb2RlTm9kZVRlbXBsYXRlOiBzdHJpbmcgPSB0aGlzLmdldERlY29kZVN0cmluZ0FycmF5VGVtcGxhdGUoKTtcblxuICAgICAgICByZXR1cm4gSmF2YVNjcmlwdE9iZnVzY2F0b3Iub2JmdXNjYXRlKFxuICAgICAgICAgICAgZm9ybWF0KFN0cmluZ0FycmF5Q2FsbHNXcmFwcGVyVGVtcGxhdGUoKSwge1xuICAgICAgICAgICAgICAgIGRlY29kZU5vZGVUZW1wbGF0ZSxcbiAgICAgICAgICAgICAgICBzdHJpbmdBcnJheUNhbGxzV3JhcHBlck5hbWU6IHRoaXMuc3RyaW5nQXJyYXlDYWxsc1dyYXBwZXJOYW1lLFxuICAgICAgICAgICAgICAgIHN0cmluZ0FycmF5TmFtZTogdGhpcy5zdHJpbmdBcnJheU5hbWVcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIC4uLk5PX0NVU1RPTV9OT0RFU19QUkVTRVQsXG4gICAgICAgICAgICAgICAgc2VlZDogdGhpcy5vcHRpb25zLnNlZWRcbiAgICAgICAgICAgIH1cbiAgICAgICAgKS5nZXRPYmZ1c2NhdGVkQ29kZSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9XG4gICAgICovXG4gICAgcHJpdmF0ZSBnZXREZWNvZGVTdHJpbmdBcnJheVRlbXBsYXRlICgpOiBzdHJpbmcge1xuICAgICAgICBsZXQgZGVjb2RlU3RyaW5nQXJyYXlUZW1wbGF0ZTogc3RyaW5nID0gJycsXG4gICAgICAgICAgICBzZWxmRGVmZW5kaW5nQ29kZTogc3RyaW5nID0gJyc7XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5zZWxmRGVmZW5kaW5nKSB7XG4gICAgICAgICAgICBzZWxmRGVmZW5kaW5nQ29kZSA9IGZvcm1hdChTZWxmRGVmZW5kaW5nVGVtcGxhdGUodGhpcy5lc2NhcGVTZXF1ZW5jZUVuY29kZXIpLCB7XG4gICAgICAgICAgICAgICAgc3RyaW5nQXJyYXlDYWxsc1dyYXBwZXJOYW1lOiB0aGlzLnN0cmluZ0FycmF5Q2FsbHNXcmFwcGVyTmFtZSxcbiAgICAgICAgICAgICAgICBzdHJpbmdBcnJheU5hbWU6IHRoaXMuc3RyaW5nQXJyYXlOYW1lXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHN3aXRjaCAodGhpcy5vcHRpb25zLnN0cmluZ0FycmF5RW5jb2RpbmcpIHtcbiAgICAgICAgICAgIGNhc2UgU3RyaW5nQXJyYXlFbmNvZGluZy5SYzQ6XG4gICAgICAgICAgICAgICAgZGVjb2RlU3RyaW5nQXJyYXlUZW1wbGF0ZSA9IGZvcm1hdChTdHJpbmdBcnJheVJjNERlY29kZU5vZGVUZW1wbGF0ZSgpLCB7XG4gICAgICAgICAgICAgICAgICAgIGF0b2JQb2x5ZmlsbDogQXRvYlRlbXBsYXRlKCksXG4gICAgICAgICAgICAgICAgICAgIHJjNFBvbHlmaWxsOiBSYzRUZW1wbGF0ZSgpLFxuICAgICAgICAgICAgICAgICAgICBzZWxmRGVmZW5kaW5nQ29kZSxcbiAgICAgICAgICAgICAgICAgICAgc3RyaW5nQXJyYXlDYWxsc1dyYXBwZXJOYW1lOiB0aGlzLnN0cmluZ0FycmF5Q2FsbHNXcmFwcGVyTmFtZVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgU3RyaW5nQXJyYXlFbmNvZGluZy5CYXNlNjQ6XG4gICAgICAgICAgICAgICAgZGVjb2RlU3RyaW5nQXJyYXlUZW1wbGF0ZSA9IGZvcm1hdChTdHJpbmdBcnJheUJhc2U2NERlY29kZU5vZGVUZW1wbGF0ZSgpLCB7XG4gICAgICAgICAgICAgICAgICAgIGF0b2JQb2x5ZmlsbDogQXRvYlRlbXBsYXRlKCksXG4gICAgICAgICAgICAgICAgICAgIHNlbGZEZWZlbmRpbmdDb2RlLFxuICAgICAgICAgICAgICAgICAgICBzdHJpbmdBcnJheUNhbGxzV3JhcHBlck5hbWU6IHRoaXMuc3RyaW5nQXJyYXlDYWxsc1dyYXBwZXJOYW1lXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBkZWNvZGVTdHJpbmdBcnJheVRlbXBsYXRlO1xuICAgIH1cbn1cbiJdfQ==