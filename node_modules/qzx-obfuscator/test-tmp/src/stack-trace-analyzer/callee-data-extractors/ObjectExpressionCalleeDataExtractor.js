"use strict";

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var inversify_1 = require("inversify");
var estraverse = require("estraverse");
var Node_1 = require("../../node/Node");
var NodeUtils_1 = require("../../node/NodeUtils");
var AbstractCalleeDataExtractor_1 = require("./AbstractCalleeDataExtractor");
var ObjectExpressionCalleeDataExtractor = function (_AbstractCalleeDataEx) {
    _inherits(ObjectExpressionCalleeDataExtractor, _AbstractCalleeDataEx);

    function ObjectExpressionCalleeDataExtractor() {
        _classCallCheck(this, ObjectExpressionCalleeDataExtractor);

        return _possibleConstructorReturn(this, (ObjectExpressionCalleeDataExtractor.__proto__ || Object.getPrototypeOf(ObjectExpressionCalleeDataExtractor)).apply(this, arguments));
    }

    _createClass(ObjectExpressionCalleeDataExtractor, [{
        key: "extract",
        value: function extract(blockScopeBody, callee) {
            if (!Node_1.Node.isMemberExpressionNode(callee)) {
                return null;
            }
            var objectMembersCallsChain = this.createObjectMembersCallsChain([], callee);
            if (!objectMembersCallsChain.length) {
                return null;
            }
            var functionExpressionName = objectMembersCallsChain[objectMembersCallsChain.length - 1];
            var calleeBlockStatement = this.getCalleeBlockStatement(NodeUtils_1.NodeUtils.getBlockScopesOfNode(blockScopeBody[0])[0], objectMembersCallsChain);
            if (!calleeBlockStatement) {
                return null;
            }
            return {
                callee: calleeBlockStatement,
                name: functionExpressionName
            };
        }
    }, {
        key: "createObjectMembersCallsChain",
        value: function createObjectMembersCallsChain(currentChain, memberExpression) {
            if (Node_1.Node.isIdentifierNode(memberExpression.property) && memberExpression.computed === false) {
                currentChain.unshift(memberExpression.property.name);
            } else if (Node_1.Node.isLiteralNode(memberExpression.property) && (typeof memberExpression.property.value === 'string' || typeof memberExpression.property.value === 'number')) {
                currentChain.unshift(memberExpression.property.value);
            } else {
                return currentChain;
            }
            if (Node_1.Node.isMemberExpressionNode(memberExpression.object)) {
                return this.createObjectMembersCallsChain(currentChain, memberExpression.object);
            } else if (Node_1.Node.isIdentifierNode(memberExpression.object)) {
                currentChain.unshift(memberExpression.object.name);
            }
            return currentChain;
        }
    }, {
        key: "getCalleeBlockStatement",
        value: function getCalleeBlockStatement(targetNode, objectMembersCallsChain) {
            var _this2 = this;

            var objectName = objectMembersCallsChain.shift();
            if (!objectName) {
                return null;
            }
            var calleeBlockStatement = null;
            estraverse.traverse(targetNode, {
                enter: function enter(node, parentNode) {
                    if (Node_1.Node.isVariableDeclaratorNode(node) && Node_1.Node.isIdentifierNode(node.id) && node.init && Node_1.Node.isObjectExpressionNode(node.init) && node.id.name === objectName) {
                        calleeBlockStatement = _this2.findCalleeBlockStatement(node.init.properties, objectMembersCallsChain);
                        return estraverse.VisitorOption.Break;
                    }
                }
            });
            return calleeBlockStatement;
        }
    }, {
        key: "findCalleeBlockStatement",
        value: function findCalleeBlockStatement(objectExpressionProperties, objectMembersCallsChain) {
            var nextItemInCallsChain = objectMembersCallsChain.shift();
            if (!nextItemInCallsChain) {
                return null;
            }
            var _iteratorNormalCompletion = true;
            var _didIteratorError = false;
            var _iteratorError = undefined;

            try {
                for (var _iterator = objectExpressionProperties[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                    var propertyNode = _step.value;

                    var isTargetPropertyNodeWithIdentifierKey = Node_1.Node.isIdentifierNode(propertyNode.key) && propertyNode.key.name === nextItemInCallsChain;
                    var isTargetPropertyNodeWithLiteralKey = Node_1.Node.isLiteralNode(propertyNode.key) && Boolean(propertyNode.key.value) && propertyNode.key.value === nextItemInCallsChain;
                    if (!isTargetPropertyNodeWithIdentifierKey && !isTargetPropertyNodeWithLiteralKey) {
                        continue;
                    }
                    if (Node_1.Node.isObjectExpressionNode(propertyNode.value)) {
                        return this.findCalleeBlockStatement(propertyNode.value.properties, objectMembersCallsChain);
                    }
                    if (Node_1.Node.isFunctionExpressionNode(propertyNode.value)) {
                        return propertyNode.value.body;
                    }
                }
            } catch (err) {
                _didIteratorError = true;
                _iteratorError = err;
            } finally {
                try {
                    if (!_iteratorNormalCompletion && _iterator.return) {
                        _iterator.return();
                    }
                } finally {
                    if (_didIteratorError) {
                        throw _iteratorError;
                    }
                }
            }

            return null;
        }
    }]);

    return ObjectExpressionCalleeDataExtractor;
}(AbstractCalleeDataExtractor_1.AbstractCalleeDataExtractor);
ObjectExpressionCalleeDataExtractor = tslib_1.__decorate([inversify_1.injectable()], ObjectExpressionCalleeDataExtractor);
exports.ObjectExpressionCalleeDataExtractor = ObjectExpressionCalleeDataExtractor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT2JqZWN0RXhwcmVzc2lvbkNhbGxlZURhdGFFeHRyYWN0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvc3RhY2stdHJhY2UtYW5hbHl6ZXIvY2FsbGVlLWRhdGEtZXh0cmFjdG9ycy9PYmplY3RFeHByZXNzaW9uQ2FsbGVlRGF0YUV4dHJhY3Rvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQSwwQkFBdUM7QUFFdkMseUJBQXlDO0FBT3pDLHFCQUF1QztBQUN2QywwQkFBaUQ7QUFDakQsNENBQTRFO0FBRzVFO0FBQUEsQUFBYSxBQUFtQyxBQUFDOzs7Ozs7Ozs7O2dDQU03QixBQUE2QixnQkFBRSxBQUErQjtBQUMxRSxBQUFFLEFBQUMsZ0JBQUMsQ0FBQyxPQUFJLEtBQUMsQUFBc0IsdUJBQUMsQUFBTSxBQUFDLEFBQUMsU0FBQyxBQUFDO0FBQ3ZDLEFBQU0sdUJBQUMsQUFBSSxBQUFDLEFBQ2hCO0FBQUM7QUFFRCxnQkFBTSxBQUF1QiwwQkFBNkIsQUFBSSxLQUFDLEFBQTZCLDhCQUFDLEFBQUUsSUFBRSxBQUFNLEFBQUMsQUFBQztBQUV6RyxBQUFFLEFBQUMsZ0JBQUMsQ0FBQyxBQUF1Qix3QkFBQyxBQUFNLEFBQUMsUUFBQyxBQUFDO0FBQ2xDLEFBQU0sdUJBQUMsQUFBSSxBQUFDLEFBQ2hCO0FBQUM7QUFFRCxnQkFBTSxBQUFzQix5QkFBdUIsQUFBdUIsd0JBQUMsQUFBdUIsd0JBQUMsQUFBTSxTQUFHLEFBQUMsQUFBQyxBQUFDO0FBQy9HLGdCQUFNLEFBQW9CLHVCQUErQixBQUFJLEtBQUMsQUFBdUIsd0JBQ2pGLFlBQVMsVUFBQyxBQUFvQixxQkFBQyxBQUFjLGVBQUMsQUFBQyxBQUFDLEFBQUMsSUFBQyxBQUFDLEFBQUMsSUFDcEQsQUFBdUIsQUFDMUIsQUFBQztBQUVGLEFBQUUsQUFBQyxnQkFBQyxDQUFDLEFBQW9CLEFBQUMsc0JBQUMsQUFBQztBQUN4QixBQUFNLHVCQUFD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QyxBQUFJLEFBQUMsQUFDaEI7QUFBQyxBQUNKOzs7O0VBakp3RCw4QkFBMkIsQUFNekUsQUFBTztBQU5MLEFBQW1DLDBEQUQvQyxZQUFVLEFBQUUsZUFDQSxBQUFtQyxBQWlKL0M7QUFqSlksOENBQW1DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaW5qZWN0YWJsZSB9IGZyb20gJ2ludmVyc2lmeSc7XG5cbmltcG9ydCAqIGFzIGVzdHJhdmVyc2UgZnJvbSAnZXN0cmF2ZXJzZSc7XG5pbXBvcnQgKiBhcyBFU1RyZWUgZnJvbSAnZXN0cmVlJztcblxuaW1wb3J0IHsgVE9iamVjdE1lbWJlcnNDYWxsc0NoYWluIH0gZnJvbSAnLi4vLi4vdHlwZXMvc3RhY2stdHJhY2UtYW5hbHl6ZXIvVE9iamVjdE1lbWJlcnNDYWxsc0NoYWluJztcblxuaW1wb3J0IHsgSUNhbGxlZURhdGEgfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL3N0YWNrLXRyYWNlLWFuYWx5emVyL0lDYWxsZWVEYXRhJztcblxuaW1wb3J0IHsgTm9kZSB9IGZyb20gJy4uLy4uL25vZGUvTm9kZSc7XG5pbXBvcnQgeyBOb2RlVXRpbHMgfSBmcm9tICcuLi8uLi9ub2RlL05vZGVVdGlscyc7XG5pbXBvcnQgeyBBYnN0cmFjdENhbGxlZURhdGFFeHRyYWN0b3IgfSBmcm9tICcuL0Fic3RyYWN0Q2FsbGVlRGF0YUV4dHJhY3Rvcic7XG5cbkBpbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBPYmplY3RFeHByZXNzaW9uQ2FsbGVlRGF0YUV4dHJhY3RvciBleHRlbmRzIEFic3RyYWN0Q2FsbGVlRGF0YUV4dHJhY3RvciB7XG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtOb2RlW119IGJsb2NrU2NvcGVCb2R5XG4gICAgICogQHBhcmFtIHtNZW1iZXJFeHByZXNzaW9ufSBjYWxsZWVcbiAgICAgKiBAcmV0dXJucyB7SUNhbGxlZURhdGF9XG4gICAgICovXG4gICAgcHVibGljIGV4dHJhY3QgKGJsb2NrU2NvcGVCb2R5OiBFU1RyZWUuTm9kZVtdLCBjYWxsZWU6IEVTVHJlZS5NZW1iZXJFeHByZXNzaW9uKTogSUNhbGxlZURhdGF8bnVsbCB7XG4gICAgICAgIGlmICghTm9kZS5pc01lbWJlckV4cHJlc3Npb25Ob2RlKGNhbGxlZSkpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgb2JqZWN0TWVtYmVyc0NhbGxzQ2hhaW46IFRPYmplY3RNZW1iZXJzQ2FsbHNDaGFpbiA9IHRoaXMuY3JlYXRlT2JqZWN0TWVtYmVyc0NhbGxzQ2hhaW4oW10sIGNhbGxlZSk7XG5cbiAgICAgICAgaWYgKCFvYmplY3RNZW1iZXJzQ2FsbHNDaGFpbi5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZnVuY3Rpb25FeHByZXNzaW9uTmFtZTogc3RyaW5nfG51bWJlcnxudWxsID0gb2JqZWN0TWVtYmVyc0NhbGxzQ2hhaW5bb2JqZWN0TWVtYmVyc0NhbGxzQ2hhaW4ubGVuZ3RoIC0gMV07XG4gICAgICAgIGNvbnN0IGNhbGxlZUJsb2NrU3RhdGVtZW50OiBFU1RyZWUuQmxvY2tTdGF0ZW1lbnR8bnVsbCA9IHRoaXMuZ2V0Q2FsbGVlQmxvY2tTdGF0ZW1lbnQoXG4gICAgICAgICAgICBOb2RlVXRpbHMuZ2V0QmxvY2tTY29wZXNPZk5vZGUoYmxvY2tTY29wZUJvZHlbMF0pWzBdLFxuICAgICAgICAgICAgb2JqZWN0TWVtYmVyc0NhbGxzQ2hhaW5cbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoIWNhbGxlZUJsb2NrU3RhdGVtZW50KSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjYWxsZWU6IGNhbGxlZUJsb2NrU3RhdGVtZW50LFxuICAgICAgICAgICAgbmFtZTogZnVuY3Rpb25FeHByZXNzaW9uTmFtZVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYXJyYXkgd2l0aCBNZW1iZXJFeHByZXNzaW9uIGNhbGxzIGNoYWluLlxuICAgICAqXG4gICAgICogRXhhbXBsZTogb2JqZWN0LmZvby5iYXIoKTsgLy8gWydvYmplY3QnLCAnZm9vJywgJ2JhciddXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge1RPYmplY3RNZW1iZXJzQ2FsbHNDaGFpbn0gY3VycmVudENoYWluXG4gICAgICogQHBhcmFtIHtNZW1iZXJFeHByZXNzaW9ufSBtZW1iZXJFeHByZXNzaW9uXG4gICAgICogQHJldHVybnMge1RPYmplY3RNZW1iZXJzQ2FsbHNDaGFpbn1cbiAgICAgKi9cbiAgICBwcml2YXRlIGNyZWF0ZU9iamVjdE1lbWJlcnNDYWxsc0NoYWluIChcbiAgICAgICAgY3VycmVudENoYWluOiBUT2JqZWN0TWVtYmVyc0NhbGxzQ2hhaW4sXG4gICAgICAgIG1lbWJlckV4cHJlc3Npb246IEVTVHJlZS5NZW1iZXJFeHByZXNzaW9uXG4gICAgKTogVE9iamVjdE1lbWJlcnNDYWxsc0NoYWluIHtcbiAgICAgICAgLy8gZmlyc3Qgc3RlcDogcHJvY2Vzc2luZyBtZW1iZXJFeHByZXNzaW9uIGBwcm9wZXJ0eWAgcHJvcGVydHlcbiAgICAgICAgaWYgKE5vZGUuaXNJZGVudGlmaWVyTm9kZShtZW1iZXJFeHByZXNzaW9uLnByb3BlcnR5KSAmJiBtZW1iZXJFeHByZXNzaW9uLmNvbXB1dGVkID09PSBmYWxzZSkge1xuICAgICAgICAgICAgY3VycmVudENoYWluLnVuc2hpZnQobWVtYmVyRXhwcmVzc2lvbi5wcm9wZXJ0eS5uYW1lKTtcbiAgICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgICAgIE5vZGUuaXNMaXRlcmFsTm9kZShtZW1iZXJFeHByZXNzaW9uLnByb3BlcnR5KSAmJlxuICAgICAgICAgICAgKFxuICAgICAgICAgICAgICAgIHR5cGVvZiBtZW1iZXJFeHByZXNzaW9uLnByb3BlcnR5LnZhbHVlID09PSAnc3RyaW5nJyB8fFxuICAgICAgICAgICAgICAgIHR5cGVvZiBtZW1iZXJFeHByZXNzaW9uLnByb3BlcnR5LnZhbHVlID09PSAnbnVtYmVyJ1xuICAgICAgICAgICAgKVxuICAgICAgICApIHtcbiAgICAgICAgICAgIGN1cnJlbnRDaGFpbi51bnNoaWZ0KG1lbWJlckV4cHJlc3Npb24ucHJvcGVydHkudmFsdWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRDaGFpbjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHNlY29uZCBzdGVwOiBwcm9jZXNzaW5nIG1lbWJlckV4cHJlc3Npb24gYG9iamVjdGAgcHJvcGVydHlcbiAgICAgICAgaWYgKE5vZGUuaXNNZW1iZXJFeHByZXNzaW9uTm9kZShtZW1iZXJFeHByZXNzaW9uLm9iamVjdCkpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZU9iamVjdE1lbWJlcnNDYWxsc0NoYWluKGN1cnJlbnRDaGFpbiwgbWVtYmVyRXhwcmVzc2lvbi5vYmplY3QpO1xuICAgICAgICB9IGVsc2UgaWYgKE5vZGUuaXNJZGVudGlmaWVyTm9kZShtZW1iZXJFeHByZXNzaW9uLm9iamVjdCkpIHtcbiAgICAgICAgICAgIGN1cnJlbnRDaGFpbi51bnNoaWZ0KG1lbWJlckV4cHJlc3Npb24ub2JqZWN0Lm5hbWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGN1cnJlbnRDaGFpbjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge05vZGV9IHRhcmdldE5vZGVcbiAgICAgKiBAcGFyYW0ge1RPYmplY3RNZW1iZXJzQ2FsbHNDaGFpbn0gb2JqZWN0TWVtYmVyc0NhbGxzQ2hhaW5cbiAgICAgKiBAcmV0dXJucyB7QmxvY2tTdGF0ZW1lbnR9XG4gICAgICovXG4gICAgcHJpdmF0ZSBnZXRDYWxsZWVCbG9ja1N0YXRlbWVudCAoXG4gICAgICAgIHRhcmdldE5vZGU6IEVTVHJlZS5Ob2RlLFxuICAgICAgICBvYmplY3RNZW1iZXJzQ2FsbHNDaGFpbjogVE9iamVjdE1lbWJlcnNDYWxsc0NoYWluXG4gICAgKTogRVNUcmVlLkJsb2NrU3RhdGVtZW50fG51bGwge1xuICAgICAgICBjb25zdCBvYmplY3ROYW1lOiBzdHJpbmd8bnVtYmVyfHVuZGVmaW5lZCA9IG9iamVjdE1lbWJlcnNDYWxsc0NoYWluLnNoaWZ0KCk7XG5cbiAgICAgICAgaWYgKCFvYmplY3ROYW1lKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjYWxsZWVCbG9ja1N0YXRlbWVudDogRVNUcmVlLkJsb2NrU3RhdGVtZW50fG51bGwgPSBudWxsO1xuXG4gICAgICAgIGVzdHJhdmVyc2UudHJhdmVyc2UodGFyZ2V0Tm9kZSwge1xuICAgICAgICAgICAgZW50ZXI6IChub2RlOiBFU1RyZWUuTm9kZSwgcGFyZW50Tm9kZTogRVNUcmVlLk5vZGUpOiBhbnkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgTm9kZS5pc1ZhcmlhYmxlRGVjbGFyYXRvck5vZGUobm9kZSkgJiZcbiAgICAgICAgICAgICAgICAgICAgTm9kZS5pc0lkZW50aWZpZXJOb2RlKG5vZGUuaWQpICYmXG4gICAgICAgICAgICAgICAgICAgIG5vZGUuaW5pdCAmJlxuICAgICAgICAgICAgICAgICAgICBOb2RlLmlzT2JqZWN0RXhwcmVzc2lvbk5vZGUobm9kZS5pbml0KSAmJlxuICAgICAgICAgICAgICAgICAgICBub2RlLmlkLm5hbWUgPT09IG9iamVjdE5hbWVcbiAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGVlQmxvY2tTdGF0ZW1lbnQgPSB0aGlzLmZpbmRDYWxsZWVCbG9ja1N0YXRlbWVudChub2RlLmluaXQucHJvcGVydGllcywgb2JqZWN0TWVtYmVyc0NhbGxzQ2hhaW4pO1xuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBlc3RyYXZlcnNlLlZpc2l0b3JPcHRpb24uQnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gY2FsbGVlQmxvY2tTdGF0ZW1lbnQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtQcm9wZXJ0eVtdfSBvYmplY3RFeHByZXNzaW9uUHJvcGVydGllc1xuICAgICAqIEBwYXJhbSB7VE9iamVjdE1lbWJlcnNDYWxsc0NoYWlufSBvYmplY3RNZW1iZXJzQ2FsbHNDaGFpblxuICAgICAqIEByZXR1cm5zIHtCbG9ja1N0YXRlbWVudH1cbiAgICAgKi9cbiAgICBwcml2YXRlIGZpbmRDYWxsZWVCbG9ja1N0YXRlbWVudCAoXG4gICAgICAgIG9iamVjdEV4cHJlc3Npb25Qcm9wZXJ0aWVzOiBFU1RyZWUuUHJvcGVydHlbXSxcbiAgICAgICAgb2JqZWN0TWVtYmVyc0NhbGxzQ2hhaW46IFRPYmplY3RNZW1iZXJzQ2FsbHNDaGFpblxuICAgICk6IEVTVHJlZS5CbG9ja1N0YXRlbWVudHxudWxsIHtcbiAgICAgICAgY29uc3QgbmV4dEl0ZW1JbkNhbGxzQ2hhaW46IHN0cmluZ3xudW1iZXJ8dW5kZWZpbmVkID0gb2JqZWN0TWVtYmVyc0NhbGxzQ2hhaW4uc2hpZnQoKTtcblxuICAgICAgICBpZiAoIW5leHRJdGVtSW5DYWxsc0NoYWluKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAoY29uc3QgcHJvcGVydHlOb2RlIG9mIG9iamVjdEV4cHJlc3Npb25Qcm9wZXJ0aWVzKSB7XG4gICAgICAgICAgICBjb25zdCBpc1RhcmdldFByb3BlcnR5Tm9kZVdpdGhJZGVudGlmaWVyS2V5OiBib29sZWFuID1cbiAgICAgICAgICAgICAgICBOb2RlLmlzSWRlbnRpZmllck5vZGUocHJvcGVydHlOb2RlLmtleSkgJiYgcHJvcGVydHlOb2RlLmtleS5uYW1lID09PSBuZXh0SXRlbUluQ2FsbHNDaGFpbjtcbiAgICAgICAgICAgIGNvbnN0IGlzVGFyZ2V0UHJvcGVydHlOb2RlV2l0aExpdGVyYWxLZXk6IGJvb2xlYW4gPVxuICAgICAgICAgICAgICAgIE5vZGUuaXNMaXRlcmFsTm9kZShwcm9wZXJ0eU5vZGUua2V5KSAmJlxuICAgICAgICAgICAgICAgIEJvb2xlYW4ocHJvcGVydHlOb2RlLmtleS52YWx1ZSkgJiZcbiAgICAgICAgICAgICAgICBwcm9wZXJ0eU5vZGUua2V5LnZhbHVlID09PSBuZXh0SXRlbUluQ2FsbHNDaGFpbjtcblxuICAgICAgICAgICAgaWYgKCFpc1RhcmdldFByb3BlcnR5Tm9kZVdpdGhJZGVudGlmaWVyS2V5ICYmICFpc1RhcmdldFByb3BlcnR5Tm9kZVdpdGhMaXRlcmFsS2V5KSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChOb2RlLmlzT2JqZWN0RXhwcmVzc2lvbk5vZGUocHJvcGVydHlOb2RlLnZhbHVlKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZpbmRDYWxsZWVCbG9ja1N0YXRlbWVudChwcm9wZXJ0eU5vZGUudmFsdWUucHJvcGVydGllcywgb2JqZWN0TWVtYmVyc0NhbGxzQ2hhaW4pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoTm9kZS5pc0Z1bmN0aW9uRXhwcmVzc2lvbk5vZGUocHJvcGVydHlOb2RlLnZhbHVlKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBwcm9wZXJ0eU5vZGUudmFsdWUuYm9keTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbn1cbiJdfQ==