"use strict";

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var inversify_1 = require("inversify");
var ServiceIdentifiers_1 = require("../container/ServiceIdentifiers");
var estraverse = require("estraverse");
var CalleeDataExtractor_1 = require("../enums/container/stack-trace-analyzer/CalleeDataExtractor");
var Node_1 = require("../node/Node");
var NodeUtils_1 = require("../node/NodeUtils");
var StackTraceAnalyzer = StackTraceAnalyzer_1 = function () {
    function StackTraceAnalyzer(calleeDataExtractorFactory) {
        _classCallCheck(this, StackTraceAnalyzer);

        this.calleeDataExtractorFactory = calleeDataExtractorFactory;
    }

    _createClass(StackTraceAnalyzer, [{
        key: "analyze",
        value: function analyze(blockScopeBody) {
            return this.analyzeRecursive(blockScopeBody);
        }
    }, {
        key: "analyzeRecursive",
        value: function analyzeRecursive(blockScopeBody) {
            var _this = this;

            var limitIndex = StackTraceAnalyzer_1.getLimitIndex(blockScopeBody.length);
            var stackTraceData = [];
            var blockScopeBodyLength = blockScopeBody.length;

            var _loop = function _loop(index) {
                if (index > limitIndex) {
                    return "break";
                }
                var blockScopeBodyNode = blockScopeBody[index];
                estraverse.traverse(blockScopeBodyNode, {
                    enter: function enter(node) {
                        if (!Node_1.Node.isCallExpressionNode(node)) {
                            return;
                        }
                        if (blockScopeBodyNode.parentNode !== NodeUtils_1.NodeUtils.getBlockScopesOfNode(node)[0]) {
                            return estraverse.VisitorOption.Skip;
                        }
                        _this.analyzeCallExpressionNode(stackTraceData, blockScopeBody, node);
                    }
                });
            };

            for (var index = 0; index < blockScopeBodyLength; index++) {
                var _ret = _loop(index);

                if (_ret === "break") break;
            }
            return stackTraceData;
        }
    }, {
        key: "analyzeCallExpressionNode",
        value: function analyzeCallExpressionNode(stackTraceData, blockScopeBody, callExpressionNode) {
            var _this2 = this;

            StackTraceAnalyzer_1.calleeDataExtractorsList.forEach(function (calleeDataExtractorName) {
                var calleeData = _this2.calleeDataExtractorFactory(calleeDataExtractorName).extract(blockScopeBody, callExpressionNode.callee);
                if (!calleeData) {
                    return;
                }
                stackTraceData.push(Object.assign({}, calleeData, { stackTrace: _this2.analyzeRecursive(calleeData.callee.body) }));
            });
        }
    }], [{
        key: "getLimitIndex",
        value: function getLimitIndex(blockScopeBodyLength) {
            var lastIndex = blockScopeBodyLength - 1;
            var limitThresholdActivationIndex = StackTraceAnalyzer_1.limitThresholdActivationLength - 1;
            var limitIndex = lastIndex;
            if (lastIndex > limitThresholdActivationIndex) {
                limitIndex = Math.round(limitThresholdActivationIndex + lastIndex * StackTraceAnalyzer_1.limitThreshold);
                if (limitIndex > lastIndex) {
                    limitIndex = lastIndex;
                }
            }
            return limitIndex;
        }
    }]);

    return StackTraceAnalyzer;
}();
StackTraceAnalyzer.calleeDataExtractorsList = [CalleeDataExtractor_1.CalleeDataExtractor.FunctionDeclarationCalleeDataExtractor, CalleeDataExtractor_1.CalleeDataExtractor.FunctionExpressionCalleeDataExtractor, CalleeDataExtractor_1.CalleeDataExtractor.ObjectExpressionCalleeDataExtractor];
StackTraceAnalyzer.limitThresholdActivationLength = 25;
StackTraceAnalyzer.limitThreshold = 0.002;
StackTraceAnalyzer = StackTraceAnalyzer_1 = tslib_1.__decorate([inversify_1.injectable(), tslib_1.__param(0, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.Factory__ICalleeDataExtractor)), tslib_1.__metadata("design:paramtypes", [Function])], StackTraceAnalyzer);
exports.StackTraceAnalyzer = StackTraceAnalyzer;
var StackTraceAnalyzer_1;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3RhY2tUcmFjZUFuYWx5emVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3N0YWNrLXRyYWNlLWFuYWx5emVyL1N0YWNrVHJhY2VBbmFseXplci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBLDBCQUErQztBQUMvQyxtQ0FBcUU7QUFFckUseUJBQXlDO0FBU3pDLG9DQUFrRztBQUVsRyxxQkFBb0M7QUFDcEMsMEJBQThDO0FBa0M5QyxJQUFhLEFBQWtCO0FBeUIzQixnQ0FDOEQsQUFBdUQ7OztBQUVqSCxBQUFJLGFBQUMsQUFBMEIsNkJBQUcsQUFBMEIsQUFBQyxBQUNqRTtBQUFDLEFBTU0sQUFBTSxBQUFDLEFBQWE7O0FBbkMvQjs7Z0NBMERvQixBQUE2QjtBQUN6QyxBQUFNLG1CQUFDLEFBQUksS0FBQyxBQUFnQixpQkFBQyxBQUFjLEFBQUMsQUFBQyxBQUNqRDtBQUFDLEFBTU8sQUFBZ0I7Ozt5Q0FBRSxBQUE2Qjs7O0FBQ25ELGdCQUFNLEFBQVUsYUFBVyxBQUFrQixxQkFBQyxBQUFhLGNBQUMsQUFBYyxlQUFDLEFBQU0sQUFBQyxBQUFDO0FBQ25GLGdCQUFNLEFBQWMsaUJBQXNCLEFBQUUsQUFBQztBQUM3QyxnQkFBTSxBQUFvQix1QkFBVyxBQUFjLGVBQUMsQUFBTSxBQUFDOzs7QUFHdkQsQUFBRSxBQUFDLG9CQUFDLEFBQUssUUFBRyxBQUFVLEFBQUMsWUFBQyxBQUFDO0FBQ3JCLEFBQUssQUFBQyxBQUNWO0FBQUM7QUFFRCxvQkFBTSxBQUFrQixxQkFBZ0IsQUFBYyxlQUFDLEFBQUssQUFBQyxBQUFDO0FBRTlELEFBQVUsMkJBQUMsQUFBUSxTQUFDLEFBQWtCO0FBQ2xDLEFBQUssMkJBQUUsZUFBQyxBQUFpQjtBQUNyQixBQUFFLEFBQUMsNEJBQUMsQ0FBQyxPQUFJLEtBQUMsQUFBb0IscUJBQUMsQUFBSSxBQUFDLEFBQUMsT0FBQyxBQUFDO0FBQ25DLEFBQU0sQUFBQyxBQUNYO0FBQUM7QUFFRCxBQUFFLEFBQUMsNEJBQUMsQUFBa0IsbUJBQUMsQUFBVSxlQUFLLFlBQVMsVUFBQyxBQUFvQixxQkFBQyxBQUFJLEFBQUMsTUFBQyxBQUFDLEFBQUMsQUFBQyxJQUFDLEFBQUM7QUFDNUUsQUFBTSxtQ0FBQyxBQUFVLFdBQUMsQUFBYSxjQUFDLEFBQUksQUFBQyxBQUN6QztBQUFDO0FBRUQsQUFBSSw4QkFBQyxBQUF5QiwwQkFBQyxBQUFjLGdCQUFFLEFBQWMsZ0JBQUUsQUFBSSxBQUFDLEFBQUMsQUFDekU7QUFBQyxBQUNKLEFBQUMsQUFBQyxBQUNQO0FBYjRDOzs7QUFQNUMsQUFBRyxBQUFDLGlCQUFDLElBQUksQUFBSyxRQUFXLEFBQUMsR0FBRSxBQUFLLFFBQUcsQUFBb0Isc0JBQUUsQUFBSyxBQUFFO0FBQUUsQUFBQzs7O0FBb0JuRTtBQUVELEFBQU0sbUJBQUMsQUFBYyxBQUFDLEFBQzFCO0FBQUMsQUFPTyxBQUF5Qjs7O2tEQUM3QixBQUFpQyxnQkFDakMsQUFBNkIsZ0JBQzdCLEFBQXlDOzs7QUFFekMsQUFBa0IsaUNBQUMsQUFBd0IseUJBQUMsQUFBTyxRQUFDLFVBQUMsQUFBNEM7QUFDN0Ysb0JBQU0sQUFBVSxhQUF1QixBQUFJLE9BQUMsQUFBMEIsMkJBQUMsQUFBdUIsQUFBQyx5QkFDMUYsQUFBTyxRQUFDLEFBQWMsZ0JBQUUsQUFBa0IsbUJBQUMsQUFBTSxBQUFDLEFBQUM7QUFFeEQsQUFBRSxBQUFDLG9CQUFDLENBQUMsQUFBVSxBQUFDLFlBQUMsQUFBQztBQUNkLEFBQU0sQUFBQyxBQUNYO0FBQUM7QUFFRCxBQUFjLCtCQUFDLEFBQUksdUJBQ1osQUFBVSxjQUNiLEFBQVUsWUFBRSxBQUFJLE9BQUMsQUFBZ0IsaUJBQUMsQUFBVSxXQUFDLEFBQU0sT0FBQyxBQUFJLEFBQUMsQUFDM0QsQUFBQyxBQUNQO0FBQUMsQUFBQyxBQUFDLEFBQ1A7QUFBQyxBQUNKOzs7c0NBckZnQyxBQUE0QjtBQUNyRCxnQkFBTSxBQUFTLFlBQVcsQUFBb0IsdUJBQUcsQUFBQyxBQUFDO0FBQ25ELGdCQUFNLEFBQTZCLGdDQUFXLEFBQWtCLHFCQUFDLEFBQThCLGlDQUFHLEFBQUMsQUFBQztBQUVwRyxnQkFBSSxBQUFVLGFBQVcsQUFBUyxBQUFDO0FBRW5DLEFBQUUsQUFBQyxnQkFBQyxBQUFTLFlBQUcsQUFBNkIsQUFBQywrQkFBQyxBQUFDO0FBQzVDLEFBQVUsNkJBQUcsQUFBSSxLQUFDLEFBQUssTUFDbkIsQUFBNkIsQUFBRyxnQ0FBQyxBQUFTLFlBQUcsQUFBa0IscUJBQUMsQUFBYyxBQUFDLEFBQ2xGLEFBQUM7QUFFRixBQUFFLEFBQUMsb0JBQUMsQUFBVSxhQUFHLEFBQVMsQUFBQyxXQUFDLEFBQUM7QUFDekIsQUFBVSxpQ0FBRyxBQUFTLEFBQUMsQUFDM0I7QUFBQyxBQUNMO0FBQUM7QUFFRCxBQUFNLG1CQUFDLEFBQVUsQUFBQyxBQUN0QjtBQUFDLEFBTU0sQUFBTzs7Ozs7QUF0RFUsbUJBQXdCLDJCQUEwQixDQUN0RSxzQkFBbUIsb0JBQUMsQUFBc0Msd0NBQzFELHNCQUFtQixvQkFBQyxBQUFxQyx1Q0FDekQsc0JBQW1CLG9CQUFDLEFBQW1DLEFBQzFELEFBQUM7QUFLc0IsbUJBQThCLGlDQUFXLEFBQUUsQUFBQztBQUs1QyxtQkFBYyxpQkFBVyxBQUFLLEFBQUM7QUFsQjlDLEFBQWtCLGdFQUQ5QixZQUFVLEFBQUUsY0EyQkosbUJBQUEsWUFBTSxPQUFDLHFCQUFrQixtQkFBQyxBQUE2QixBQUFDLHVGQTFCcEQsQUFBa0IsQUF3SDlCO0FBeEhZLDZCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGluamVjdGFibGUsIGluamVjdCB9IGZyb20gJ2ludmVyc2lmeSc7XG5pbXBvcnQgeyBTZXJ2aWNlSWRlbnRpZmllcnMgfSBmcm9tICcuLi9jb250YWluZXIvU2VydmljZUlkZW50aWZpZXJzJztcblxuaW1wb3J0ICogYXMgZXN0cmF2ZXJzZSBmcm9tICdlc3RyYXZlcnNlJztcbmltcG9ydCAqIGFzIEVTVHJlZSBmcm9tICdlc3RyZWUnO1xuXG5pbXBvcnQgeyBUQ2FsbGVlRGF0YUV4dHJhY3RvckZhY3RvcnkgfSBmcm9tICcuLi90eXBlcy9jb250YWluZXIvc3RhY2stdHJhY2UtYW5hbHl6ZXIvVENhbGxlZURhdGFFeHRyYWN0b3JGYWN0b3J5JztcblxuaW1wb3J0IHsgSUNhbGxlZURhdGEgfSBmcm9tICcuLi9pbnRlcmZhY2VzL3N0YWNrLXRyYWNlLWFuYWx5emVyL0lDYWxsZWVEYXRhJztcbmltcG9ydCB7IElTdGFja1RyYWNlQW5hbHl6ZXIgfSBmcm9tICcuLi9pbnRlcmZhY2VzL3N0YWNrLXRyYWNlLWFuYWx5emVyL0lTdGFja1RyYWNlQW5hbHl6ZXInO1xuaW1wb3J0IHsgSVN0YWNrVHJhY2VEYXRhIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9zdGFjay10cmFjZS1hbmFseXplci9JU3RhY2tUcmFjZURhdGEnO1xuXG5pbXBvcnQgeyBDYWxsZWVEYXRhRXh0cmFjdG9yIH0gZnJvbSAnLi4vZW51bXMvY29udGFpbmVyL3N0YWNrLXRyYWNlLWFuYWx5emVyL0NhbGxlZURhdGFFeHRyYWN0b3InO1xuXG5pbXBvcnQgeyBOb2RlIH0gZnJvbSAnLi4vbm9kZS9Ob2RlJztcbmltcG9ydCB7IE5vZGVVdGlscyB9IGZyb20gJy4uL25vZGUvTm9kZVV0aWxzJztcblxuLyoqXG4gKiBUaGlzIGNsYXNzIGdlbmVyYXRlcyBhIGRhdGEgd2l0aCBhIHN0YWNrIHRyYWNlIG9mIGZ1bmN0aW9ucyBjYWxsc1xuICpcbiAqIEZvciBleGFtcGxlOlxuICpcbiAqIGZ1bmN0aW9uIEZvbyAoKSB7XG4gKiAgICAgdmFyIGJheiA9IGZ1bmN0aW9uICgpIHtcbiAqXG4gKiAgICAgfVxuICpcbiAqICAgICBiYXooKTtcbiAqIH1cbiAqXG4gKiBmb28oKTtcbiAqXG4gKiBXaWxsIGdlbmVyYXRlIGEgc3RydWN0dXJlIGxpa2U6XG4gKlxuICogW1xuICogICAgICB7XG4gKiAgICAgICAgICBjYWxsZWU6IEZPT19GVU5DVElPTl9OT0RFXG4gKiAgICAgICAgICBuYW1lOiAnRm9vJyxcbiAqICAgICAgICAgIHRyYWNlOiBbXG4gKiAgICAgICAgICAgICAge1xuICogICAgICAgICAgICAgICAgICBjYWxsZWU6IEJBWl9GVU5DVElPTl9OT0RFLFxuICogICAgICAgICAgICAgICAgICBuYW1lOiAnYmF6LFxuICogICAgICAgICAgICAgICAgICB0cmFjZTogW11cbiAqICAgICAgICAgICAgICB9XG4gKiAgICAgICAgICBdXG4gKiAgICAgIH1cbiAqIF1cbiAqL1xuQGluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFN0YWNrVHJhY2VBbmFseXplciBpbXBsZW1lbnRzIElTdGFja1RyYWNlQW5hbHl6ZXIge1xuICAgIC8qKlxuICAgICAqIEB0eXBlIHtDYWxsZWVEYXRhRXh0cmFjdG9yW119XG4gICAgICovXG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgY2FsbGVlRGF0YUV4dHJhY3RvcnNMaXN0OiBDYWxsZWVEYXRhRXh0cmFjdG9yW10gPSBbXG4gICAgICAgIENhbGxlZURhdGFFeHRyYWN0b3IuRnVuY3Rpb25EZWNsYXJhdGlvbkNhbGxlZURhdGFFeHRyYWN0b3IsXG4gICAgICAgIENhbGxlZURhdGFFeHRyYWN0b3IuRnVuY3Rpb25FeHByZXNzaW9uQ2FsbGVlRGF0YUV4dHJhY3RvcixcbiAgICAgICAgQ2FsbGVlRGF0YUV4dHJhY3Rvci5PYmplY3RFeHByZXNzaW9uQ2FsbGVlRGF0YUV4dHJhY3RvclxuICAgIF07XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IGxpbWl0VGhyZXNob2xkQWN0aXZhdGlvbkxlbmd0aDogbnVtYmVyID0gMjU7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IGxpbWl0VGhyZXNob2xkOiBudW1iZXIgPSAwLjAwMjtcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtUQ2FsbGVlRGF0YUV4dHJhY3RvckZhY3Rvcnl9XG4gICAgICovXG4gICAgcHJpdmF0ZSBjYWxsZWVEYXRhRXh0cmFjdG9yRmFjdG9yeTogVENhbGxlZURhdGFFeHRyYWN0b3JGYWN0b3J5O1xuXG4gICAgY29uc3RydWN0b3IgKFxuICAgICAgICBAaW5qZWN0KFNlcnZpY2VJZGVudGlmaWVycy5GYWN0b3J5X19JQ2FsbGVlRGF0YUV4dHJhY3RvcikgY2FsbGVlRGF0YUV4dHJhY3RvckZhY3Rvcnk6IFRDYWxsZWVEYXRhRXh0cmFjdG9yRmFjdG9yeVxuICAgICkge1xuICAgICAgICB0aGlzLmNhbGxlZURhdGFFeHRyYWN0b3JGYWN0b3J5ID0gY2FsbGVlRGF0YUV4dHJhY3RvckZhY3Rvcnk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtudW1iZXJ9IGJsb2NrU2NvcGVCb2R5TGVuZ3RoXG4gICAgICogQHJldHVybnMge251bWJlcn1cbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIGdldExpbWl0SW5kZXggKGJsb2NrU2NvcGVCb2R5TGVuZ3RoOiBudW1iZXIpOiBudW1iZXIge1xuICAgICAgICBjb25zdCBsYXN0SW5kZXg6IG51bWJlciA9IGJsb2NrU2NvcGVCb2R5TGVuZ3RoIC0gMTtcbiAgICAgICAgY29uc3QgbGltaXRUaHJlc2hvbGRBY3RpdmF0aW9uSW5kZXg6IG51bWJlciA9IFN0YWNrVHJhY2VBbmFseXplci5saW1pdFRocmVzaG9sZEFjdGl2YXRpb25MZW5ndGggLSAxO1xuXG4gICAgICAgIGxldCBsaW1pdEluZGV4OiBudW1iZXIgPSBsYXN0SW5kZXg7XG5cbiAgICAgICAgaWYgKGxhc3RJbmRleCA+IGxpbWl0VGhyZXNob2xkQWN0aXZhdGlvbkluZGV4KSB7XG4gICAgICAgICAgICBsaW1pdEluZGV4ID0gTWF0aC5yb3VuZChcbiAgICAgICAgICAgICAgICBsaW1pdFRocmVzaG9sZEFjdGl2YXRpb25JbmRleCArIChsYXN0SW5kZXggKiBTdGFja1RyYWNlQW5hbHl6ZXIubGltaXRUaHJlc2hvbGQpXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBpZiAobGltaXRJbmRleCA+IGxhc3RJbmRleCkge1xuICAgICAgICAgICAgICAgIGxpbWl0SW5kZXggPSBsYXN0SW5kZXg7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbGltaXRJbmRleDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge05vZGVbXX0gYmxvY2tTY29wZUJvZHlcbiAgICAgKiBAcmV0dXJucyB7SVN0YWNrVHJhY2VEYXRhW119XG4gICAgICovXG4gICAgcHVibGljIGFuYWx5emUgKGJsb2NrU2NvcGVCb2R5OiBFU1RyZWUuTm9kZVtdKTogSVN0YWNrVHJhY2VEYXRhW10ge1xuICAgICAgICByZXR1cm4gdGhpcy5hbmFseXplUmVjdXJzaXZlKGJsb2NrU2NvcGVCb2R5KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge05vZGVbXX0gYmxvY2tTY29wZUJvZHlcbiAgICAgKiBAcmV0dXJucyB7SVN0YWNrVHJhY2VEYXRhW119XG4gICAgICovXG4gICAgcHJpdmF0ZSBhbmFseXplUmVjdXJzaXZlIChibG9ja1Njb3BlQm9keTogRVNUcmVlLk5vZGVbXSk6IElTdGFja1RyYWNlRGF0YVtdIHtcbiAgICAgICAgY29uc3QgbGltaXRJbmRleDogbnVtYmVyID0gU3RhY2tUcmFjZUFuYWx5emVyLmdldExpbWl0SW5kZXgoYmxvY2tTY29wZUJvZHkubGVuZ3RoKTtcbiAgICAgICAgY29uc3Qgc3RhY2tUcmFjZURhdGE6IElTdGFja1RyYWNlRGF0YVtdID0gW107XG4gICAgICAgIGNvbnN0IGJsb2NrU2NvcGVCb2R5TGVuZ3RoOiBudW1iZXIgPSBibG9ja1Njb3BlQm9keS5sZW5ndGg7XG5cbiAgICAgICAgZm9yIChsZXQgaW5kZXg6IG51bWJlciA9IDA7IGluZGV4IDwgYmxvY2tTY29wZUJvZHlMZW5ndGg7IGluZGV4KyspIHtcbiAgICAgICAgICAgIGlmIChpbmRleCA+IGxpbWl0SW5kZXgpIHtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgYmxvY2tTY29wZUJvZHlOb2RlOiBFU1RyZWUuTm9kZSA9IGJsb2NrU2NvcGVCb2R5W2luZGV4XTtcblxuICAgICAgICAgICAgZXN0cmF2ZXJzZS50cmF2ZXJzZShibG9ja1Njb3BlQm9keU5vZGUsIHtcbiAgICAgICAgICAgICAgICBlbnRlcjogKG5vZGU6IEVTVHJlZS5Ob2RlKTogYW55ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFOb2RlLmlzQ2FsbEV4cHJlc3Npb25Ob2RlKG5vZGUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAoYmxvY2tTY29wZUJvZHlOb2RlLnBhcmVudE5vZGUgIT09IE5vZGVVdGlscy5nZXRCbG9ja1Njb3Blc09mTm9kZShub2RlKVswXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVzdHJhdmVyc2UuVmlzaXRvck9wdGlvbi5Ta2lwO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmFseXplQ2FsbEV4cHJlc3Npb25Ob2RlKHN0YWNrVHJhY2VEYXRhLCBibG9ja1Njb3BlQm9keSwgbm9kZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gc3RhY2tUcmFjZURhdGE7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtJU3RhY2tUcmFjZURhdGFbXX0gc3RhY2tUcmFjZURhdGFcbiAgICAgKiBAcGFyYW0ge05vZGVbXX0gYmxvY2tTY29wZUJvZHlcbiAgICAgKiBAcGFyYW0ge0NhbGxFeHByZXNzaW9ufSBjYWxsRXhwcmVzc2lvbk5vZGVcbiAgICAgKi9cbiAgICBwcml2YXRlIGFuYWx5emVDYWxsRXhwcmVzc2lvbk5vZGUgKFxuICAgICAgICBzdGFja1RyYWNlRGF0YTogSVN0YWNrVHJhY2VEYXRhW10sXG4gICAgICAgIGJsb2NrU2NvcGVCb2R5OiBFU1RyZWUuTm9kZVtdLFxuICAgICAgICBjYWxsRXhwcmVzc2lvbk5vZGU6IEVTVHJlZS5DYWxsRXhwcmVzc2lvblxuICAgICk6IHZvaWQge1xuICAgICAgICBTdGFja1RyYWNlQW5hbHl6ZXIuY2FsbGVlRGF0YUV4dHJhY3RvcnNMaXN0LmZvckVhY2goKGNhbGxlZURhdGFFeHRyYWN0b3JOYW1lOiBDYWxsZWVEYXRhRXh0cmFjdG9yKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjYWxsZWVEYXRhOiBJQ2FsbGVlRGF0YSB8IG51bGwgPSB0aGlzLmNhbGxlZURhdGFFeHRyYWN0b3JGYWN0b3J5KGNhbGxlZURhdGFFeHRyYWN0b3JOYW1lKVxuICAgICAgICAgICAgICAgIC5leHRyYWN0KGJsb2NrU2NvcGVCb2R5LCBjYWxsRXhwcmVzc2lvbk5vZGUuY2FsbGVlKTtcblxuICAgICAgICAgICAgaWYgKCFjYWxsZWVEYXRhKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzdGFja1RyYWNlRGF0YS5wdXNoKHtcbiAgICAgICAgICAgICAgICAuLi5jYWxsZWVEYXRhLFxuICAgICAgICAgICAgICAgIHN0YWNrVHJhY2U6IHRoaXMuYW5hbHl6ZVJlY3Vyc2l2ZShjYWxsZWVEYXRhLmNhbGxlZS5ib2R5KVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==