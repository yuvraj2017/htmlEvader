"use strict";

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var inversify_1 = require("inversify");
var ServiceIdentifiers_1 = require("../../container/ServiceIdentifiers");
var estraverse = require("estraverse");
var AbstractNodeTransformer_1 = require("../AbstractNodeTransformer");
var Node_1 = require("../../node/Node");
var Nodes_1 = require("../../node/Nodes");
var NodeUtils_1 = require("../../node/NodeUtils");
var DeadCodeInjectionTransformer = DeadCodeInjectionTransformer_1 = function (_AbstractNodeTransfor) {
    _inherits(DeadCodeInjectionTransformer, _AbstractNodeTransfor);

    function DeadCodeInjectionTransformer(randomGenerator, options) {
        _classCallCheck(this, DeadCodeInjectionTransformer);

        var _this = _possibleConstructorReturn(this, (DeadCodeInjectionTransformer.__proto__ || Object.getPrototypeOf(DeadCodeInjectionTransformer)).call(this, randomGenerator, options));

        _this.collectedBlockStatements = [];
        return _this;
    }

    _createClass(DeadCodeInjectionTransformer, [{
        key: "getVisitor",
        value: function getVisitor() {
            var _this2 = this;

            return {
                leave: function leave(node, parentNode) {
                    if (Node_1.Node.isProgramNode(node)) {
                        return _this2.transformNode(node, parentNode);
                    }
                }
            };
        }
    }, {
        key: "transformNode",
        value: function transformNode(programNode, parentNode) {
            this.transformProgramNode(programNode);
            return programNode;
        }
    }, {
        key: "collectBlockStatementNodes",
        value: function collectBlockStatementNodes(blockStatementNode, collectedBlockStatements) {
            var _this3 = this;

            var clonedBlockStatementNode = NodeUtils_1.NodeUtils.clone(blockStatementNode);
            var nestedBlockStatementsCount = 0,
                isValidBlockStatementNode = true;
            estraverse.replace(clonedBlockStatementNode, {
                enter: function enter(node, parentNode) {
                    if (Node_1.Node.isBlockStatementNode(node)) {
                        nestedBlockStatementsCount++;
                    }
                    if (nestedBlockStatementsCount > DeadCodeInjectionTransformer_1.maxNestedBlockStatementsCount || Node_1.Node.isBreakStatementNode(node) || Node_1.Node.isContinueStatementNode(node)) {
                        isValidBlockStatementNode = false;
                        return estraverse.VisitorOption.Break;
                    }
                    if (Node_1.Node.isIdentifierNode(node) && !Node_1.Node.isMemberExpressionNode(parentNode)) {
                        node.name = _this3.randomGenerator.getRandomVariableName(6);
                    }
                    return node;
                }
            });
            if (!isValidBlockStatementNode) {
                return;
            }
            collectedBlockStatements.push(clonedBlockStatementNode);
        }
    }, {
        key: "replaceBlockStatementNode",
        value: function replaceBlockStatementNode(blockStatementNode, randomBlockStatementNode) {
            var random1 = this.randomGenerator.getMathRandom() > 0.5;
            var random2 = this.randomGenerator.getMathRandom() > 0.5;
            var operator = random1 ? '===' : '!==';
            var leftString = this.randomGenerator.getRandomString(3);
            var rightString = random2 ? leftString : this.randomGenerator.getRandomString(3);
            var consequent = void 0,
                alternate = void 0;
            if (random1 && random2 || !random1 && !random2) {
                consequent = blockStatementNode;
                alternate = randomBlockStatementNode;
            } else {
                consequent = randomBlockStatementNode;
                alternate = blockStatementNode;
            }
            var newBlockStatementNode = Nodes_1.Nodes.getBlockStatementNode([Nodes_1.Nodes.getIfStatementNode(Nodes_1.Nodes.getBinaryExpressionNode(operator, Nodes_1.Nodes.getLiteralNode(leftString), Nodes_1.Nodes.getLiteralNode(rightString)), consequent, alternate)]);
            newBlockStatementNode = NodeUtils_1.NodeUtils.parentize(newBlockStatementNode);
            return newBlockStatementNode;
        }
    }, {
        key: "transformProgramNode",
        value: function transformProgramNode(programNode) {
            var _this4 = this;

            estraverse.traverse(programNode, {
                enter: function enter(node, parentNode) {
                    if (!Node_1.Node.isBlockStatementNode(node)) {
                        return;
                    }
                    _this4.collectBlockStatementNodes(node, _this4.collectedBlockStatements);
                }
            });
            if (this.collectedBlockStatements.length < DeadCodeInjectionTransformer_1.minCollectedBlockStatementsCount) {
                return;
            }
            estraverse.replace(programNode, {
                leave: function leave(node, parentNode) {
                    if (!_this4.collectedBlockStatements.length) {
                        return estraverse.VisitorOption.Break;
                    }
                    if (!Node_1.Node.isBlockStatementNode(node) || _this4.randomGenerator.getMathRandom() > _this4.options.deadCodeInjectionThreshold) {
                        return node;
                    }
                    var minInteger = 0;
                    var maxInteger = _this4.collectedBlockStatements.length - 1;
                    var randomIndex = _this4.randomGenerator.getRandomInteger(minInteger, maxInteger);
                    var randomBlockStatementNode = _this4.collectedBlockStatements.splice(randomIndex, 1)[0];
                    if (randomBlockStatementNode === node) {
                        return node;
                    }
                    return _this4.replaceBlockStatementNode(node, randomBlockStatementNode);
                }
            });
        }
    }]);

    return DeadCodeInjectionTransformer;
}(AbstractNodeTransformer_1.AbstractNodeTransformer);
DeadCodeInjectionTransformer.maxNestedBlockStatementsCount = 4;
DeadCodeInjectionTransformer.minCollectedBlockStatementsCount = 5;
DeadCodeInjectionTransformer = DeadCodeInjectionTransformer_1 = tslib_1.__decorate([inversify_1.injectable(), tslib_1.__param(0, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.IRandomGenerator)), tslib_1.__param(1, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.IOptions)), tslib_1.__metadata("design:paramtypes", [Object, Object])], DeadCodeInjectionTransformer);
exports.DeadCodeInjectionTransformer = DeadCodeInjectionTransformer;
var DeadCodeInjectionTransformer_1;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGVhZENvZGVJbmplY3Rpb25UcmFuc2Zvcm1lci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ub2RlLXRyYW5zZm9ybWVycy9kZWFkLWNvZGUtaW5qZWN0aW9uLXRyYW5zZm9ybWVycy9EZWFkQ29kZUluamVjdGlvblRyYW5zZm9ybWVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBLDBCQUErQztBQUMvQyxtQ0FBd0U7QUFFeEUseUJBQXlDO0FBT3pDLHdDQUFxRTtBQUNyRSxxQkFBdUM7QUFDdkMsc0JBQXlDO0FBQ3pDLDBCQUFpRDtBQUdqRCxJQUFhLEFBQTRCO0FBQXpDLEFBQTBDOztBQW9CdEMsMENBQ2lELEFBQWlDLGlCQUN6QyxBQUFpQjtBQUV0RCxBQUFLOztnS0FBQyxBQUFlLGlCQUFFLEFBQU8sQUFBQyxBQUFDOztBQVZuQixjQUF3QiwyQkFBNEIsQUFBRSxBQUFDLEFBV3hFOztBQUFDLEFBS00sQUFBVTs7Ozs7OztBQUNiLEFBQU07QUFDRixBQUFLLHVCQUFFLGVBQUMsQUFBaUIsTUFBRSxBQUF1QjtBQUM5QyxBQUFFLEFBQUMsd0JBQUMsT0FBSSxLQUFDLEFBQWEsY0FBQyxBQUFJLEFBQUMsQUFBQyxPQUFDLEFBQUM7QUFDM0IsQUFBTSwrQkFBQyxBQUFJLE9BQUMsQUFBYSxjQUFDLEFBQUksTUFBRSxBQUFVLEFBQUMsQUFBQyxBQUNoRDtBQUFDLEFBQ0w7QUFBQyxBQUNKLEFBQUMsQUFDTjtBQVBXO0FBT1YsQUFPTSxBQUFhOzs7c0NBQUUsQUFBMkIsYUFBRSxBQUF1QjtBQUN0RSxBQUFJLGlCQUFDLEFBQW9CLHFCQUFDLEFBQVcsQUFBQyxBQUFDO0FBRXZDLEFBQU0sbUJBQUMsQUFBVyxBQUFDLEFBQ3ZCO0FBQUMsQUFNTyxBQUEwQjs7O21EQUM5QixBQUF5QyxvQkFDekMsQUFBaUQ7OztBQUVqRCxnQkFBTSxBQUF3QiwyQkFBMEIsWUFBUyxVQUFDLEFBQUssTUFBQyxB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QUMsQUFBd0IseUJBQUMsQUFBTSxTQUFHLEFBQUMsQUFBQztBQUNwRSx3QkFBTSxBQUFXLGNBQVcsQUFBSSxPQUFDLEFBQWUsZ0JBQUMsQUFBZ0IsaUJBQUMsQUFBVSxZQUFFLEFBQVUsQUFBQyxBQUFDO0FBQzFGLHdCQUFNLEFBQXdCLDJCQUEwQixBQUFJLE9BQUMsQUFBd0IseUJBQUMsQUFBTSxPQUFDLEFBQVcsYUFBRSxBQUFDLEFBQUMsR0FBQyxBQUFDLEFBQUMsQUFBQztBQUVoSCxBQUFFLEFBQUMsd0JBQUMsQUFBd0IsNkJBQUssQUFBSSxBQUFDLE1BQUMsQUFBQztBQUNwQyxBQUFNLCtCQUFDLEFBQUksQUFBQyxBQUNoQjtBQUFDO0FBRUQsQUFBTSwyQkFBQyxBQUFJLE9BQUMsQUFBeUIsMEJBQUMsQUFBSSxNQUFFLEFBQXdCLEFBQUMsQUFBQyxBQUMxRTtBQUFDLEFBQ0osQUFBQyxBQUFDLEFBQ1A7QUF6Qm9DO0FBeUJuQyxBQUNKOzs7O0VBbE1pRCwwQkFBdUI7QUFJN0MsNkJBQTZCLGdDQUFXLEFBQUMsQUFBQztBQUsxQyw2QkFBZ0MsbUNBQVcsQUFBQyxBQUFDO0FBVDVELEFBQTRCLG9GQUR4QyxZQUFVLEFBQUUsY0FzQkosbUJBQUEsWUFBTSxPQUFDLHFCQUFrQixtQkFBQyxBQUFnQixBQUFDLG9CQUMzQyxtQkFBQSxZQUFNLE9BQUMscUJBQWtCLG1CQUFDLEFBQVEsQUFBQyx3RUF0Qi9CLEFBQTRCLEFBa014QztBQWxNWSx1Q0FBNEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpbmplY3RhYmxlLCBpbmplY3QgfSBmcm9tICdpbnZlcnNpZnknO1xuaW1wb3J0IHsgU2VydmljZUlkZW50aWZpZXJzIH0gZnJvbSAnLi4vLi4vY29udGFpbmVyL1NlcnZpY2VJZGVudGlmaWVycyc7XG5cbmltcG9ydCAqIGFzIGVzdHJhdmVyc2UgZnJvbSAnZXN0cmF2ZXJzZSc7XG5pbXBvcnQgKiBhcyBFU1RyZWUgZnJvbSAnZXN0cmVlJztcblxuaW1wb3J0IHsgSU9wdGlvbnMgfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL29wdGlvbnMvSU9wdGlvbnMnO1xuaW1wb3J0IHsgSVJhbmRvbUdlbmVyYXRvciB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvdXRpbHMvSVJhbmRvbUdlbmVyYXRvcic7XG5pbXBvcnQgeyBJVmlzaXRvciB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvSVZpc2l0b3InO1xuXG5pbXBvcnQgeyBBYnN0cmFjdE5vZGVUcmFuc2Zvcm1lciB9IGZyb20gJy4uL0Fic3RyYWN0Tm9kZVRyYW5zZm9ybWVyJztcbmltcG9ydCB7IE5vZGUgfSBmcm9tICcuLi8uLi9ub2RlL05vZGUnO1xuaW1wb3J0IHsgTm9kZXMgfSBmcm9tICcuLi8uLi9ub2RlL05vZGVzJztcbmltcG9ydCB7IE5vZGVVdGlscyB9IGZyb20gJy4uLy4uL25vZGUvTm9kZVV0aWxzJztcblxuQGluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIERlYWRDb2RlSW5qZWN0aW9uVHJhbnNmb3JtZXIgZXh0ZW5kcyBBYnN0cmFjdE5vZGVUcmFuc2Zvcm1lciB7XG4gICAgLyoqXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBtYXhOZXN0ZWRCbG9ja1N0YXRlbWVudHNDb3VudDogbnVtYmVyID0gNDtcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtudW1iZXJ9XG4gICAgICovXG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgbWluQ29sbGVjdGVkQmxvY2tTdGF0ZW1lbnRzQ291bnQ6IG51bWJlciA9IDU7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7RVNUcmVlLkJsb2NrU3RhdGVtZW50W119XG4gICAgICovXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb2xsZWN0ZWRCbG9ja1N0YXRlbWVudHM6IEVTVHJlZS5CbG9ja1N0YXRlbWVudFtdID0gW107XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge0lSYW5kb21HZW5lcmF0b3J9IHJhbmRvbUdlbmVyYXRvclxuICAgICAqIEBwYXJhbSB7SU9wdGlvbnN9IG9wdGlvbnNcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvciAoXG4gICAgICAgIEBpbmplY3QoU2VydmljZUlkZW50aWZpZXJzLklSYW5kb21HZW5lcmF0b3IpIHJhbmRvbUdlbmVyYXRvcjogSVJhbmRvbUdlbmVyYXRvcixcbiAgICAgICAgQGluamVjdChTZXJ2aWNlSWRlbnRpZmllcnMuSU9wdGlvbnMpIG9wdGlvbnM6IElPcHRpb25zXG4gICAgKSB7XG4gICAgICAgIHN1cGVyKHJhbmRvbUdlbmVyYXRvciwgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHJldHVybiB7SVZpc2l0b3J9XG4gICAgICovXG4gICAgcHVibGljIGdldFZpc2l0b3IgKCk6IElWaXNpdG9yIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGxlYXZlOiAobm9kZTogRVNUcmVlLk5vZGUsIHBhcmVudE5vZGU6IEVTVHJlZS5Ob2RlKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKE5vZGUuaXNQcm9ncmFtTm9kZShub2RlKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy50cmFuc2Zvcm1Ob2RlKG5vZGUsIHBhcmVudE5vZGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge1Byb2dyYW19IHByb2dyYW1Ob2RlXG4gICAgICogQHBhcmFtIHtOb2RlfSBwYXJlbnROb2RlXG4gICAgICogQHJldHVybnMge05vZGV9XG4gICAgICovXG4gICAgcHVibGljIHRyYW5zZm9ybU5vZGUgKHByb2dyYW1Ob2RlOiBFU1RyZWUuUHJvZ3JhbSwgcGFyZW50Tm9kZTogRVNUcmVlLk5vZGUpOiBFU1RyZWUuTm9kZSB7XG4gICAgICAgIHRoaXMudHJhbnNmb3JtUHJvZ3JhbU5vZGUocHJvZ3JhbU5vZGUpO1xuXG4gICAgICAgIHJldHVybiBwcm9ncmFtTm9kZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge0Jsb2NrU3RhdGVtZW50fSBibG9ja1N0YXRlbWVudE5vZGVcbiAgICAgKiBAcGFyYW0ge0Jsb2NrU3RhdGVtZW50W119IGNvbGxlY3RlZEJsb2NrU3RhdGVtZW50c1xuICAgICAqL1xuICAgIHByaXZhdGUgY29sbGVjdEJsb2NrU3RhdGVtZW50Tm9kZXMgKFxuICAgICAgICBibG9ja1N0YXRlbWVudE5vZGU6IEVTVHJlZS5CbG9ja1N0YXRlbWVudCxcbiAgICAgICAgY29sbGVjdGVkQmxvY2tTdGF0ZW1lbnRzOiBFU1RyZWUuQmxvY2tTdGF0ZW1lbnRbXVxuICAgICk6IHZvaWQge1xuICAgICAgICBjb25zdCBjbG9uZWRCbG9ja1N0YXRlbWVudE5vZGU6IEVTVHJlZS5CbG9ja1N0YXRlbWVudCA9IE5vZGVVdGlscy5jbG9uZShibG9ja1N0YXRlbWVudE5vZGUpO1xuXG4gICAgICAgIGxldCBuZXN0ZWRCbG9ja1N0YXRlbWVudHNDb3VudDogbnVtYmVyID0gMCxcbiAgICAgICAgICAgIGlzVmFsaWRCbG9ja1N0YXRlbWVudE5vZGU6IGJvb2xlYW4gPSB0cnVlO1xuXG4gICAgICAgIGVzdHJhdmVyc2UucmVwbGFjZShjbG9uZWRCbG9ja1N0YXRlbWVudE5vZGUsIHtcbiAgICAgICAgICAgIGVudGVyOiAobm9kZTogRVNUcmVlLk5vZGUsIHBhcmVudE5vZGU6IEVTVHJlZS5Ob2RlKTogYW55ID0+IHtcbiAgICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICAgKiBGaXJzdCBzdGVwOiBjb3VudCBuZXN0ZWQgYmxvY2sgc3RhdGVtZW50cyBpbiBjdXJyZW50IGJsb2NrIHN0YXRlbWVudFxuICAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICAgIGlmIChOb2RlLmlzQmxvY2tTdGF0ZW1lbnROb2RlKG5vZGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIG5lc3RlZEJsb2NrU3RhdGVtZW50c0NvdW50Kys7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgICAgICogSWYgbmVzdGVkIGJsb2NrIHN0YXRlbWVudHMgY291bnQgYmlnZ2VyIHRoZW4gc3BlY2lmaWVkIGFtb3VudCBvciBjdXJyZW50IGJsb2NrIHN0YXRlbWVudFxuICAgICAgICAgICAgICAgICAqIGNvbnRhaW5zIHByb2hpYml0ZWQgbm9kZXMgLSB3ZSB3aWxsIHN0b3AgdHJhdmVyc2luZyBhbmQgbGVhdmUgbWV0aG9kXG4gICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICAgICBuZXN0ZWRCbG9ja1N0YXRlbWVudHNDb3VudCA+IERlYWRDb2RlSW5qZWN0aW9uVHJhbnNmb3JtZXIubWF4TmVzdGVkQmxvY2tTdGF0ZW1lbnRzQ291bnQgfHxcbiAgICAgICAgICAgICAgICAgICAgTm9kZS5pc0JyZWFrU3RhdGVtZW50Tm9kZShub2RlKSB8fFxuICAgICAgICAgICAgICAgICAgICBOb2RlLmlzQ29udGludWVTdGF0ZW1lbnROb2RlKG5vZGUpXG4gICAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzVmFsaWRCbG9ja1N0YXRlbWVudE5vZGUgPSBmYWxzZTtcblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXN0cmF2ZXJzZS5WaXNpdG9yT3B0aW9uLkJyZWFrO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICAgICAqIFNlY29uZCBzdGVwOiByZW5hbWUgYWxsIGlkZW50aWZpZXJzIChleGNlcHQgaWRlbnRpZmllcnMgaW4gbWVtYmVyIGV4cHJlc3Npb25zKVxuICAgICAgICAgICAgICAgICAqIGluIGN1cnJlbnQgYmxvY2sgc3RhdGVtZW50XG4gICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgaWYgKE5vZGUuaXNJZGVudGlmaWVyTm9kZShub2RlKSAmJiAhTm9kZS5pc01lbWJlckV4cHJlc3Npb25Ob2RlKHBhcmVudE5vZGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIG5vZGUubmFtZSA9IHRoaXMucmFuZG9tR2VuZXJhdG9yLmdldFJhbmRvbVZhcmlhYmxlTmFtZSg2KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKCFpc1ZhbGlkQmxvY2tTdGF0ZW1lbnROb2RlKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb2xsZWN0ZWRCbG9ja1N0YXRlbWVudHMucHVzaChjbG9uZWRCbG9ja1N0YXRlbWVudE5vZGUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7QmxvY2tTdGF0ZW1lbnR9IGJsb2NrU3RhdGVtZW50Tm9kZVxuICAgICAqIEBwYXJhbSB7QmxvY2tTdGF0ZW1lbnR9IHJhbmRvbUJsb2NrU3RhdGVtZW50Tm9kZVxuICAgICAqIEByZXR1cm5zIHtCbG9ja1N0YXRlbWVudH1cbiAgICAgKi9cbiAgICBwcml2YXRlIHJlcGxhY2VCbG9ja1N0YXRlbWVudE5vZGUgKFxuICAgICAgICBibG9ja1N0YXRlbWVudE5vZGU6IEVTVHJlZS5CbG9ja1N0YXRlbWVudCxcbiAgICAgICAgcmFuZG9tQmxvY2tTdGF0ZW1lbnROb2RlOiBFU1RyZWUuQmxvY2tTdGF0ZW1lbnRcbiAgICApOiBFU1RyZWUuQmxvY2tTdGF0ZW1lbnQge1xuICAgICAgICBjb25zdCByYW5kb20xOiBib29sZWFuID0gdGhpcy5yYW5kb21HZW5lcmF0b3IuZ2V0TWF0aFJhbmRvbSgpID4gMC41O1xuICAgICAgICBjb25zdCByYW5kb20yOiBib29sZWFuID0gdGhpcy5yYW5kb21HZW5lcmF0b3IuZ2V0TWF0aFJhbmRvbSgpID4gMC41O1xuXG4gICAgICAgIGNvbnN0IG9wZXJhdG9yOiBFU1RyZWUuQmluYXJ5T3BlcmF0b3IgPSByYW5kb20xID8gJz09PScgOiAnIT09JztcbiAgICAgICAgY29uc3QgbGVmdFN0cmluZzogc3RyaW5nID0gdGhpcy5yYW5kb21HZW5lcmF0b3IuZ2V0UmFuZG9tU3RyaW5nKDMpO1xuICAgICAgICBjb25zdCByaWdodFN0cmluZzogc3RyaW5nID0gcmFuZG9tMiA/IGxlZnRTdHJpbmcgOiB0aGlzLnJhbmRvbUdlbmVyYXRvci5nZXRSYW5kb21TdHJpbmcoMyk7XG5cbiAgICAgICAgbGV0IGNvbnNlcXVlbnQ6IEVTVHJlZS5CbG9ja1N0YXRlbWVudCxcbiAgICAgICAgICAgIGFsdGVybmF0ZTogRVNUcmVlLkJsb2NrU3RhdGVtZW50O1xuXG4gICAgICAgIGlmICgocmFuZG9tMSAmJiByYW5kb20yKSB8fCAoIXJhbmRvbTEgJiYgIXJhbmRvbTIpKSB7XG4gICAgICAgICAgICBjb25zZXF1ZW50ID0gYmxvY2tTdGF0ZW1lbnROb2RlO1xuICAgICAgICAgICAgYWx0ZXJuYXRlID0gcmFuZG9tQmxvY2tTdGF0ZW1lbnROb2RlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc2VxdWVudCA9IHJhbmRvbUJsb2NrU3RhdGVtZW50Tm9kZTtcbiAgICAgICAgICAgIGFsdGVybmF0ZSA9IGJsb2NrU3RhdGVtZW50Tm9kZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBuZXdCbG9ja1N0YXRlbWVudE5vZGU6IEVTVHJlZS5CbG9ja1N0YXRlbWVudCA9IE5vZGVzLmdldEJsb2NrU3RhdGVtZW50Tm9kZShbXG4gICAgICAgICAgICBOb2Rlcy5nZXRJZlN0YXRlbWVudE5vZGUoXG4gICAgICAgICAgICAgICAgTm9kZXMuZ2V0QmluYXJ5RXhwcmVzc2lvbk5vZGUoXG4gICAgICAgICAgICAgICAgICAgIG9wZXJhdG9yLFxuICAgICAgICAgICAgICAgICAgICBOb2Rlcy5nZXRMaXRlcmFsTm9kZShsZWZ0U3RyaW5nKSxcbiAgICAgICAgICAgICAgICAgICAgTm9kZXMuZ2V0TGl0ZXJhbE5vZGUocmlnaHRTdHJpbmcpXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICBjb25zZXF1ZW50LFxuICAgICAgICAgICAgICAgIGFsdGVybmF0ZVxuICAgICAgICAgICAgKVxuICAgICAgICBdKTtcblxuICAgICAgICBuZXdCbG9ja1N0YXRlbWVudE5vZGUgPSBOb2RlVXRpbHMucGFyZW50aXplKG5ld0Jsb2NrU3RhdGVtZW50Tm9kZSk7XG5cbiAgICAgICAgcmV0dXJuIG5ld0Jsb2NrU3RhdGVtZW50Tm9kZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge1Byb2dyYW19IHByb2dyYW1Ob2RlXG4gICAgICovXG4gICAgcHJpdmF0ZSB0cmFuc2Zvcm1Qcm9ncmFtTm9kZSAocHJvZ3JhbU5vZGU6IEVTVHJlZS5Qcm9ncmFtKTogdm9pZCB7XG4gICAgICAgIGVzdHJhdmVyc2UudHJhdmVyc2UocHJvZ3JhbU5vZGUsIHtcbiAgICAgICAgICAgIGVudGVyOiAobm9kZTogRVNUcmVlLk5vZGUsIHBhcmVudE5vZGU6IEVTVHJlZS5Ob2RlKTogYW55ID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIU5vZGUuaXNCbG9ja1N0YXRlbWVudE5vZGUobm9kZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHRoaXMuY29sbGVjdEJsb2NrU3RhdGVtZW50Tm9kZXMobm9kZSwgdGhpcy5jb2xsZWN0ZWRCbG9ja1N0YXRlbWVudHMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAodGhpcy5jb2xsZWN0ZWRCbG9ja1N0YXRlbWVudHMubGVuZ3RoIDwgRGVhZENvZGVJbmplY3Rpb25UcmFuc2Zvcm1lci5taW5Db2xsZWN0ZWRCbG9ja1N0YXRlbWVudHNDb3VudCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgZXN0cmF2ZXJzZS5yZXBsYWNlKHByb2dyYW1Ob2RlLCB7XG4gICAgICAgICAgICBsZWF2ZTogKG5vZGU6IEVTVHJlZS5Ob2RlLCBwYXJlbnROb2RlOiBFU1RyZWUuTm9kZSk6IGFueSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmNvbGxlY3RlZEJsb2NrU3RhdGVtZW50cy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVzdHJhdmVyc2UuVmlzaXRvck9wdGlvbi5CcmVhaztcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgICAgICFOb2RlLmlzQmxvY2tTdGF0ZW1lbnROb2RlKG5vZGUpIHx8XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmFuZG9tR2VuZXJhdG9yLmdldE1hdGhSYW5kb20oKSA+IHRoaXMub3B0aW9ucy5kZWFkQ29kZUluamVjdGlvblRocmVzaG9sZFxuICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCBtaW5JbnRlZ2VyOiBudW1iZXIgPSAwO1xuICAgICAgICAgICAgICAgIGNvbnN0IG1heEludGVnZXI6IG51bWJlciA9IHRoaXMuY29sbGVjdGVkQmxvY2tTdGF0ZW1lbnRzLmxlbmd0aCAtIDE7XG4gICAgICAgICAgICAgICAgY29uc3QgcmFuZG9tSW5kZXg6IG51bWJlciA9IHRoaXMucmFuZG9tR2VuZXJhdG9yLmdldFJhbmRvbUludGVnZXIobWluSW50ZWdlciwgbWF4SW50ZWdlcik7XG4gICAgICAgICAgICAgICAgY29uc3QgcmFuZG9tQmxvY2tTdGF0ZW1lbnROb2RlOiBFU1RyZWUuQmxvY2tTdGF0ZW1lbnQgPSB0aGlzLmNvbGxlY3RlZEJsb2NrU3RhdGVtZW50cy5zcGxpY2UocmFuZG9tSW5kZXgsIDEpWzBdO1xuXG4gICAgICAgICAgICAgICAgaWYgKHJhbmRvbUJsb2NrU3RhdGVtZW50Tm9kZSA9PT0gbm9kZSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5yZXBsYWNlQmxvY2tTdGF0ZW1lbnROb2RlKG5vZGUsIHJhbmRvbUJsb2NrU3RhdGVtZW50Tm9kZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==