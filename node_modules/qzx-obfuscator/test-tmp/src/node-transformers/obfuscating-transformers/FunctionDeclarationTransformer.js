"use strict";

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var inversify_1 = require("inversify");
var ServiceIdentifiers_1 = require("../../container/ServiceIdentifiers");
var estraverse = require("estraverse");
var IdentifierObfuscatingReplacer_1 = require("../../enums/container/node-transformers/IdentifierObfuscatingReplacer");
var NodeType_1 = require("../../enums/NodeType");
var AbstractNodeTransformer_1 = require("../AbstractNodeTransformer");
var Node_1 = require("../../node/Node");
var NodeUtils_1 = require("../../node/NodeUtils");
var FunctionDeclarationTransformer = function (_AbstractNodeTransfor) {
    _inherits(FunctionDeclarationTransformer, _AbstractNodeTransfor);

    function FunctionDeclarationTransformer(identifierObfuscatingReplacerFactory, randomGenerator, options) {
        _classCallCheck(this, FunctionDeclarationTransformer);

        var _this = _possibleConstructorReturn(this, (FunctionDeclarationTransformer.__proto__ || Object.getPrototypeOf(FunctionDeclarationTransformer)).call(this, randomGenerator, options));

        _this.replaceableIdentifiers = new Map();
        _this.identifierObfuscatingReplacer = identifierObfuscatingReplacerFactory(IdentifierObfuscatingReplacer_1.IdentifierObfuscatingReplacer.BaseIdentifierObfuscatingReplacer);
        return _this;
    }

    _createClass(FunctionDeclarationTransformer, [{
        key: "getVisitor",
        value: function getVisitor() {
            var _this2 = this;

            return {
                enter: function enter(node, parentNode) {
                    if (Node_1.Node.isFunctionDeclarationNode(node)) {
                        return _this2.transformNode(node, parentNode);
                    }
                }
            };
        }
    }, {
        key: "transformNode",
        value: function transformNode(functionDeclarationNode, parentNode) {
            var nodeIdentifier = this.nodeIdentifier++;
            var blockScopeOfFunctionDeclarationNode = NodeUtils_1.NodeUtils.getBlockScopesOfNode(functionDeclarationNode)[0];
            if (blockScopeOfFunctionDeclarationNode.type === NodeType_1.NodeType.Program) {
                return functionDeclarationNode;
            }
            this.storeFunctionName(functionDeclarationNode, nodeIdentifier);
            if (this.replaceableIdentifiers.has(blockScopeOfFunctionDeclarationNode)) {
                this.replaceScopeCachedIdentifiers(blockScopeOfFunctionDeclarationNode, nodeIdentifier);
            } else {
                this.replaceScopeIdentifiers(blockScopeOfFunctionDeclarationNode, nodeIdentifier);
            }
            return functionDeclarationNode;
        }
    }, {
        key: "storeFunctionName",
        value: function storeFunctionName(functionDeclarationNode, nodeIdentifier) {
            this.identifierObfuscatingReplacer.storeNames(functionDeclarationNode.id.name, nodeIdentifier);
        }
    }, {
        key: "replaceScopeCachedIdentifiers",
        value: function replaceScopeCachedIdentifiers(scopeNode, nodeIdentifier) {
            var _this3 = this;

            var cachedReplaceableIdentifiers = this.replaceableIdentifiers.get(scopeNode);
            cachedReplaceableIdentifiers.forEach(function (replaceableIdentifier) {
                var newReplaceableIdentifier = _this3.identifierObfuscatingReplacer.replace(replaceableIdentifier.name, nodeIdentifier);
                replaceableIdentifier.name = newReplaceableIdentifier.name;
            });
        }
    }, {
        key: "replaceScopeIdentifiers",
        value: function replaceScopeIdentifiers(scopeNode, nodeIdentifier) {
            var _this4 = this;

            var storedReplaceableIdentifiers = [];
            estraverse.replace(scopeNode, {
                enter: function enter(node, parentNode) {
                    if (Node_1.Node.isReplaceableIdentifierNode(node, parentNode)) {
                        var newIdentifier = _this4.identifierObfuscatingReplacer.replace(node.name, nodeIdentifier);
                        var newIdentifierName = newIdentifier.name;
                        if (node.name !== newIdentifierName) {
                            node.name = newIdentifierName;
                        } else {
                            storedReplaceableIdentifiers.push(node);
                        }
                    }
                }
            });
            this.replaceableIdentifiers.set(scopeNode, storedReplaceableIdentifiers);
        }
    }]);

    return FunctionDeclarationTransformer;
}(AbstractNodeTransformer_1.AbstractNodeTransformer);
FunctionDeclarationTransformer = tslib_1.__decorate([inversify_1.injectable(), tslib_1.__param(0, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.Factory__IIdentifierObfuscatingReplacer)), tslib_1.__param(1, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.IRandomGenerator)), tslib_1.__param(2, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.IOptions)), tslib_1.__metadata("design:paramtypes", [Function, Object, Object])], FunctionDeclarationTransformer);
exports.FunctionDeclarationTransformer = FunctionDeclarationTransformer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRnVuY3Rpb25EZWNsYXJhdGlvblRyYW5zZm9ybWVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL25vZGUtdHJhbnNmb3JtZXJzL29iZnVzY2F0aW5nLXRyYW5zZm9ybWVycy9GdW5jdGlvbkRlY2xhcmF0aW9uVHJhbnNmb3JtZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQUEsMEJBQStDO0FBQy9DLG1DQUF3RTtBQUV4RSx5QkFBeUM7QUFXekMsOENBQXNIO0FBQ3RILHlCQUFnRDtBQUVoRCx3Q0FBcUU7QUFDckUscUJBQXVDO0FBQ3ZDLDBCQUFpRDtBQVlqRDtBQUFBLEFBQWEsQUFBOEIsQUFBQzs7QUFnQnhDLDRDQUVRLEFBQTJFLHNDQUNsQyxBQUFpQyxpQkFDekMsQUFBaUI7QUFFdEQsQUFBSzs7b0tBQUMsQUFBZSxpQkFBRSxBQUFPLEFBQUMsQUFBQzs7QUFibkIsY0FBc0IseUJBQTJDLElBQUksQUFBRyxBQUFFLEFBQUM7QUFleEYsQUFBSSxjQUFDLEFBQTZCLGdDQUFHLEFBQW9DLHFDQUNyRSxnQ0FBNkIsOEJBQUMsQUFBaUMsQUFDbEUsQUFBQyxBQUNOOztBQUFDLEFBS00sQUFBVTs7Ozs7OztBQUNiLEFBQU07QUFDRixBQUFLLHVCQUFFLGVBQUMsQUFBaUIsTUFBRSxBQUF1QjtBQUM5QyxBQUFFLEFBQUMsd0JBQUMsT0FBSSxLQUFDLEFBQXlCLDBCQUFDLEFBQUksQUFBQyxBQUFDLE9BQUMsQUFBQztBQUN2QyxBQUFNLCtCQUFDLEFBQUksT0FBQyxBQUFhLGNBQUMsQUFBSSxNQUFFLEFBQVUsQUFBQyxBQUFDLEFBQ2hEO0FBQUMsQUFDTDtBQUFDLEFBQ0osQUFBQyxBQUNOO0FBUFc7QUFPVixBQU9NLEFBQWE7OztzQ0FBRSxBQUFtRCx5QkFBRSxBQUF1QjtBQUM5RixnQkFBTSxBQUFjLGlCQUFXLEFBQUksS0FBQyxBQUFjLEFBQUUsQUFBQztBQUNyRCxnQkFBTSxBQUFtQyxz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QyxBQUFRLEFBQUMsa0ZBcEIvQixBQUE4QixBQWtIMUM7QUFsSFkseUNBQThCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaW5qZWN0YWJsZSwgaW5qZWN0IH0gZnJvbSAnaW52ZXJzaWZ5JztcbmltcG9ydCB7IFNlcnZpY2VJZGVudGlmaWVycyB9IGZyb20gJy4uLy4uL2NvbnRhaW5lci9TZXJ2aWNlSWRlbnRpZmllcnMnO1xuXG5pbXBvcnQgKiBhcyBlc3RyYXZlcnNlIGZyb20gJ2VzdHJhdmVyc2UnO1xuaW1wb3J0ICogYXMgRVNUcmVlIGZyb20gJ2VzdHJlZSc7XG5cbmltcG9ydCB7IFRJZGVudGlmaWVyT2JmdXNjYXRpbmdSZXBsYWNlckZhY3RvcnkgfSBmcm9tIFwiLi4vLi4vdHlwZXMvY29udGFpbmVyL25vZGUtdHJhbnNmb3JtZXJzL1RJZGVudGlmaWVyT2JmdXNjYXRpbmdSZXBsYWNlckZhY3RvcnlcIjtcbmltcG9ydCB7IFROb2RlV2l0aEJsb2NrU3RhdGVtZW50IH0gZnJvbSAnLi4vLi4vdHlwZXMvbm9kZS9UTm9kZVdpdGhCbG9ja1N0YXRlbWVudCc7XG5cbmltcG9ydCB7IElJZGVudGlmaWVyT2JmdXNjYXRpbmdSZXBsYWNlciB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvbm9kZS10cmFuc2Zvcm1lcnMvb2JmdXNjYXRpbmctdHJhbnNmb3JtZXJzL0lJZGVudGlmaWVyT2JmdXNjYXRpbmdSZXBsYWNlcic7XG5pbXBvcnQgeyBJT3B0aW9ucyB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvb3B0aW9ucy9JT3B0aW9ucyc7XG5pbXBvcnQgeyBJUmFuZG9tR2VuZXJhdG9yIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy91dGlscy9JUmFuZG9tR2VuZXJhdG9yJztcbmltcG9ydCB7IElWaXNpdG9yIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9JVmlzaXRvcic7XG5cbmltcG9ydCB7IElkZW50aWZpZXJPYmZ1c2NhdGluZ1JlcGxhY2VyIH0gZnJvbSBcIi4uLy4uL2VudW1zL2NvbnRhaW5lci9ub2RlLXRyYW5zZm9ybWVycy9JZGVudGlmaWVyT2JmdXNjYXRpbmdSZXBsYWNlclwiO1xuaW1wb3J0IHsgTm9kZVR5cGUgfSBmcm9tICcuLi8uLi9lbnVtcy9Ob2RlVHlwZSc7XG5cbmltcG9ydCB7IEFic3RyYWN0Tm9kZVRyYW5zZm9ybWVyIH0gZnJvbSAnLi4vQWJzdHJhY3ROb2RlVHJhbnNmb3JtZXInO1xuaW1wb3J0IHsgTm9kZSB9IGZyb20gJy4uLy4uL25vZGUvTm9kZSc7XG5pbXBvcnQgeyBOb2RlVXRpbHMgfSBmcm9tICcuLi8uLi9ub2RlL05vZGVVdGlscyc7XG5cbi8qKlxuICogcmVwbGFjZXM6XG4gKiAgICAgZnVuY3Rpb24gZm9vICgpIHsgLy8uLi4gfTtcbiAqICAgICBmb28oKTtcbiAqXG4gKiBvbjpcbiAqICAgICBmdW5jdGlvbiBfMHgxMmQ0NWYgKCkgeyAvLy4uLiB9O1xuICogICAgIF8weDEyZDQ1ZigpO1xuICovXG5AaW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRnVuY3Rpb25EZWNsYXJhdGlvblRyYW5zZm9ybWVyIGV4dGVuZHMgQWJzdHJhY3ROb2RlVHJhbnNmb3JtZXIge1xuICAgIC8qKlxuICAgICAqIEB0eXBlIHtJSWRlbnRpZmllck9iZnVzY2F0aW5nUmVwbGFjZXJ9XG4gICAgICovXG4gICAgcHJpdmF0ZSByZWFkb25seSBpZGVudGlmaWVyT2JmdXNjYXRpbmdSZXBsYWNlcjogSUlkZW50aWZpZXJPYmZ1c2NhdGluZ1JlcGxhY2VyO1xuXG4gICAgLyoqXG4gICAgICogQHR5cGUge01hcDxFU1RyZWUuTm9kZSwgRVNUcmVlLklkZW50aWZpZXJbXT59XG4gICAgICovXG4gICAgcHJpdmF0ZSByZWFkb25seSByZXBsYWNlYWJsZUlkZW50aWZpZXJzOiBNYXAgPEVTVHJlZS5Ob2RlLCBFU1RyZWUuSWRlbnRpZmllcltdPiA9IG5ldyBNYXAoKTtcblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7VElkZW50aWZpZXJPYmZ1c2NhdGluZ1JlcGxhY2VyRmFjdG9yeX0gaWRlbnRpZmllck9iZnVzY2F0aW5nUmVwbGFjZXJGYWN0b3J5XG4gICAgICogQHBhcmFtIHtJUmFuZG9tR2VuZXJhdG9yfSByYW5kb21HZW5lcmF0b3JcbiAgICAgKiBAcGFyYW0ge0lPcHRpb25zfSBvcHRpb25zXG4gICAgICovXG4gICAgY29uc3RydWN0b3IgKFxuICAgICAgICBAaW5qZWN0KFNlcnZpY2VJZGVudGlmaWVycy5GYWN0b3J5X19JSWRlbnRpZmllck9iZnVzY2F0aW5nUmVwbGFjZXIpXG4gICAgICAgICAgICBpZGVudGlmaWVyT2JmdXNjYXRpbmdSZXBsYWNlckZhY3Rvcnk6IFRJZGVudGlmaWVyT2JmdXNjYXRpbmdSZXBsYWNlckZhY3RvcnksXG4gICAgICAgIEBpbmplY3QoU2VydmljZUlkZW50aWZpZXJzLklSYW5kb21HZW5lcmF0b3IpIHJhbmRvbUdlbmVyYXRvcjogSVJhbmRvbUdlbmVyYXRvcixcbiAgICAgICAgQGluamVjdChTZXJ2aWNlSWRlbnRpZmllcnMuSU9wdGlvbnMpIG9wdGlvbnM6IElPcHRpb25zXG4gICAgKSB7XG4gICAgICAgIHN1cGVyKHJhbmRvbUdlbmVyYXRvciwgb3B0aW9ucyk7XG5cbiAgICAgICAgdGhpcy5pZGVudGlmaWVyT2JmdXNjYXRpbmdSZXBsYWNlciA9IGlkZW50aWZpZXJPYmZ1c2NhdGluZ1JlcGxhY2VyRmFjdG9yeShcbiAgICAgICAgICAgIElkZW50aWZpZXJPYmZ1c2NhdGluZ1JlcGxhY2VyLkJhc2VJZGVudGlmaWVyT2JmdXNjYXRpbmdSZXBsYWNlclxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEByZXR1cm4ge0lWaXNpdG9yfVxuICAgICAqL1xuICAgIHB1YmxpYyBnZXRWaXNpdG9yICgpOiBJVmlzaXRvciB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBlbnRlcjogKG5vZGU6IEVTVHJlZS5Ob2RlLCBwYXJlbnROb2RlOiBFU1RyZWUuTm9kZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChOb2RlLmlzRnVuY3Rpb25EZWNsYXJhdGlvbk5vZGUobm9kZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNmb3JtTm9kZShub2RlLCBwYXJlbnROb2RlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtGdW5jdGlvbkRlY2xhcmF0aW9ufSBmdW5jdGlvbkRlY2xhcmF0aW9uTm9kZVxuICAgICAqIEBwYXJhbSB7Tm9kZX0gcGFyZW50Tm9kZVxuICAgICAqIEByZXR1cm5zIHtOb2RlfVxuICAgICAqL1xuICAgIHB1YmxpYyB0cmFuc2Zvcm1Ob2RlIChmdW5jdGlvbkRlY2xhcmF0aW9uTm9kZTogRVNUcmVlLkZ1bmN0aW9uRGVjbGFyYXRpb24sIHBhcmVudE5vZGU6IEVTVHJlZS5Ob2RlKTogRVNUcmVlLk5vZGUge1xuICAgICAgICBjb25zdCBub2RlSWRlbnRpZmllcjogbnVtYmVyID0gdGhpcy5ub2RlSWRlbnRpZmllcisrO1xuICAgICAgICBjb25zdCBibG9ja1Njb3BlT2ZGdW5jdGlvbkRlY2xhcmF0aW9uTm9kZTogVE5vZGVXaXRoQmxvY2tTdGF0ZW1lbnQgPSBOb2RlVXRpbHNcbiAgICAgICAgICAgIC5nZXRCbG9ja1Njb3Blc09mTm9kZShmdW5jdGlvbkRlY2xhcmF0aW9uTm9kZSlbMF07XG5cbiAgICAgICAgaWYgKGJsb2NrU2NvcGVPZkZ1bmN0aW9uRGVjbGFyYXRpb25Ob2RlLnR5cGUgPT09IE5vZGVUeXBlLlByb2dyYW0pIHtcbiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbkRlY2xhcmF0aW9uTm9kZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc3RvcmVGdW5jdGlvbk5hbWUoZnVuY3Rpb25EZWNsYXJhdGlvbk5vZGUsIG5vZGVJZGVudGlmaWVyKTtcblxuICAgICAgICAvLyBjaGVjayBmb3IgY2FjaGVkIGlkZW50aWZpZXJzIGZvciBjdXJyZW50IHNjb3BlIG5vZGUuIElmIGV4aXN0IC0gbG9vcCB0aHJvdWdoIHRoZW0uXG4gICAgICAgIGlmICh0aGlzLnJlcGxhY2VhYmxlSWRlbnRpZmllcnMuaGFzKGJsb2NrU2NvcGVPZkZ1bmN0aW9uRGVjbGFyYXRpb25Ob2RlKSkge1xuICAgICAgICAgICAgdGhpcy5yZXBsYWNlU2NvcGVDYWNoZWRJZGVudGlmaWVycyhibG9ja1Njb3BlT2ZGdW5jdGlvbkRlY2xhcmF0aW9uTm9kZSwgbm9kZUlkZW50aWZpZXIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5yZXBsYWNlU2NvcGVJZGVudGlmaWVycyhibG9ja1Njb3BlT2ZGdW5jdGlvbkRlY2xhcmF0aW9uTm9kZSwgbm9kZUlkZW50aWZpZXIpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uRGVjbGFyYXRpb25Ob2RlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7RnVuY3Rpb25EZWNsYXJhdGlvbn0gZnVuY3Rpb25EZWNsYXJhdGlvbk5vZGVcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gbm9kZUlkZW50aWZpZXJcbiAgICAgKi9cbiAgICBwcml2YXRlIHN0b3JlRnVuY3Rpb25OYW1lIChmdW5jdGlvbkRlY2xhcmF0aW9uTm9kZTogRVNUcmVlLkZ1bmN0aW9uRGVjbGFyYXRpb24sIG5vZGVJZGVudGlmaWVyOiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5pZGVudGlmaWVyT2JmdXNjYXRpbmdSZXBsYWNlci5zdG9yZU5hbWVzKGZ1bmN0aW9uRGVjbGFyYXRpb25Ob2RlLmlkLm5hbWUsIG5vZGVJZGVudGlmaWVyKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge05vZGV9IHNjb3BlTm9kZVxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBub2RlSWRlbnRpZmllclxuICAgICAqL1xuICAgIHByaXZhdGUgcmVwbGFjZVNjb3BlQ2FjaGVkSWRlbnRpZmllcnMgKHNjb3BlTm9kZTogRVNUcmVlLk5vZGUsIG5vZGVJZGVudGlmaWVyOiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgY2FjaGVkUmVwbGFjZWFibGVJZGVudGlmaWVyczogRVNUcmVlLklkZW50aWZpZXJbXSA9IDxFU1RyZWUuSWRlbnRpZmllcltdPnRoaXMucmVwbGFjZWFibGVJZGVudGlmaWVycy5nZXQoc2NvcGVOb2RlKTtcblxuICAgICAgICBjYWNoZWRSZXBsYWNlYWJsZUlkZW50aWZpZXJzLmZvckVhY2goKHJlcGxhY2VhYmxlSWRlbnRpZmllcjogRVNUcmVlLklkZW50aWZpZXIpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG5ld1JlcGxhY2VhYmxlSWRlbnRpZmllcjogRVNUcmVlLklkZW50aWZpZXIgPSB0aGlzLmlkZW50aWZpZXJPYmZ1c2NhdGluZ1JlcGxhY2VyLnJlcGxhY2UocmVwbGFjZWFibGVJZGVudGlmaWVyLm5hbWUsIG5vZGVJZGVudGlmaWVyKTtcblxuICAgICAgICAgICAgcmVwbGFjZWFibGVJZGVudGlmaWVyLm5hbWUgPSBuZXdSZXBsYWNlYWJsZUlkZW50aWZpZXIubmFtZTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtOb2RlfSBzY29wZU5vZGVcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gbm9kZUlkZW50aWZpZXJcbiAgICAgKi9cbiAgICBwcml2YXRlIHJlcGxhY2VTY29wZUlkZW50aWZpZXJzIChzY29wZU5vZGU6IEVTVHJlZS5Ob2RlLCBub2RlSWRlbnRpZmllcjogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHN0b3JlZFJlcGxhY2VhYmxlSWRlbnRpZmllcnM6IEVTVHJlZS5JZGVudGlmaWVyW10gPSBbXTtcblxuICAgICAgICBlc3RyYXZlcnNlLnJlcGxhY2Uoc2NvcGVOb2RlLCB7XG4gICAgICAgICAgICBlbnRlcjogKG5vZGU6IEVTVHJlZS5Ob2RlLCBwYXJlbnROb2RlOiBFU1RyZWUuTm9kZSk6IGFueSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKE5vZGUuaXNSZXBsYWNlYWJsZUlkZW50aWZpZXJOb2RlKG5vZGUsIHBhcmVudE5vZGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld0lkZW50aWZpZXI6IEVTVHJlZS5JZGVudGlmaWVyID0gdGhpcy5pZGVudGlmaWVyT2JmdXNjYXRpbmdSZXBsYWNlci5yZXBsYWNlKG5vZGUubmFtZSwgbm9kZUlkZW50aWZpZXIpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdJZGVudGlmaWVyTmFtZTogc3RyaW5nID0gbmV3SWRlbnRpZmllci5uYW1lO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChub2RlLm5hbWUgIT09IG5ld0lkZW50aWZpZXJOYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlLm5hbWUgPSBuZXdJZGVudGlmaWVyTmFtZTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0b3JlZFJlcGxhY2VhYmxlSWRlbnRpZmllcnMucHVzaChub2RlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5yZXBsYWNlYWJsZUlkZW50aWZpZXJzLnNldChzY29wZU5vZGUsIHN0b3JlZFJlcGxhY2VhYmxlSWRlbnRpZmllcnMpO1xuICAgIH1cbn1cbiJdfQ==