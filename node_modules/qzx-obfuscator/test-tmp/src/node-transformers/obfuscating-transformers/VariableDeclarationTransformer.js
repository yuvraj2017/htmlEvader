"use strict";

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var inversify_1 = require("inversify");
var ServiceIdentifiers_1 = require("../../container/ServiceIdentifiers");
var estraverse = require("estraverse");
var IdentifierObfuscatingReplacer_1 = require("../../enums/container/node-transformers/IdentifierObfuscatingReplacer");
var NodeType_1 = require("../../enums/NodeType");
var AbstractNodeTransformer_1 = require("../AbstractNodeTransformer");
var Node_1 = require("../../node/Node");
var NodeUtils_1 = require("../../node/NodeUtils");
var VariableDeclarationTransformer = function (_AbstractNodeTransfor) {
    _inherits(VariableDeclarationTransformer, _AbstractNodeTransfor);

    function VariableDeclarationTransformer(identifierObfuscatingReplacerFactory, randomGenerator, options) {
        _classCallCheck(this, VariableDeclarationTransformer);

        var _this = _possibleConstructorReturn(this, (VariableDeclarationTransformer.__proto__ || Object.getPrototypeOf(VariableDeclarationTransformer)).call(this, randomGenerator, options));

        _this.replaceableIdentifiers = new Map();
        _this.identifierObfuscatingReplacer = identifierObfuscatingReplacerFactory(IdentifierObfuscatingReplacer_1.IdentifierObfuscatingReplacer.BaseIdentifierObfuscatingReplacer);
        return _this;
    }

    _createClass(VariableDeclarationTransformer, [{
        key: "getVisitor",
        value: function getVisitor() {
            var _this2 = this;

            return {
                enter: function enter(node, parentNode) {
                    if (Node_1.Node.isVariableDeclarationNode(node)) {
                        return _this2.transformNode(node, parentNode);
                    }
                }
            };
        }
    }, {
        key: "transformNode",
        value: function transformNode(variableDeclarationNode, parentNode) {
            var blockScopeOfVariableDeclarationNode = NodeUtils_1.NodeUtils.getBlockScopesOfNode(variableDeclarationNode)[0];
            if (blockScopeOfVariableDeclarationNode.type === NodeType_1.NodeType.Program) {
                return variableDeclarationNode;
            }
            var nodeIdentifier = this.nodeIdentifier++;
            var scopeNode = variableDeclarationNode.kind === 'var' ? blockScopeOfVariableDeclarationNode : parentNode;
            this.storeVariableNames(variableDeclarationNode, nodeIdentifier);
            if (this.replaceableIdentifiers.has(scopeNode)) {
                this.replaceScopeCachedIdentifiers(scopeNode, nodeIdentifier);
            } else {
                this.replaceScopeIdentifiers(scopeNode, nodeIdentifier);
            }
            return variableDeclarationNode;
        }
    }, {
        key: "storeVariableNames",
        value: function storeVariableNames(variableDeclarationNode, nodeIdentifier) {
            var _this3 = this;

            variableDeclarationNode.declarations.forEach(function (declarationNode) {
                if (Node_1.Node.isObjectPatternNode(declarationNode.id)) {
                    return estraverse.VisitorOption.Skip;
                }
                NodeUtils_1.NodeUtils.typedTraverse(declarationNode.id, NodeType_1.NodeType.Identifier, {
                    enter: function enter(node) {
                        return _this3.identifierObfuscatingReplacer.storeNames(node.name, nodeIdentifier);
                    }
                });
            });
        }
    }, {
        key: "replaceScopeCachedIdentifiers",
        value: function replaceScopeCachedIdentifiers(scopeNode, nodeIdentifier) {
            var _this4 = this;

            var cachedReplaceableIdentifiers = this.replaceableIdentifiers.get(scopeNode);
            cachedReplaceableIdentifiers.forEach(function (replaceableIdentifier) {
                var newReplaceableIdentifier = _this4.identifierObfuscatingReplacer.replace(replaceableIdentifier.name, nodeIdentifier);
                replaceableIdentifier.name = newReplaceableIdentifier.name;
            });
        }
    }, {
        key: "replaceScopeIdentifiers",
        value: function replaceScopeIdentifiers(scopeNode, nodeIdentifier) {
            var _this5 = this;

            var storedReplaceableIdentifiers = [];
            estraverse.replace(scopeNode, {
                enter: function enter(node, parentNode) {
                    if (!node.obfuscatedNode && Node_1.Node.isReplaceableIdentifierNode(node, parentNode)) {
                        var newIdentifier = _this5.identifierObfuscatingReplacer.replace(node.name, nodeIdentifier);
                        var newIdentifierName = newIdentifier.name;
                        if (node.name !== newIdentifierName) {
                            node.name = newIdentifierName;
                        } else {
                            storedReplaceableIdentifiers.push(node);
                        }
                    }
                }
            });
            this.replaceableIdentifiers.set(scopeNode, storedReplaceableIdentifiers);
        }
    }]);

    return VariableDeclarationTransformer;
}(AbstractNodeTransformer_1.AbstractNodeTransformer);
VariableDeclarationTransformer = tslib_1.__decorate([inversify_1.injectable(), tslib_1.__param(0, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.Factory__IIdentifierObfuscatingReplacer)), tslib_1.__param(1, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.IRandomGenerator)), tslib_1.__param(2, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.IOptions)), tslib_1.__metadata("design:paramtypes", [Function, Object, Object])], VariableDeclarationTransformer);
exports.VariableDeclarationTransformer = VariableDeclarationTransformer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVmFyaWFibGVEZWNsYXJhdGlvblRyYW5zZm9ybWVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL25vZGUtdHJhbnNmb3JtZXJzL29iZnVzY2F0aW5nLXRyYW5zZm9ybWVycy9WYXJpYWJsZURlY2xhcmF0aW9uVHJhbnNmb3JtZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQUEsMEJBQStDO0FBQy9DLG1DQUF3RTtBQUV4RSx5QkFBeUM7QUFXekMsOENBQXNIO0FBQ3RILHlCQUFnRDtBQUVoRCx3Q0FBcUU7QUFDckUscUJBQXVDO0FBQ3ZDLDBCQUFpRDtBQWFqRDtBQUFBLEFBQWEsQUFBOEIsQUFBQzs7QUFnQnhDLDRDQUVRLEFBQTJFLHNDQUNsQyxBQUFpQyxpQkFDekMsQUFBaUI7QUFFdEQsQUFBSzs7b0tBQUMsQUFBZSxpQkFBRSxBQUFPLEFBQUMsQUFBQzs7QUFibkIsY0FBc0IseUJBQTJDLElBQUksQUFBRyxBQUFFLEFBQUM7QUFleEYsQUFBSSxjQUFDLEFBQTZCLGdDQUFHLEFBQW9DLHFDQUNyRSxnQ0FBNkIsOEJBQUMsQUFBaUMsQUFDbEUsQUFBQyxBQUNOOztBQUFDLEFBS00sQUFBVTs7Ozs7OztBQUNiLEFBQU07QUFDRixBQUFLLHVCQUFFLGVBQUMsQUFBaUIsTUFBRSxBQUF1QjtBQUM5QyxBQUFFLEFBQUMsd0JBQUMsT0FBSSxLQUFDLEFBQXlCLDBCQUFDLEFBQUksQUFBQyxBQUFDLE9BQUMsQUFBQztBQUN2QyxBQUFNLCtCQUFDLEFBQUksT0FBQyxBQUFhLGNBQUMsQUFBSSxNQUFFLEFBQVUsQUFBQyxBQUFDLEFBQ2hEO0FBQUMsQUFDTDtBQUFDLEFBQ0osQUFBQyxBQUNOO0FBUFc7QUFPVixBQU9NLEFBQWE7OztzQ0FBRSxBQUFtRCx5QkFBRSxBQUF1QjtBQUM5RixnQkFBTSxBQUFtQyxzQ0FBNEIsWUFBUyxVQUN6RSxBQUFvQixxQkFBQyxBQUF1QixBQUFDLHlCQUFDLEFB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Q0FBQyxBQUFJLE9BQUcsQUFBaUIsQUFBQyxBQUNsQztBQUFDLEFBQUMsQUFBSSwrQkFBQyxBQUFDO0FBQ0osQUFBNEIseURBQUMsQUFBSSxLQUFDLEFBQUksQUFBQyxBQUFDLEFBQzVDO0FBQUMsQUFDTDtBQUFDLEFBQ0w7QUFBQyxBQUNKLEFBQUMsQUFBQztBQWIyQjtBQWU5QixBQUFJLGlCQUFDLEFBQXNCLHVCQUFDLEFBQUcsSUFBQyxBQUFTLFdBQUUsQUFBNEIsQUFBQyxBQUFDLEFBQzdFO0FBQUMsQUFDSjs7OztFQS9IbUQsMEJBQXVCO0FBQTlELEFBQThCLHFEQUQxQyxZQUFVLEFBQUUsY0FrQkosbUJBQUEsWUFBTSxPQUFDLHFCQUFrQixtQkFBQyxBQUF1QyxBQUFDLDJDQUVsRSxtQkFBQSxZQUFNLE9BQUMscUJBQWtCLG1CQUFDLEFBQWdCLEFBQUMsb0JBQzNDLG1CQUFBLFlBQU0sT0FBQyxxQkFBa0IsbUJBQUMsQUFBUSxBQUFDLGtGQXBCL0IsQUFBOEIsQUErSDFDO0FBL0hZLHlDQUE4QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGluamVjdGFibGUsIGluamVjdCB9IGZyb20gJ2ludmVyc2lmeSc7XG5pbXBvcnQgeyBTZXJ2aWNlSWRlbnRpZmllcnMgfSBmcm9tICcuLi8uLi9jb250YWluZXIvU2VydmljZUlkZW50aWZpZXJzJztcblxuaW1wb3J0ICogYXMgZXN0cmF2ZXJzZSBmcm9tICdlc3RyYXZlcnNlJztcbmltcG9ydCAqIGFzIEVTVHJlZSBmcm9tICdlc3RyZWUnO1xuXG5pbXBvcnQgeyBUSWRlbnRpZmllck9iZnVzY2F0aW5nUmVwbGFjZXJGYWN0b3J5IH0gZnJvbSAnLi4vLi4vdHlwZXMvY29udGFpbmVyL25vZGUtdHJhbnNmb3JtZXJzL1RJZGVudGlmaWVyT2JmdXNjYXRpbmdSZXBsYWNlckZhY3RvcnknO1xuaW1wb3J0IHsgVE5vZGVXaXRoQmxvY2tTdGF0ZW1lbnQgfSBmcm9tICcuLi8uLi90eXBlcy9ub2RlL1ROb2RlV2l0aEJsb2NrU3RhdGVtZW50JztcblxuaW1wb3J0IHsgSUlkZW50aWZpZXJPYmZ1c2NhdGluZ1JlcGxhY2VyIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9ub2RlLXRyYW5zZm9ybWVycy9vYmZ1c2NhdGluZy10cmFuc2Zvcm1lcnMvSUlkZW50aWZpZXJPYmZ1c2NhdGluZ1JlcGxhY2VyJztcbmltcG9ydCB7IElPcHRpb25zIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9vcHRpb25zL0lPcHRpb25zJztcbmltcG9ydCB7IElSYW5kb21HZW5lcmF0b3IgfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL3V0aWxzL0lSYW5kb21HZW5lcmF0b3InO1xuaW1wb3J0IHsgSVZpc2l0b3IgfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL0lWaXNpdG9yJztcblxuaW1wb3J0IHsgSWRlbnRpZmllck9iZnVzY2F0aW5nUmVwbGFjZXIgfSBmcm9tIFwiLi4vLi4vZW51bXMvY29udGFpbmVyL25vZGUtdHJhbnNmb3JtZXJzL0lkZW50aWZpZXJPYmZ1c2NhdGluZ1JlcGxhY2VyXCI7XG5pbXBvcnQgeyBOb2RlVHlwZSB9IGZyb20gJy4uLy4uL2VudW1zL05vZGVUeXBlJztcblxuaW1wb3J0IHsgQWJzdHJhY3ROb2RlVHJhbnNmb3JtZXIgfSBmcm9tICcuLi9BYnN0cmFjdE5vZGVUcmFuc2Zvcm1lcic7XG5pbXBvcnQgeyBOb2RlIH0gZnJvbSAnLi4vLi4vbm9kZS9Ob2RlJztcbmltcG9ydCB7IE5vZGVVdGlscyB9IGZyb20gJy4uLy4uL25vZGUvTm9kZVV0aWxzJztcblxuLyoqXG4gKiByZXBsYWNlczpcbiAqICAgICB2YXIgdmFyaWFibGUgPSAxO1xuICogICAgIHZhcmlhYmxlKys7XG4gKlxuICogb246XG4gKiAgICAgdmFyIF8weDEyZDQ1ZiA9IDE7XG4gKiAgICAgXzB4MTJkNDVmKys7XG4gKlxuICovXG5AaW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgVmFyaWFibGVEZWNsYXJhdGlvblRyYW5zZm9ybWVyIGV4dGVuZHMgQWJzdHJhY3ROb2RlVHJhbnNmb3JtZXIge1xuICAgIC8qKlxuICAgICAqIEB0eXBlIHtJSWRlbnRpZmllck9iZnVzY2F0aW5nUmVwbGFjZXJ9XG4gICAgICovXG4gICAgcHJpdmF0ZSByZWFkb25seSBpZGVudGlmaWVyT2JmdXNjYXRpbmdSZXBsYWNlcjogSUlkZW50aWZpZXJPYmZ1c2NhdGluZ1JlcGxhY2VyO1xuXG4gICAgLyoqXG4gICAgICogQHR5cGUge01hcDxFU1RyZWUuTm9kZSwgRVNUcmVlLklkZW50aWZpZXJbXT59XG4gICAgICovXG4gICAgcHJpdmF0ZSByZWFkb25seSByZXBsYWNlYWJsZUlkZW50aWZpZXJzOiBNYXAgPEVTVHJlZS5Ob2RlLCBFU1RyZWUuSWRlbnRpZmllcltdPiA9IG5ldyBNYXAoKTtcblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7VElkZW50aWZpZXJPYmZ1c2NhdGluZ1JlcGxhY2VyRmFjdG9yeX0gaWRlbnRpZmllck9iZnVzY2F0aW5nUmVwbGFjZXJGYWN0b3J5XG4gICAgICogQHBhcmFtIHtJUmFuZG9tR2VuZXJhdG9yfSByYW5kb21HZW5lcmF0b3JcbiAgICAgKiBAcGFyYW0ge0lPcHRpb25zfSBvcHRpb25zXG4gICAgICovXG4gICAgY29uc3RydWN0b3IgKFxuICAgICAgICBAaW5qZWN0KFNlcnZpY2VJZGVudGlmaWVycy5GYWN0b3J5X19JSWRlbnRpZmllck9iZnVzY2F0aW5nUmVwbGFjZXIpXG4gICAgICAgICAgICBpZGVudGlmaWVyT2JmdXNjYXRpbmdSZXBsYWNlckZhY3Rvcnk6IFRJZGVudGlmaWVyT2JmdXNjYXRpbmdSZXBsYWNlckZhY3RvcnksXG4gICAgICAgIEBpbmplY3QoU2VydmljZUlkZW50aWZpZXJzLklSYW5kb21HZW5lcmF0b3IpIHJhbmRvbUdlbmVyYXRvcjogSVJhbmRvbUdlbmVyYXRvcixcbiAgICAgICAgQGluamVjdChTZXJ2aWNlSWRlbnRpZmllcnMuSU9wdGlvbnMpIG9wdGlvbnM6IElPcHRpb25zXG4gICAgKSB7XG4gICAgICAgIHN1cGVyKHJhbmRvbUdlbmVyYXRvciwgb3B0aW9ucyk7XG5cbiAgICAgICAgdGhpcy5pZGVudGlmaWVyT2JmdXNjYXRpbmdSZXBsYWNlciA9IGlkZW50aWZpZXJPYmZ1c2NhdGluZ1JlcGxhY2VyRmFjdG9yeShcbiAgICAgICAgICAgIElkZW50aWZpZXJPYmZ1c2NhdGluZ1JlcGxhY2VyLkJhc2VJZGVudGlmaWVyT2JmdXNjYXRpbmdSZXBsYWNlclxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEByZXR1cm4ge0lWaXNpdG9yfVxuICAgICAqL1xuICAgIHB1YmxpYyBnZXRWaXNpdG9yICgpOiBJVmlzaXRvciB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBlbnRlcjogKG5vZGU6IEVTVHJlZS5Ob2RlLCBwYXJlbnROb2RlOiBFU1RyZWUuTm9kZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChOb2RlLmlzVmFyaWFibGVEZWNsYXJhdGlvbk5vZGUobm9kZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNmb3JtTm9kZShub2RlLCBwYXJlbnROb2RlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtWYXJpYWJsZURlY2xhcmF0aW9ufSB2YXJpYWJsZURlY2xhcmF0aW9uTm9kZVxuICAgICAqIEBwYXJhbSB7Tm9kZX0gcGFyZW50Tm9kZVxuICAgICAqIEByZXR1cm5zIHtOb2RlfVxuICAgICAqL1xuICAgIHB1YmxpYyB0cmFuc2Zvcm1Ob2RlICh2YXJpYWJsZURlY2xhcmF0aW9uTm9kZTogRVNUcmVlLlZhcmlhYmxlRGVjbGFyYXRpb24sIHBhcmVudE5vZGU6IEVTVHJlZS5Ob2RlKTogRVNUcmVlLk5vZGUge1xuICAgICAgICBjb25zdCBibG9ja1Njb3BlT2ZWYXJpYWJsZURlY2xhcmF0aW9uTm9kZTogVE5vZGVXaXRoQmxvY2tTdGF0ZW1lbnQgPSBOb2RlVXRpbHNcbiAgICAgICAgICAgIC5nZXRCbG9ja1Njb3Blc09mTm9kZSh2YXJpYWJsZURlY2xhcmF0aW9uTm9kZSlbMF07XG5cbiAgICAgICAgaWYgKGJsb2NrU2NvcGVPZlZhcmlhYmxlRGVjbGFyYXRpb25Ob2RlLnR5cGUgPT09IE5vZGVUeXBlLlByb2dyYW0pIHtcbiAgICAgICAgICAgIHJldHVybiB2YXJpYWJsZURlY2xhcmF0aW9uTm9kZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG5vZGVJZGVudGlmaWVyOiBudW1iZXIgPSB0aGlzLm5vZGVJZGVudGlmaWVyKys7XG4gICAgICAgIGNvbnN0IHNjb3BlTm9kZTogRVNUcmVlLk5vZGUgPSB2YXJpYWJsZURlY2xhcmF0aW9uTm9kZS5raW5kID09PSAndmFyJ1xuICAgICAgICAgICAgPyBibG9ja1Njb3BlT2ZWYXJpYWJsZURlY2xhcmF0aW9uTm9kZVxuICAgICAgICAgICAgOiBwYXJlbnROb2RlO1xuXG4gICAgICAgIHRoaXMuc3RvcmVWYXJpYWJsZU5hbWVzKHZhcmlhYmxlRGVjbGFyYXRpb25Ob2RlLCBub2RlSWRlbnRpZmllcik7XG5cbiAgICAgICAgLy8gY2hlY2sgZm9yIGNhY2hlZCBpZGVudGlmaWVycyBmb3IgY3VycmVudCBzY29wZSBub2RlLiBJZiBleGlzdCAtIGxvb3AgdGhyb3VnaCB0aGVtLlxuICAgICAgICBpZiAodGhpcy5yZXBsYWNlYWJsZUlkZW50aWZpZXJzLmhhcyhzY29wZU5vZGUpKSB7XG4gICAgICAgICAgICB0aGlzLnJlcGxhY2VTY29wZUNhY2hlZElkZW50aWZpZXJzKHNjb3BlTm9kZSwgbm9kZUlkZW50aWZpZXIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5yZXBsYWNlU2NvcGVJZGVudGlmaWVycyhzY29wZU5vZGUsIG5vZGVJZGVudGlmaWVyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB2YXJpYWJsZURlY2xhcmF0aW9uTm9kZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge1ZhcmlhYmxlRGVjbGFyYXRpb259IHZhcmlhYmxlRGVjbGFyYXRpb25Ob2RlXG4gICAgICogQHBhcmFtIHtudW1iZXJ9IG5vZGVJZGVudGlmaWVyXG4gICAgICovXG4gICAgcHJpdmF0ZSBzdG9yZVZhcmlhYmxlTmFtZXMgKHZhcmlhYmxlRGVjbGFyYXRpb25Ob2RlOiBFU1RyZWUuVmFyaWFibGVEZWNsYXJhdGlvbiwgbm9kZUlkZW50aWZpZXI6IG51bWJlcik6IHZvaWQge1xuICAgICAgICB2YXJpYWJsZURlY2xhcmF0aW9uTm9kZS5kZWNsYXJhdGlvbnNcbiAgICAgICAgICAgIC5mb3JFYWNoKChkZWNsYXJhdGlvbk5vZGU6IEVTVHJlZS5WYXJpYWJsZURlY2xhcmF0b3IpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoTm9kZS5pc09iamVjdFBhdHRlcm5Ob2RlKGRlY2xhcmF0aW9uTm9kZS5pZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVzdHJhdmVyc2UuVmlzaXRvck9wdGlvbi5Ta2lwO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIE5vZGVVdGlscy50eXBlZFRyYXZlcnNlKGRlY2xhcmF0aW9uTm9kZS5pZCwgTm9kZVR5cGUuSWRlbnRpZmllciwge1xuICAgICAgICAgICAgICAgICAgICBlbnRlcjogKG5vZGU6IEVTVHJlZS5JZGVudGlmaWVyKSA9PiB0aGlzLmlkZW50aWZpZXJPYmZ1c2NhdGluZ1JlcGxhY2VyLnN0b3JlTmFtZXMobm9kZS5uYW1lLCBub2RlSWRlbnRpZmllcilcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7Tm9kZX0gc2NvcGVOb2RlXG4gICAgICogQHBhcmFtIHtudW1iZXJ9IG5vZGVJZGVudGlmaWVyXG4gICAgICovXG4gICAgcHJpdmF0ZSByZXBsYWNlU2NvcGVDYWNoZWRJZGVudGlmaWVycyAoc2NvcGVOb2RlOiBFU1RyZWUuTm9kZSwgbm9kZUlkZW50aWZpZXI6IG51bWJlcik6IHZvaWQge1xuICAgICAgICBjb25zdCBjYWNoZWRSZXBsYWNlYWJsZUlkZW50aWZpZXJzOiBFU1RyZWUuSWRlbnRpZmllcltdID0gPEVTVHJlZS5JZGVudGlmaWVyW10+dGhpcy5yZXBsYWNlYWJsZUlkZW50aWZpZXJzLmdldChzY29wZU5vZGUpO1xuXG4gICAgICAgIGNhY2hlZFJlcGxhY2VhYmxlSWRlbnRpZmllcnMuZm9yRWFjaCgocmVwbGFjZWFibGVJZGVudGlmaWVyOiBFU1RyZWUuSWRlbnRpZmllcikgPT4ge1xuICAgICAgICAgICAgY29uc3QgbmV3UmVwbGFjZWFibGVJZGVudGlmaWVyOiBFU1RyZWUuSWRlbnRpZmllciA9IHRoaXMuaWRlbnRpZmllck9iZnVzY2F0aW5nUmVwbGFjZXIucmVwbGFjZShyZXBsYWNlYWJsZUlkZW50aWZpZXIubmFtZSwgbm9kZUlkZW50aWZpZXIpO1xuXG4gICAgICAgICAgICByZXBsYWNlYWJsZUlkZW50aWZpZXIubmFtZSA9IG5ld1JlcGxhY2VhYmxlSWRlbnRpZmllci5uYW1lO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge05vZGV9IHNjb3BlTm9kZVxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBub2RlSWRlbnRpZmllclxuICAgICAqL1xuICAgIHByaXZhdGUgcmVwbGFjZVNjb3BlSWRlbnRpZmllcnMgKHNjb3BlTm9kZTogRVNUcmVlLk5vZGUsIG5vZGVJZGVudGlmaWVyOiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgY29uc3Qgc3RvcmVkUmVwbGFjZWFibGVJZGVudGlmaWVyczogRVNUcmVlLklkZW50aWZpZXJbXSA9IFtdO1xuXG4gICAgICAgIGVzdHJhdmVyc2UucmVwbGFjZShzY29wZU5vZGUsIHtcbiAgICAgICAgICAgIGVudGVyOiAobm9kZTogRVNUcmVlLk5vZGUsIHBhcmVudE5vZGU6IEVTVHJlZS5Ob2RlKTogYW55ID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIW5vZGUub2JmdXNjYXRlZE5vZGUgJiYgTm9kZS5pc1JlcGxhY2VhYmxlSWRlbnRpZmllck5vZGUobm9kZSwgcGFyZW50Tm9kZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV3SWRlbnRpZmllcjogRVNUcmVlLklkZW50aWZpZXIgPSB0aGlzLmlkZW50aWZpZXJPYmZ1c2NhdGluZ1JlcGxhY2VyLnJlcGxhY2Uobm9kZS5uYW1lLCBub2RlSWRlbnRpZmllcik7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld0lkZW50aWZpZXJOYW1lOiBzdHJpbmcgPSBuZXdJZGVudGlmaWVyLm5hbWU7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubmFtZSAhPT0gbmV3SWRlbnRpZmllck5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubmFtZSA9IG5ld0lkZW50aWZpZXJOYW1lO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RvcmVkUmVwbGFjZWFibGVJZGVudGlmaWVycy5wdXNoKG5vZGUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnJlcGxhY2VhYmxlSWRlbnRpZmllcnMuc2V0KHNjb3BlTm9kZSwgc3RvcmVkUmVwbGFjZWFibGVJZGVudGlmaWVycyk7XG4gICAgfVxufVxuIl19