"use strict";

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var inversify_1 = require("inversify");
var ServiceIdentifiers_1 = require("../../../../container/ServiceIdentifiers");
var StringArrayEncoding_1 = require("../../../../enums/StringArrayEncoding");
var AbstractObfuscatingReplacer_1 = require("../AbstractObfuscatingReplacer");
var Nodes_1 = require("../../../../node/Nodes");
var Utils_1 = require("../../../../utils/Utils");
var StringLiteralObfuscatingReplacer = StringLiteralObfuscatingReplacer_1 = function (_AbstractObfuscatingR) {
    _inherits(StringLiteralObfuscatingReplacer, _AbstractObfuscatingR);

    function StringLiteralObfuscatingReplacer(customNodeGroupStorage, stringArrayStorage, escapeSequenceEncoder, randomGenerator, cryptUtils, options) {
        _classCallCheck(this, StringLiteralObfuscatingReplacer);

        var _this = _possibleConstructorReturn(this, (StringLiteralObfuscatingReplacer.__proto__ || Object.getPrototypeOf(StringLiteralObfuscatingReplacer)).call(this, options));

        _this.nodesCache = new Map();
        _this.stringLiteralHexadecimalIndexCache = new Map();
        _this.customNodeGroupStorage = customNodeGroupStorage;
        _this.stringArrayStorage = stringArrayStorage;
        _this.escapeSequenceEncoder = escapeSequenceEncoder;
        _this.randomGenerator = randomGenerator;
        _this.cryptUtils = cryptUtils;
        _this.rc4Keys = _this.randomGenerator.getRandomGenerator().n(function () {
            return _this.randomGenerator.getRandomGenerator().string({
                length: StringLiteralObfuscatingReplacer_1.rc4KeyLength
            });
        }, StringLiteralObfuscatingReplacer_1.rc4KeysCount);
        return _this;
    }

    _createClass(StringLiteralObfuscatingReplacer, [{
        key: "replace",
        value: function replace(nodeValue) {
            var useStringArray = this.canUseStringArray(nodeValue);
            var cacheKey = nodeValue + "-" + String(useStringArray);
            var useCacheValue = this.nodesCache.has(cacheKey) && this.options.stringArrayEncoding !== StringArrayEncoding_1.StringArrayEncoding.Rc4;
            if (useCacheValue) {
                return this.nodesCache.get(cacheKey);
            }
            var resultNode = useStringArray ? this.replaceWithStringArrayCallNode(nodeValue) : this.replaceWithLiteralNode(nodeValue);
            this.nodesCache.set(cacheKey, resultNode);
            return resultNode;
        }
    }, {
        key: "canUseStringArray",
        value: function canUseStringArray(nodeValue) {
            return this.options.stringArray && nodeValue.length >= StringLiteralObfuscatingReplacer_1.minimumLengthForStringArray && this.randomGenerator.getMathRandom() <= this.options.stringArrayThreshold;
        }
    }, {
        key: "getStringArrayHexadecimalIndex",
        value: function getStringArrayHexadecimalIndex(value, stringArrayStorageLength) {
            if (this.stringLiteralHexadecimalIndexCache.has(value)) {
                return {
                    fromCache: true,
                    index: this.stringLiteralHexadecimalIndexCache.get(value)
                };
            }
            var hexadecimalRawIndex = Utils_1.Utils.decToHex(stringArrayStorageLength);
            var hexadecimalIndex = "" + Utils_1.Utils.hexadecimalPrefix + hexadecimalRawIndex;
            this.stringLiteralHexadecimalIndexCache.set(value, hexadecimalIndex);
            return {
                fromCache: false,
                index: hexadecimalIndex
            };
        }
    }, {
        key: "getEncodedValue",
        value: function getEncodedValue(value) {
            var encodedValue = void 0,
                key = null;
            switch (this.options.stringArrayEncoding) {
                case StringArrayEncoding_1.StringArrayEncoding.Rc4:
                    key = this.randomGenerator.getRandomGenerator().pickone(this.rc4Keys);
                    encodedValue = this.cryptUtils.btoa(this.cryptUtils.rc4(value, key));
                    break;
                case StringArrayEncoding_1.StringArrayEncoding.Base64:
                    encodedValue = this.cryptUtils.btoa(value);
                    break;
                default:
                    encodedValue = value;
            }
            return { encodedValue: encodedValue, key: key };
        }
    }, {
        key: "replaceWithLiteralNode",
        value: function replaceWithLiteralNode(value) {
            return Nodes_1.Nodes.getLiteralNode(this.escapeSequenceEncoder.encode(value, this.options.unicodeEscapeSequence));
        }
    }, {
        key: "replaceWithStringArrayCallNode",
        value: function replaceWithStringArrayCallNode(value) {
            var _getEncodedValue = this.getEncodedValue(value),
                encodedValue = _getEncodedValue.encodedValue,
                key = _getEncodedValue.key;

            var escapedValue = this.escapeSequenceEncoder.encode(encodedValue, this.options.unicodeEscapeSequence);
            var stringArrayStorageLength = this.stringArrayStorage.getLength();
            var rotatedStringArrayStorageId = Utils_1.Utils.stringRotate(this.stringArrayStorage.getStorageId(), 1);
            var stringArrayStorageCallsWrapperName = "_" + Utils_1.Utils.hexadecimalPrefix + rotatedStringArrayStorageId;

            var _getStringArrayHexade = this.getStringArrayHexadecimalIndex(escapedValue, stringArrayStorageLength),
                fromCache = _getStringArrayHexade.fromCache,
                index = _getStringArrayHexade.index;

            if (!fromCache) {
                this.stringArrayStorage.set(stringArrayStorageLength, escapedValue);
            }
            var callExpressionArgs = [StringLiteralObfuscatingReplacer_1.getHexadecimalLiteralNode(index)];
            if (key) {
                callExpressionArgs.push(StringLiteralObfuscatingReplacer_1.getRc4KeyLiteralNode(this.escapeSequenceEncoder.encode(key, this.options.unicodeEscapeSequence)));
            }
            return Nodes_1.Nodes.getCallExpressionNode(Nodes_1.Nodes.getIdentifierNode(stringArrayStorageCallsWrapperName), callExpressionArgs);
        }
    }], [{
        key: "getHexadecimalLiteralNode",
        value: function getHexadecimalLiteralNode(hexadecimalIndex) {
            var hexadecimalLiteralNode = Nodes_1.Nodes.getLiteralNode(hexadecimalIndex);
            hexadecimalLiteralNode.obfuscatedNode = true;
            return hexadecimalLiteralNode;
        }
    }, {
        key: "getRc4KeyLiteralNode",
        value: function getRc4KeyLiteralNode(literalValue) {
            var rc4KeyLiteralNode = Nodes_1.Nodes.getLiteralNode(literalValue);
            rc4KeyLiteralNode.obfuscatedNode = true;
            return rc4KeyLiteralNode;
        }
    }]);

    return StringLiteralObfuscatingReplacer;
}(AbstractObfuscatingReplacer_1.AbstractObfuscatingReplacer);
StringLiteralObfuscatingReplacer.minimumLengthForStringArray = 3;
StringLiteralObfuscatingReplacer.rc4KeyLength = 4;
StringLiteralObfuscatingReplacer.rc4KeysCount = 50;
StringLiteralObfuscatingReplacer = StringLiteralObfuscatingReplacer_1 = tslib_1.__decorate([inversify_1.injectable(), tslib_1.__param(0, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.TCustomNodeGroupStorage)), tslib_1.__param(1, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.TStringArrayStorage)), tslib_1.__param(2, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.IEscapeSequenceEncoder)), tslib_1.__param(3, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.IRandomGenerator)), tslib_1.__param(4, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.ICryptUtils)), tslib_1.__param(5, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.IOptions)), tslib_1.__metadata("design:paramtypes", [Object, Object, Object, Object, Object, Object])], StringLiteralObfuscatingReplacer);
exports.StringLiteralObfuscatingReplacer = StringLiteralObfuscatingReplacer;
var StringLiteralObfuscatingReplacer_1;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3RyaW5nTGl0ZXJhbE9iZnVzY2F0aW5nUmVwbGFjZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvbm9kZS10cmFuc2Zvcm1lcnMvb2JmdXNjYXRpbmctdHJhbnNmb3JtZXJzL29iZnVzY2F0aW5nLXJlcGxhY2Vycy9saXRlcmFsLW9iZnVzY2F0aW5nLXJlcGxhY2Vycy9TdHJpbmdMaXRlcmFsT2JmdXNjYXRpbmdSZXBsYWNlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQSwwQkFBK0M7QUFDL0MsbUNBQThFO0FBYTlFLG9DQUE0RTtBQUU1RSw0Q0FBNkU7QUFDN0Usc0JBQStDO0FBQy9DLHNCQUFnRDtBQUdoRCxJQUFhLEFBQWdDO0FBQTdDLEFBQThDOztBQWdFMUMsOENBQ3dELEFBQWtELHdCQUN0RCxBQUFvQyxvQkFDakMsQUFBNkMsdUJBQ25ELEFBQWlDLGlCQUN0QyxBQUF1QixZQUMxQixBQUFpQjtBQUV0RCxBQUFLOzt3S0FDRCxBQUFPLEFBQ1YsQUFBQzs7QUF4Q1csY0FBVSxhQUE4QixJQUFJLEFBQUcsQUFBRSxBQUFDO0FBZWxELGNBQWtDLHFDQUF5QixJQUFJLEFBQUcsQUFBRSxBQUFDO0FBMkJsRixBQUFJLGNBQUMsQUFBc0IseUJBQUcsQUFBc0IsQUFBQztBQUNyRCxBQUFJLGNBQUMsQUFBa0IscUJBQUcsQUFBa0IsQUFBQztBQUM3QyxBQUFJLGNBQUMsQUFBcUIsd0JBQUcsQUFBcUIsQUFBQztBQUNuRCxBQUFJLGNBQUMsQUFBZSxrQkFBRyxBQUFlLEFBQUM7QUFDdkMsQUFBSSxjQUFDLEFBQVUsYUFBRyxBQUFVLEFBQUM7QUFFN0IsQUFBSSxjQUFDLEFBQU8sZ0JBQVEsQUFBZSxnQkFBQyxBQUFrQixBQUFFLHFCQUNuRCxBQUFDO0FBQ0UseUJBQVcsQUFBZSxnQkFBQyxBQUFrQixBQUFFLHFCQUFDLEFBQU07QUFDbEQsQUFBTSx3QkFBRSxBQUFnQyxtQ0FB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QVksZUFBVyxBQUFFLEFBQUM7QUFkaEMsQUFBZ0MsNEZBRDVDLFlBQVUsQUFBRSxjQWtFSixtQkFBQSxZQUFNLE9BQUMscUJBQWtCLG1CQUFDLEFBQXVCLEFBQUMsMkJBQ2xELG1CQUFBLFlBQU0sT0FBQyxxQkFBa0IsbUJBQUMsQUFBbUIsQUFBQyx1QkFDOUMsbUJBQUEsWUFBTSxPQUFDLHFCQUFrQixtQkFBQyxBQUFzQixBQUFDLDBCQUNqRCxtQkFBQSxZQUFNLE9BQUMscUJBQWtCLG1CQUFDLEFBQWdCLEFBQUMsb0JBQzNDLG1CQUFBLFlBQU0sT0FBQyxxQkFBa0IsbUJBQUMsQUFBVyxBQUFDLGVBQ3RDLG1CQUFBLFlBQU0sT0FBQyxxQkFBa0IsbUJBQUMsQUFBUSxBQUFDLHdHQXRFL0IsQUFBZ0MsQUFzUDVDO0FBdFBZLDJDQUFnQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGluamVjdGFibGUsIGluamVjdCB9IGZyb20gJ2ludmVyc2lmeSc7XG5pbXBvcnQgeyBTZXJ2aWNlSWRlbnRpZmllcnMgfSBmcm9tICcuLi8uLi8uLi8uLi9jb250YWluZXIvU2VydmljZUlkZW50aWZpZXJzJztcblxuaW1wb3J0ICogYXMgRVNUcmVlIGZyb20gJ2VzdHJlZSc7XG5cbmltcG9ydCB7IElDcnlwdFV0aWxzIH0gZnJvbSAnLi4vLi4vLi4vLi4vaW50ZXJmYWNlcy91dGlscy9JQ3J5cHRVdGlscyc7XG5pbXBvcnQgeyBJQ3VzdG9tTm9kZUdyb3VwIH0gZnJvbSAnLi4vLi4vLi4vLi4vaW50ZXJmYWNlcy9jdXN0b20tbm9kZXMvSUN1c3RvbU5vZGVHcm91cCc7XG5pbXBvcnQgeyBJRW5jb2RlZFZhbHVlIH0gZnJvbSAnLi4vLi4vLi4vLi4vaW50ZXJmYWNlcy9ub2RlLXRyYW5zZm9ybWVycy9vYmZ1c2NhdGluZy10cmFuc2Zvcm1lcnMvb2JmdXNjYXRpbmctcmVwbGFjZXJzL2xpdGVyYWwtb2JmdXNjYXRpbmctcmVwbGFjZXJzL0lFbmNvZGVkVmFsdWUnO1xuaW1wb3J0IHsgSUVzY2FwZVNlcXVlbmNlRW5jb2RlciB9IGZyb20gJy4uLy4uLy4uLy4uL2ludGVyZmFjZXMvdXRpbHMvSUVzY2FwZVNlcXVlbmNlRW5jb2Rlcic7XG5pbXBvcnQgeyBJT3B0aW9ucyB9IGZyb20gJy4uLy4uLy4uLy4uL2ludGVyZmFjZXMvb3B0aW9ucy9JT3B0aW9ucyc7XG5pbXBvcnQgeyBJUmFuZG9tR2VuZXJhdG9yIH0gZnJvbSAnLi4vLi4vLi4vLi4vaW50ZXJmYWNlcy91dGlscy9JUmFuZG9tR2VuZXJhdG9yJztcbmltcG9ydCB7IElTdG9yYWdlIH0gZnJvbSAnLi4vLi4vLi4vLi4vaW50ZXJmYWNlcy9zdG9yYWdlcy9JU3RvcmFnZSc7XG5pbXBvcnQgeyBJU3RyaW5nQXJyYXlJbmRleERhdGEgfSBmcm9tICcuLi8uLi8uLi8uLi9pbnRlcmZhY2VzL25vZGUtdHJhbnNmb3JtZXJzL29iZnVzY2F0aW5nLXRyYW5zZm9ybWVycy9vYmZ1c2NhdGluZy1yZXBsYWNlcnMvbGl0ZXJhbC1vYmZ1c2NhdGluZy1yZXBsYWNlcnMvSVN0cmluZ0FycmF5SW5kZXhEYXRhJztcblxuaW1wb3J0IHsgU3RyaW5nQXJyYXlFbmNvZGluZyB9IGZyb20gJy4uLy4uLy4uLy4uL2VudW1zL1N0cmluZ0FycmF5RW5jb2RpbmcnO1xuXG5pbXBvcnQgeyBBYnN0cmFjdE9iZnVzY2F0aW5nUmVwbGFjZXIgfSBmcm9tICcuLi9BYnN0cmFjdE9iZnVzY2F0aW5nUmVwbGFjZXInO1xuaW1wb3J0IHsgTm9kZXMgfSBmcm9tICcuLi8uLi8uLi8uLi9ub2RlL05vZGVzJztcbmltcG9ydCB7IFV0aWxzIH0gZnJvbSAnLi4vLi4vLi4vLi4vdXRpbHMvVXRpbHMnO1xuXG5AaW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgU3RyaW5nTGl0ZXJhbE9iZnVzY2F0aW5nUmVwbGFjZXIgZXh0ZW5kcyBBYnN0cmFjdE9iZnVzY2F0aW5nUmVwbGFjZXIge1xuICAgIC8qKlxuICAgICAqIEB0eXBlIHtudW1iZXJ9XG4gICAgICovXG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgbWluaW11bUxlbmd0aEZvclN0cmluZ0FycmF5OiBudW1iZXIgPSAzO1xuXG4gICAgLyoqXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICBwcml2YXRlIHN0YXRpYyByYzRLZXlMZW5ndGg6IG51bWJlciA9IDQ7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIHByaXZhdGUgc3RhdGljIHJjNEtleXNDb3VudDogbnVtYmVyID0gNTA7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7SUNyeXB0VXRpbHN9XG4gICAgICovXG4gICAgcHJpdmF0ZSByZWFkb25seSBjcnlwdFV0aWxzOiBJQ3J5cHRVdGlscztcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtJU3RvcmFnZTxJQ3VzdG9tTm9kZUdyb3VwPn1cbiAgICAgKi9cbiAgICBwcml2YXRlIHJlYWRvbmx5IGN1c3RvbU5vZGVHcm91cFN0b3JhZ2U6IElTdG9yYWdlPElDdXN0b21Ob2RlR3JvdXA+O1xuXG4gICAgLyoqXG4gICAgICogQHR5cGUge0lFc2NhcGVTZXF1ZW5jZUVuY29kZXJ9XG4gICAgICovXG4gICAgcHJpdmF0ZSByZWFkb25seSBlc2NhcGVTZXF1ZW5jZUVuY29kZXI6IElFc2NhcGVTZXF1ZW5jZUVuY29kZXI7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7TWFwPHN0cmluZywgRVNUcmVlLk5vZGU+fVxuICAgICAqL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgbm9kZXNDYWNoZTogTWFwIDxzdHJpbmcsIEVTVHJlZS5Ob2RlPiA9IG5ldyBNYXAoKTtcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtJUmFuZG9tR2VuZXJhdG9yfVxuICAgICAqL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgcmFuZG9tR2VuZXJhdG9yOiBJUmFuZG9tR2VuZXJhdG9yO1xuXG4gICAgLyoqXG4gICAgICogQHR5cGUge3N0cmluZ1tdfVxuICAgICAqL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgcmM0S2V5czogc3RyaW5nW107XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7TWFwPHN0cmluZywgc3RyaW5nPn1cbiAgICAgKi9cbiAgICBwcml2YXRlIHJlYWRvbmx5IHN0cmluZ0xpdGVyYWxIZXhhZGVjaW1hbEluZGV4Q2FjaGU6IE1hcCA8c3RyaW5nLCBzdHJpbmc+ID0gbmV3IE1hcCgpO1xuXG4gICAgLyoqXG4gICAgICogQHR5cGUge0lTdG9yYWdlPHN0cmluZz59XG4gICAgICovXG4gICAgcHJpdmF0ZSByZWFkb25seSBzdHJpbmdBcnJheVN0b3JhZ2U6IElTdG9yYWdlPHN0cmluZz47XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge0lTdG9yYWdlPElDdXN0b21Ob2RlR3JvdXA+fSBjdXN0b21Ob2RlR3JvdXBTdG9yYWdlXG4gICAgICogQHBhcmFtIHtJU3RvcmFnZTxzdHJpbmc+fSBzdHJpbmdBcnJheVN0b3JhZ2VcbiAgICAgKiBAcGFyYW0ge0lFc2NhcGVTZXF1ZW5jZUVuY29kZXJ9IGVzY2FwZVNlcXVlbmNlRW5jb2RlclxuICAgICAqIEBwYXJhbSB7SVJhbmRvbUdlbmVyYXRvcn0gcmFuZG9tR2VuZXJhdG9yXG4gICAgICogQHBhcmFtIHtJQ3J5cHRVdGlsc30gY3J5cHRVdGlsc1xuICAgICAqIEBwYXJhbSB7SU9wdGlvbnN9IG9wdGlvbnNcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvciAoXG4gICAgICAgIEBpbmplY3QoU2VydmljZUlkZW50aWZpZXJzLlRDdXN0b21Ob2RlR3JvdXBTdG9yYWdlKSBjdXN0b21Ob2RlR3JvdXBTdG9yYWdlOiBJU3RvcmFnZTxJQ3VzdG9tTm9kZUdyb3VwPixcbiAgICAgICAgQGluamVjdChTZXJ2aWNlSWRlbnRpZmllcnMuVFN0cmluZ0FycmF5U3RvcmFnZSkgc3RyaW5nQXJyYXlTdG9yYWdlOiBJU3RvcmFnZTxzdHJpbmc+LFxuICAgICAgICBAaW5qZWN0KFNlcnZpY2VJZGVudGlmaWVycy5JRXNjYXBlU2VxdWVuY2VFbmNvZGVyKSBlc2NhcGVTZXF1ZW5jZUVuY29kZXI6IElFc2NhcGVTZXF1ZW5jZUVuY29kZXIsXG4gICAgICAgIEBpbmplY3QoU2VydmljZUlkZW50aWZpZXJzLklSYW5kb21HZW5lcmF0b3IpIHJhbmRvbUdlbmVyYXRvcjogSVJhbmRvbUdlbmVyYXRvcixcbiAgICAgICAgQGluamVjdChTZXJ2aWNlSWRlbnRpZmllcnMuSUNyeXB0VXRpbHMpIGNyeXB0VXRpbHM6IElDcnlwdFV0aWxzLFxuICAgICAgICBAaW5qZWN0KFNlcnZpY2VJZGVudGlmaWVycy5JT3B0aW9ucykgb3B0aW9uczogSU9wdGlvbnNcbiAgICApIHtcbiAgICAgICAgc3VwZXIoXG4gICAgICAgICAgICBvcHRpb25zXG4gICAgICAgICk7XG5cbiAgICAgICAgdGhpcy5jdXN0b21Ob2RlR3JvdXBTdG9yYWdlID0gY3VzdG9tTm9kZUdyb3VwU3RvcmFnZTtcbiAgICAgICAgdGhpcy5zdHJpbmdBcnJheVN0b3JhZ2UgPSBzdHJpbmdBcnJheVN0b3JhZ2U7XG4gICAgICAgIHRoaXMuZXNjYXBlU2VxdWVuY2VFbmNvZGVyID0gZXNjYXBlU2VxdWVuY2VFbmNvZGVyO1xuICAgICAgICB0aGlzLnJhbmRvbUdlbmVyYXRvciA9IHJhbmRvbUdlbmVyYXRvcjtcbiAgICAgICAgdGhpcy5jcnlwdFV0aWxzID0gY3J5cHRVdGlscztcblxuICAgICAgICB0aGlzLnJjNEtleXMgPSB0aGlzLnJhbmRvbUdlbmVyYXRvci5nZXRSYW5kb21HZW5lcmF0b3IoKVxuICAgICAgICAgICAgLm4oXG4gICAgICAgICAgICAgICAgKCkgPT4gdGhpcy5yYW5kb21HZW5lcmF0b3IuZ2V0UmFuZG9tR2VuZXJhdG9yKCkuc3RyaW5nKHtcbiAgICAgICAgICAgICAgICAgICAgbGVuZ3RoOiBTdHJpbmdMaXRlcmFsT2JmdXNjYXRpbmdSZXBsYWNlci5yYzRLZXlMZW5ndGhcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBTdHJpbmdMaXRlcmFsT2JmdXNjYXRpbmdSZXBsYWNlci5yYzRLZXlzQ291bnRcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGhleGFkZWNpbWFsSW5kZXhcbiAgICAgKiBAcmV0dXJucyB7TGl0ZXJhbH1cbiAgICAgKi9cbiAgICBwcml2YXRlIHN0YXRpYyBnZXRIZXhhZGVjaW1hbExpdGVyYWxOb2RlIChoZXhhZGVjaW1hbEluZGV4OiBzdHJpbmcpOiBFU1RyZWUuTGl0ZXJhbCB7XG4gICAgICAgIGNvbnN0IGhleGFkZWNpbWFsTGl0ZXJhbE5vZGU6IEVTVHJlZS5MaXRlcmFsID0gTm9kZXMuZ2V0TGl0ZXJhbE5vZGUoaGV4YWRlY2ltYWxJbmRleCk7XG5cbiAgICAgICAgaGV4YWRlY2ltYWxMaXRlcmFsTm9kZS5vYmZ1c2NhdGVkTm9kZSA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIGhleGFkZWNpbWFsTGl0ZXJhbE5vZGU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGxpdGVyYWxWYWx1ZVxuICAgICAqIEByZXR1cm5zIHtMaXRlcmFsfVxuICAgICAqL1xuICAgIHByaXZhdGUgc3RhdGljIGdldFJjNEtleUxpdGVyYWxOb2RlIChsaXRlcmFsVmFsdWU6IHN0cmluZyk6IEVTVHJlZS5MaXRlcmFsIHtcbiAgICAgICAgY29uc3QgcmM0S2V5TGl0ZXJhbE5vZGU6IEVTVHJlZS5MaXRlcmFsID0gTm9kZXMuZ2V0TGl0ZXJhbE5vZGUobGl0ZXJhbFZhbHVlKTtcblxuICAgICAgICByYzRLZXlMaXRlcmFsTm9kZS5vYmZ1c2NhdGVkTm9kZSA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIHJjNEtleUxpdGVyYWxOb2RlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBub2RlVmFsdWVcbiAgICAgKiBAcmV0dXJucyB7Tm9kZX1cbiAgICAgKi9cbiAgICBwdWJsaWMgcmVwbGFjZSAobm9kZVZhbHVlOiBzdHJpbmcpOiBFU1RyZWUuTm9kZSB7XG4gICAgICAgIGNvbnN0IHVzZVN0cmluZ0FycmF5OiBib29sZWFuID0gdGhpcy5jYW5Vc2VTdHJpbmdBcnJheShub2RlVmFsdWUpO1xuICAgICAgICBjb25zdCBjYWNoZUtleTogc3RyaW5nID0gYCR7bm9kZVZhbHVlfS0ke1N0cmluZyh1c2VTdHJpbmdBcnJheSl9YDtcbiAgICAgICAgY29uc3QgdXNlQ2FjaGVWYWx1ZTogYm9vbGVhbiA9IHRoaXMubm9kZXNDYWNoZS5oYXMoY2FjaGVLZXkpICYmIHRoaXMub3B0aW9ucy5zdHJpbmdBcnJheUVuY29kaW5nICE9PSBTdHJpbmdBcnJheUVuY29kaW5nLlJjNDtcblxuICAgICAgICBpZiAodXNlQ2FjaGVWYWx1ZSkge1xuICAgICAgICAgICAgcmV0dXJuIDxFU1RyZWUuTm9kZT50aGlzLm5vZGVzQ2FjaGUuZ2V0KGNhY2hlS2V5KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlc3VsdE5vZGU6IEVTVHJlZS5Ob2RlID0gdXNlU3RyaW5nQXJyYXlcbiAgICAgICAgICAgID8gdGhpcy5yZXBsYWNlV2l0aFN0cmluZ0FycmF5Q2FsbE5vZGUobm9kZVZhbHVlKVxuICAgICAgICAgICAgOiB0aGlzLnJlcGxhY2VXaXRoTGl0ZXJhbE5vZGUobm9kZVZhbHVlKTtcblxuICAgICAgICB0aGlzLm5vZGVzQ2FjaGUuc2V0KGNhY2hlS2V5LCByZXN1bHROb2RlKTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0Tm9kZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbm9kZVZhbHVlXG4gICAgICogQHJldHVybnMge2Jvb2xlYW59XG4gICAgICovXG4gICAgcHJpdmF0ZSBjYW5Vc2VTdHJpbmdBcnJheSAobm9kZVZhbHVlOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5zdHJpbmdBcnJheSAmJlxuICAgICAgICAgICAgbm9kZVZhbHVlLmxlbmd0aCA+PSBTdHJpbmdMaXRlcmFsT2JmdXNjYXRpbmdSZXBsYWNlci5taW5pbXVtTGVuZ3RoRm9yU3RyaW5nQXJyYXkgJiZcbiAgICAgICAgICAgIHRoaXMucmFuZG9tR2VuZXJhdG9yLmdldE1hdGhSYW5kb20oKSA8PSB0aGlzLm9wdGlvbnMuc3RyaW5nQXJyYXlUaHJlc2hvbGRcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWVcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gc3RyaW5nQXJyYXlTdG9yYWdlTGVuZ3RoXG4gICAgICogQHJldHVybnMge0lTdHJpbmdBcnJheUluZGV4RGF0YX1cbiAgICAgKi9cbiAgICBwcml2YXRlIGdldFN0cmluZ0FycmF5SGV4YWRlY2ltYWxJbmRleCAodmFsdWU6IHN0cmluZywgc3RyaW5nQXJyYXlTdG9yYWdlTGVuZ3RoOiBudW1iZXIpOiBJU3RyaW5nQXJyYXlJbmRleERhdGEge1xuICAgICAgICBpZiAodGhpcy5zdHJpbmdMaXRlcmFsSGV4YWRlY2ltYWxJbmRleENhY2hlLmhhcyh2YWx1ZSkpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgZnJvbUNhY2hlOiB0cnVlLFxuICAgICAgICAgICAgICAgIGluZGV4OiA8c3RyaW5nPnRoaXMuc3RyaW5nTGl0ZXJhbEhleGFkZWNpbWFsSW5kZXhDYWNoZS5nZXQodmFsdWUpXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgaGV4YWRlY2ltYWxSYXdJbmRleDogc3RyaW5nID0gVXRpbHMuZGVjVG9IZXgoc3RyaW5nQXJyYXlTdG9yYWdlTGVuZ3RoKTtcbiAgICAgICAgY29uc3QgaGV4YWRlY2ltYWxJbmRleDogc3RyaW5nID0gYCR7VXRpbHMuaGV4YWRlY2ltYWxQcmVmaXh9JHtoZXhhZGVjaW1hbFJhd0luZGV4fWA7XG5cbiAgICAgICAgdGhpcy5zdHJpbmdMaXRlcmFsSGV4YWRlY2ltYWxJbmRleENhY2hlLnNldCh2YWx1ZSwgaGV4YWRlY2ltYWxJbmRleCk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGZyb21DYWNoZTogZmFsc2UsXG4gICAgICAgICAgICBpbmRleDogaGV4YWRlY2ltYWxJbmRleFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZVxuICAgICAqIEByZXR1cm5zIHtJRW5jb2RlZFZhbHVlfVxuICAgICAqL1xuICAgIHByaXZhdGUgZ2V0RW5jb2RlZFZhbHVlICh2YWx1ZTogc3RyaW5nKTogSUVuY29kZWRWYWx1ZSB7XG4gICAgICAgIGxldCBlbmNvZGVkVmFsdWU6IHN0cmluZyxcbiAgICAgICAgICAgIGtleTogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG5cbiAgICAgICAgc3dpdGNoICh0aGlzLm9wdGlvbnMuc3RyaW5nQXJyYXlFbmNvZGluZykge1xuICAgICAgICAgICAgY2FzZSBTdHJpbmdBcnJheUVuY29kaW5nLlJjNDpcbiAgICAgICAgICAgICAgICBrZXkgPSB0aGlzLnJhbmRvbUdlbmVyYXRvci5nZXRSYW5kb21HZW5lcmF0b3IoKS5waWNrb25lKHRoaXMucmM0S2V5cyk7XG4gICAgICAgICAgICAgICAgZW5jb2RlZFZhbHVlID0gdGhpcy5jcnlwdFV0aWxzLmJ0b2EodGhpcy5jcnlwdFV0aWxzLnJjNCh2YWx1ZSwga2V5KSk7XG5cbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSBTdHJpbmdBcnJheUVuY29kaW5nLkJhc2U2NDpcbiAgICAgICAgICAgICAgICBlbmNvZGVkVmFsdWUgPSB0aGlzLmNyeXB0VXRpbHMuYnRvYSh2YWx1ZSk7XG5cbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICBlbmNvZGVkVmFsdWUgPSB2YWx1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB7IGVuY29kZWRWYWx1ZSwga2V5IH07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlXG4gICAgICogQHJldHVybnMge05vZGV9XG4gICAgICovXG4gICAgcHJpdmF0ZSByZXBsYWNlV2l0aExpdGVyYWxOb2RlICh2YWx1ZTogc3RyaW5nKTogRVNUcmVlLk5vZGUge1xuICAgICAgICByZXR1cm4gTm9kZXMuZ2V0TGl0ZXJhbE5vZGUoXG4gICAgICAgICAgICB0aGlzLmVzY2FwZVNlcXVlbmNlRW5jb2Rlci5lbmNvZGUodmFsdWUsIHRoaXMub3B0aW9ucy51bmljb2RlRXNjYXBlU2VxdWVuY2UpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlXG4gICAgICogQHJldHVybnMge05vZGV9XG4gICAgICovXG4gICAgcHJpdmF0ZSByZXBsYWNlV2l0aFN0cmluZ0FycmF5Q2FsbE5vZGUgKHZhbHVlOiBzdHJpbmcpOiBFU1RyZWUuTm9kZSB7XG4gICAgICAgIGNvbnN0IHsgZW5jb2RlZFZhbHVlLCBrZXkgfTogSUVuY29kZWRWYWx1ZSA9IHRoaXMuZ2V0RW5jb2RlZFZhbHVlKHZhbHVlKTtcbiAgICAgICAgY29uc3QgZXNjYXBlZFZhbHVlOiBzdHJpbmcgPSB0aGlzLmVzY2FwZVNlcXVlbmNlRW5jb2Rlci5lbmNvZGUoZW5jb2RlZFZhbHVlLCB0aGlzLm9wdGlvbnMudW5pY29kZUVzY2FwZVNlcXVlbmNlKTtcblxuICAgICAgICBjb25zdCBzdHJpbmdBcnJheVN0b3JhZ2VMZW5ndGg6IG51bWJlciA9IHRoaXMuc3RyaW5nQXJyYXlTdG9yYWdlLmdldExlbmd0aCgpO1xuICAgICAgICBjb25zdCByb3RhdGVkU3RyaW5nQXJyYXlTdG9yYWdlSWQ6IHN0cmluZyA9IFV0aWxzLnN0cmluZ1JvdGF0ZSh0aGlzLnN0cmluZ0FycmF5U3RvcmFnZS5nZXRTdG9yYWdlSWQoKSwgMSk7XG4gICAgICAgIGNvbnN0IHN0cmluZ0FycmF5U3RvcmFnZUNhbGxzV3JhcHBlck5hbWU6IHN0cmluZyA9IGBfJHtVdGlscy5oZXhhZGVjaW1hbFByZWZpeH0ke3JvdGF0ZWRTdHJpbmdBcnJheVN0b3JhZ2VJZH1gO1xuXG4gICAgICAgIGNvbnN0IHsgZnJvbUNhY2hlLCBpbmRleCB9OiBJU3RyaW5nQXJyYXlJbmRleERhdGEgPSB0aGlzLmdldFN0cmluZ0FycmF5SGV4YWRlY2ltYWxJbmRleChcbiAgICAgICAgICAgIGVzY2FwZWRWYWx1ZSxcbiAgICAgICAgICAgIHN0cmluZ0FycmF5U3RvcmFnZUxlbmd0aFxuICAgICAgICApO1xuXG4gICAgICAgIGlmICghZnJvbUNhY2hlKSB7XG4gICAgICAgICAgICB0aGlzLnN0cmluZ0FycmF5U3RvcmFnZS5zZXQoc3RyaW5nQXJyYXlTdG9yYWdlTGVuZ3RoLCBlc2NhcGVkVmFsdWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY2FsbEV4cHJlc3Npb25BcmdzOiAoRVNUcmVlLkV4cHJlc3Npb24gfCBFU1RyZWUuU3ByZWFkRWxlbWVudClbXSA9IFtcbiAgICAgICAgICAgIFN0cmluZ0xpdGVyYWxPYmZ1c2NhdGluZ1JlcGxhY2VyLmdldEhleGFkZWNpbWFsTGl0ZXJhbE5vZGUoaW5kZXgpXG4gICAgICAgIF07XG5cbiAgICAgICAgaWYgKGtleSkge1xuICAgICAgICAgICAgY2FsbEV4cHJlc3Npb25BcmdzLnB1c2goU3RyaW5nTGl0ZXJhbE9iZnVzY2F0aW5nUmVwbGFjZXIuZ2V0UmM0S2V5TGl0ZXJhbE5vZGUoXG4gICAgICAgICAgICAgICAgdGhpcy5lc2NhcGVTZXF1ZW5jZUVuY29kZXIuZW5jb2RlKGtleSwgdGhpcy5vcHRpb25zLnVuaWNvZGVFc2NhcGVTZXF1ZW5jZSlcbiAgICAgICAgICAgICkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIE5vZGVzLmdldENhbGxFeHByZXNzaW9uTm9kZShcbiAgICAgICAgICAgIE5vZGVzLmdldElkZW50aWZpZXJOb2RlKHN0cmluZ0FycmF5U3RvcmFnZUNhbGxzV3JhcHBlck5hbWUpLFxuICAgICAgICAgICAgY2FsbEV4cHJlc3Npb25BcmdzXG4gICAgICAgICk7XG4gICAgfVxufVxuIl19