"use strict";

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var inversify_1 = require("inversify");
var ServiceIdentifiers_1 = require("../../container/ServiceIdentifiers");
var estraverse = require("estraverse");
var ControlFlowCustomNode_1 = require("../../enums/container/custom-nodes/ControlFlowCustomNode");
var NodeType_1 = require("../../enums/NodeType");
var AbstractNodeTransformer_1 = require("../AbstractNodeTransformer");
var Node_1 = require("../../node/Node");
var NodeAppender_1 = require("../../node/NodeAppender");
var ControlFlowReplacer_1 = require("../../enums/container/node-transformers/ControlFlowReplacer");
var NodeUtils_1 = require("../../node/NodeUtils");
var FunctionControlFlowTransformer = FunctionControlFlowTransformer_1 = function (_AbstractNodeTransfor) {
    _inherits(FunctionControlFlowTransformer, _AbstractNodeTransfor);

    function FunctionControlFlowTransformer(controlFlowStorageFactory, controlFlowReplacerFactory, controlFlowCustomNodeFactory, randomGenerator, options) {
        _classCallCheck(this, FunctionControlFlowTransformer);

        var _this = _possibleConstructorReturn(this, (FunctionControlFlowTransformer.__proto__ || Object.getPrototypeOf(FunctionControlFlowTransformer)).call(this, randomGenerator, options));

        _this.controlFlowData = new Map();
        _this.visitedFunctionNodes = new Set();
        _this.hostNodesWithControlFlowNode = new Set();
        _this.controlFlowStorageFactory = controlFlowStorageFactory;
        _this.controlFlowReplacerFactory = controlFlowReplacerFactory;
        _this.controlFlowCustomNodeFactory = controlFlowCustomNodeFactory;
        return _this;
    }

    _createClass(FunctionControlFlowTransformer, [{
        key: "getVisitor",
        value: function getVisitor() {
            var _this2 = this;

            return {
                leave: function leave(node, parentNode) {
                    if (Node_1.Node.isFunctionDeclarationNode(node) || Node_1.Node.isFunctionExpressionNode(node) || Node_1.Node.isArrowFunctionExpressionNode(node)) {
                        return _this2.transformNode(node, parentNode);
                    }
                }
            };
        }
    }, {
        key: "transformNode",
        value: function transformNode(functionNode, parentNode) {
            this.visitedFunctionNodes.add(functionNode);
            if (!Node_1.Node.isBlockStatementNode(functionNode.body)) {
                return functionNode;
            }
            var hostNode = this.getHostNode(functionNode.body);
            var controlFlowStorage = this.getControlFlowStorage(hostNode);
            this.controlFlowData.set(hostNode, controlFlowStorage);
            this.transformFunctionBody(functionNode.body, controlFlowStorage);
            if (!controlFlowStorage.getLength()) {
                return functionNode;
            }
            var controlFlowStorageCustomNode = this.controlFlowCustomNodeFactory(ControlFlowCustomNode_1.ControlFlowCustomNode.ControlFlowStorageNode);
            controlFlowStorageCustomNode.initialize(controlFlowStorage);
            NodeAppender_1.NodeAppender.prependNode(hostNode, controlFlowStorageCustomNode.getNode());
            this.hostNodesWithControlFlowNode.add(hostNode);
            return functionNode;
        }
    }, {
        key: "getControlFlowStorage",
        value: function getControlFlowStorage(hostNode) {
            var controlFlowStorage = this.controlFlowStorageFactory();
            if (this.controlFlowData.has(hostNode)) {
                if (this.hostNodesWithControlFlowNode.has(hostNode)) {
                    hostNode.body.shift();
                }
                var hostControlFlowStorage = this.controlFlowData.get(hostNode);
                controlFlowStorage.mergeWith(hostControlFlowStorage, true);
            }
            return controlFlowStorage;
        }
    }, {
        key: "getHostNode",
        value: function getHostNode(functionNodeBody) {
            var blockScopesOfNode = NodeUtils_1.NodeUtils.getBlockScopesOfNode(functionNodeBody);
            if (blockScopesOfNode.length === 1) {
                return functionNodeBody;
            } else {
                blockScopesOfNode.pop();
            }
            if (blockScopesOfNode.length > FunctionControlFlowTransformer_1.hostNodeSearchMinDepth) {
                blockScopesOfNode.splice(0, FunctionControlFlowTransformer_1.hostNodeSearchMinDepth);
            }
            if (blockScopesOfNode.length > FunctionControlFlowTransformer_1.hostNodeSearchMaxDepth) {
                blockScopesOfNode.length = FunctionControlFlowTransformer_1.hostNodeSearchMaxDepth;
            }
            return this.randomGenerator.getRandomGenerator().pickone(blockScopesOfNode);
        }
    }, {
        key: "isVisitedFunctionNode",
        value: function isVisitedFunctionNode(node) {
            return (Node_1.Node.isFunctionDeclarationNode(node) || Node_1.Node.isFunctionExpressionNode(node) || Node_1.Node.isArrowFunctionExpressionNode(node)) && this.visitedFunctionNodes.has(node);
        }
    }, {
        key: "transformFunctionBody",
        value: function transformFunctionBody(functionNodeBody, controlFlowStorage) {
            var _this3 = this;

            estraverse.replace(functionNodeBody, {
                enter: function enter(node, parentNode) {
                    if (_this3.isVisitedFunctionNode(node)) {
                        return estraverse.VisitorOption.Skip;
                    }
                    if (!FunctionControlFlowTransformer_1.controlFlowReplacersMap.has(node.type)) {
                        return node;
                    }
                    if (_this3.randomGenerator.getMathRandom() > _this3.options.controlFlowFlatteningThreshold) {
                        return node;
                    }
                    var controlFlowReplacerName = FunctionControlFlowTransformer_1.controlFlowReplacersMap.get(node.type);
                    if (controlFlowReplacerName === undefined) {
                        return node;
                    }
                    return Object.assign({}, _this3.controlFlowReplacerFactory(controlFlowReplacerName).replace(node, parentNode, controlFlowStorage), { parentNode: parentNode });
                }
            });
        }
    }]);

    return FunctionControlFlowTransformer;
}(AbstractNodeTransformer_1.AbstractNodeTransformer);
FunctionControlFlowTransformer.controlFlowReplacersMap = new Map([[NodeType_1.NodeType.BinaryExpression, ControlFlowReplacer_1.ControlFlowReplacer.BinaryExpressionControlFlowReplacer], [NodeType_1.NodeType.CallExpression, ControlFlowReplacer_1.ControlFlowReplacer.CallExpressionControlFlowReplacer], [NodeType_1.NodeType.LogicalExpression, ControlFlowReplacer_1.ControlFlowReplacer.LogicalExpressionControlFlowReplacer], [NodeType_1.NodeType.Literal, ControlFlowReplacer_1.ControlFlowReplacer.StringLiteralControlFlowReplacer]]);
FunctionControlFlowTransformer.hostNodeSearchMinDepth = 0;
FunctionControlFlowTransformer.hostNodeSearchMaxDepth = 2;
FunctionControlFlowTransformer = FunctionControlFlowTransformer_1 = tslib_1.__decorate([inversify_1.injectable(), tslib_1.__param(0, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.Factory__TControlFlowStorage)), tslib_1.__param(1, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.Factory__IControlFlowReplacer)), tslib_1.__param(2, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.Factory__IControlFlowCustomNode)), tslib_1.__param(3, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.IRandomGenerator)), tslib_1.__param(4, inversify_1.inject(ServiceIdentifiers_1.ServiceIdentifiers.IOptions)), tslib_1.__metadata("design:paramtypes", [Function, Function, Function, Object, Object])], FunctionControlFlowTransformer);
exports.FunctionControlFlowTransformer = FunctionControlFlowTransformer;
var FunctionControlFlowTransformer_1;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRnVuY3Rpb25Db250cm9sRmxvd1RyYW5zZm9ybWVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL25vZGUtdHJhbnNmb3JtZXJzL2NvbnRyb2wtZmxvdy10cmFuc2Zvcm1lcnMvRnVuY3Rpb25Db250cm9sRmxvd1RyYW5zZm9ybWVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBLDBCQUErQztBQUMvQyxtQ0FBd0U7QUFFeEUseUJBQXlDO0FBY3pDLHNDQUFpRztBQUNqRyx5QkFBZ0Q7QUFFaEQsd0NBQXFFO0FBQ3JFLHFCQUF1QztBQUN2Qyw2QkFBdUQ7QUFDdkQsb0NBQWtHO0FBQ2xHLDBCQUFpRDtBQUdqRCxJQUFhLEFBQThCO0FBQTNDLEFBQTRDOztBQTBEeEMsNENBRVEsQUFBcUQsMkJBRXJELEFBQXVELDRCQUV2RCxBQUEyRCw4QkFDbEIsQUFBaUMsaUJBQ3pDLEFBQWlCO0FBRXRELEFBQUs7O29LQUFDLEFBQWUsaUJBQUUsQUFBTyxBQUFDLEFBQUM7O0FBNUNuQixjQUFlLGtCQUE2QyxJQUFJLEFBQUcsQUFBRSxBQUFDO0FBS3RFLGNBQW9CLHVCQUF5QixJQUFJLEFBQUcsQUFBRSxBQUFDO0FBS3ZELGNBQTRCLCtCQUFpQyxJQUFJLEFBQUcsQUFBRSxBQUFDO0FBb0NwRixBQUFJLGNBQUMsQUFBeUIsNEJBQUcsQUFBeUIsQUFBQztBQUMzRCxBQUFJLGNBQUMsQUFBMEIsNkJBQUcsQUFBMEIsQUFBQztBQUM3RCxBQUFJLGNBQUMsQUFBNEIsK0JBQUcsQUFBNEIsQUFBQyxBQUNyRTs7QUFBQyxBQUtNLEFBQVU7Ozs7Ozs7QUFDYixBQUFNO0FBQ0YsQUFBSyx1QkFBRSxlQUFDLEFBQWlCLE1BQUUsQUFBdUI7QUFDOUMsQUFBRSxBQUFDLHdCQUNDLE9BQUksS0FBQyxBQUF5QiwwQkFBQyxBQUFJLEFBQUMsU0FDcEMsT0FBSSxLQUFDLEFBQXdCLHlCQUFDLEFBQUksQUFBQyxTQUNuQyxP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QUFBQyxnQ0FFdkQsbUJBQUEsWUFBTSxPQUFDLHFCQUFrQixtQkFBQyxBQUE2QixBQUFDLGlDQUV4RCxtQkFBQSxZQUFNLE9BQUMscUJBQWtCLG1CQUFDLEFBQStCLEFBQUMsbUNBRTFELG1CQUFBLFlBQU0sT0FBQyxxQkFBa0IsbUJBQUMsQUFBZ0IsQUFBQyxvQkFDM0MsbUJBQUEsWUFBTSxPQUFDLHFCQUFrQixtQkFBQyxBQUFRLEFBQUMsc0dBbEUvQixBQUE4QixBQXNOMUM7QUF0TlkseUNBQThCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaW5qZWN0YWJsZSwgaW5qZWN0IH0gZnJvbSAnaW52ZXJzaWZ5JztcbmltcG9ydCB7IFNlcnZpY2VJZGVudGlmaWVycyB9IGZyb20gJy4uLy4uL2NvbnRhaW5lci9TZXJ2aWNlSWRlbnRpZmllcnMnO1xuXG5pbXBvcnQgKiBhcyBlc3RyYXZlcnNlIGZyb20gJ2VzdHJhdmVyc2UnO1xuaW1wb3J0ICogYXMgRVNUcmVlIGZyb20gJ2VzdHJlZSc7XG5cbmltcG9ydCB7IFRDb250cm9sRmxvd0N1c3RvbU5vZGVGYWN0b3J5IH0gZnJvbSAnLi4vLi4vdHlwZXMvY29udGFpbmVyL2N1c3RvbS1ub2Rlcy9UQ29udHJvbEZsb3dDdXN0b21Ob2RlRmFjdG9yeSc7XG5pbXBvcnQgeyBUQ29udHJvbEZsb3dSZXBsYWNlckZhY3RvcnkgfSBmcm9tICcuLi8uLi90eXBlcy9jb250YWluZXIvbm9kZS10cmFuc2Zvcm1lcnMvVENvbnRyb2xGbG93UmVwbGFjZXJGYWN0b3J5JztcbmltcG9ydCB7IFRDb250cm9sRmxvd1N0b3JhZ2VGYWN0b3J5IH0gZnJvbSAnLi4vLi4vdHlwZXMvY29udGFpbmVyL25vZGUtdHJhbnNmb3JtZXJzL1RDb250cm9sRmxvd1N0b3JhZ2VGYWN0b3J5JztcbmltcG9ydCB7IFROb2RlV2l0aEJsb2NrU3RhdGVtZW50IH0gZnJvbSAnLi4vLi4vdHlwZXMvbm9kZS9UTm9kZVdpdGhCbG9ja1N0YXRlbWVudCc7XG5cbmltcG9ydCB7IElDdXN0b21Ob2RlIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9jdXN0b20tbm9kZXMvSUN1c3RvbU5vZGUnO1xuaW1wb3J0IHsgSU9wdGlvbnMgfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL29wdGlvbnMvSU9wdGlvbnMnO1xuaW1wb3J0IHsgSVJhbmRvbUdlbmVyYXRvciB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvdXRpbHMvSVJhbmRvbUdlbmVyYXRvcic7XG5pbXBvcnQgeyBJU3RvcmFnZSB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvc3RvcmFnZXMvSVN0b3JhZ2UnO1xuaW1wb3J0IHsgSVZpc2l0b3IgfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL0lWaXNpdG9yJztcblxuaW1wb3J0IHsgQ29udHJvbEZsb3dDdXN0b21Ob2RlIH0gZnJvbSAnLi4vLi4vZW51bXMvY29udGFpbmVyL2N1c3RvbS1ub2Rlcy9Db250cm9sRmxvd0N1c3RvbU5vZGUnO1xuaW1wb3J0IHsgTm9kZVR5cGUgfSBmcm9tICcuLi8uLi9lbnVtcy9Ob2RlVHlwZSc7XG5cbmltcG9ydCB7IEFic3RyYWN0Tm9kZVRyYW5zZm9ybWVyIH0gZnJvbSAnLi4vQWJzdHJhY3ROb2RlVHJhbnNmb3JtZXInO1xuaW1wb3J0IHsgTm9kZSB9IGZyb20gJy4uLy4uL25vZGUvTm9kZSc7XG5pbXBvcnQgeyBOb2RlQXBwZW5kZXIgfSBmcm9tICcuLi8uLi9ub2RlL05vZGVBcHBlbmRlcic7XG5pbXBvcnQgeyBDb250cm9sRmxvd1JlcGxhY2VyIH0gZnJvbSAnLi4vLi4vZW51bXMvY29udGFpbmVyL25vZGUtdHJhbnNmb3JtZXJzL0NvbnRyb2xGbG93UmVwbGFjZXInO1xuaW1wb3J0IHsgTm9kZVV0aWxzIH0gZnJvbSAnLi4vLi4vbm9kZS9Ob2RlVXRpbHMnO1xuXG5AaW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRnVuY3Rpb25Db250cm9sRmxvd1RyYW5zZm9ybWVyIGV4dGVuZHMgQWJzdHJhY3ROb2RlVHJhbnNmb3JtZXIge1xuICAgIC8qKlxuICAgICAqIEB0eXBlIHtNYXAgPHN0cmluZywgQ29udHJvbEZsb3dSZXBsYWNlcj59XG4gICAgICovXG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgY29udHJvbEZsb3dSZXBsYWNlcnNNYXA6IE1hcCA8c3RyaW5nLCBDb250cm9sRmxvd1JlcGxhY2VyPiA9IG5ldyBNYXAoW1xuICAgICAgICBbTm9kZVR5cGUuQmluYXJ5RXhwcmVzc2lvbiwgQ29udHJvbEZsb3dSZXBsYWNlci5CaW5hcnlFeHByZXNzaW9uQ29udHJvbEZsb3dSZXBsYWNlcl0sXG4gICAgICAgIFtOb2RlVHlwZS5DYWxsRXhwcmVzc2lvbiwgQ29udHJvbEZsb3dSZXBsYWNlci5DYWxsRXhwcmVzc2lvbkNvbnRyb2xGbG93UmVwbGFjZXJdLFxuICAgICAgICBbTm9kZVR5cGUuTG9naWNhbEV4cHJlc3Npb24sIENvbnRyb2xGbG93UmVwbGFjZXIuTG9naWNhbEV4cHJlc3Npb25Db250cm9sRmxvd1JlcGxhY2VyXSxcbiAgICAgICAgW05vZGVUeXBlLkxpdGVyYWwsIENvbnRyb2xGbG93UmVwbGFjZXIuU3RyaW5nTGl0ZXJhbENvbnRyb2xGbG93UmVwbGFjZXJdXG4gICAgXSk7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IGhvc3ROb2RlU2VhcmNoTWluRGVwdGg6IG51bWJlciA9IDA7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IGhvc3ROb2RlU2VhcmNoTWF4RGVwdGg6IG51bWJlciA9IDI7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7TWFwPEVTVHJlZS5Ob2RlLCBJU3RvcmFnZTxJQ3VzdG9tTm9kZT4+fVxuICAgICAqL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgY29udHJvbEZsb3dEYXRhOiBNYXAgPEVTVHJlZS5Ob2RlLCBJU3RvcmFnZTxJQ3VzdG9tTm9kZT4+ID0gbmV3IE1hcCgpO1xuXG4gICAgLyoqXG4gICAgICogQHR5cGUge1NldDxFU1RyZWUuRnVuY3Rpb24+fVxuICAgICAqL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgdmlzaXRlZEZ1bmN0aW9uTm9kZXM6IFNldDxFU1RyZWUuRnVuY3Rpb24+ID0gbmV3IFNldCgpO1xuXG4gICAgLyoqXG4gICAgICogQHR5cGUge1NldDxUTm9kZVdpdGhCbG9ja1N0YXRlbWVudD59XG4gICAgICovXG4gICAgcHJpdmF0ZSByZWFkb25seSBob3N0Tm9kZXNXaXRoQ29udHJvbEZsb3dOb2RlOiBTZXQ8VE5vZGVXaXRoQmxvY2tTdGF0ZW1lbnQ+ID0gbmV3IFNldCgpO1xuXG4gICAgLyoqXG4gICAgICogQHR5cGUge1RDb250cm9sRmxvd1JlcGxhY2VyRmFjdG9yeX1cbiAgICAgKi9cbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbnRyb2xGbG93UmVwbGFjZXJGYWN0b3J5OiBUQ29udHJvbEZsb3dSZXBsYWNlckZhY3Rvcnk7XG5cbiAgICAvKipcbiAgICAgKiBAdHlwZSB7VENvbnRyb2xGbG93U3RvcmFnZUZhY3Rvcnl9XG4gICAgICovXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb250cm9sRmxvd1N0b3JhZ2VGYWN0b3J5OiBUQ29udHJvbEZsb3dTdG9yYWdlRmFjdG9yeTtcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtUQ29udHJvbEZsb3dDdXN0b21Ob2RlRmFjdG9yeX1cbiAgICAgKi9cbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbnRyb2xGbG93Q3VzdG9tTm9kZUZhY3Rvcnk6IFRDb250cm9sRmxvd0N1c3RvbU5vZGVGYWN0b3J5O1xuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtUQ29udHJvbEZsb3dTdG9yYWdlRmFjdG9yeX0gY29udHJvbEZsb3dTdG9yYWdlRmFjdG9yeVxuICAgICAqIEBwYXJhbSB7VENvbnRyb2xGbG93UmVwbGFjZXJGYWN0b3J5fSBjb250cm9sRmxvd1JlcGxhY2VyRmFjdG9yeVxuICAgICAqIEBwYXJhbSB7VENvbnRyb2xGbG93Q3VzdG9tTm9kZUZhY3Rvcnl9IGNvbnRyb2xGbG93Q3VzdG9tTm9kZUZhY3RvcnlcbiAgICAgKiBAcGFyYW0ge0lSYW5kb21HZW5lcmF0b3J9IHJhbmRvbUdlbmVyYXRvclxuICAgICAqIEBwYXJhbSB7SU9wdGlvbnN9IG9wdGlvbnNcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvciAoXG4gICAgICAgIEBpbmplY3QoU2VydmljZUlkZW50aWZpZXJzLkZhY3RvcnlfX1RDb250cm9sRmxvd1N0b3JhZ2UpXG4gICAgICAgICAgICBjb250cm9sRmxvd1N0b3JhZ2VGYWN0b3J5OiBUQ29udHJvbEZsb3dTdG9yYWdlRmFjdG9yeSxcbiAgICAgICAgQGluamVjdChTZXJ2aWNlSWRlbnRpZmllcnMuRmFjdG9yeV9fSUNvbnRyb2xGbG93UmVwbGFjZXIpXG4gICAgICAgICAgICBjb250cm9sRmxvd1JlcGxhY2VyRmFjdG9yeTogVENvbnRyb2xGbG93UmVwbGFjZXJGYWN0b3J5LFxuICAgICAgICBAaW5qZWN0KFNlcnZpY2VJZGVudGlmaWVycy5GYWN0b3J5X19JQ29udHJvbEZsb3dDdXN0b21Ob2RlKVxuICAgICAgICAgICAgY29udHJvbEZsb3dDdXN0b21Ob2RlRmFjdG9yeTogVENvbnRyb2xGbG93Q3VzdG9tTm9kZUZhY3RvcnksXG4gICAgICAgIEBpbmplY3QoU2VydmljZUlkZW50aWZpZXJzLklSYW5kb21HZW5lcmF0b3IpIHJhbmRvbUdlbmVyYXRvcjogSVJhbmRvbUdlbmVyYXRvcixcbiAgICAgICAgQGluamVjdChTZXJ2aWNlSWRlbnRpZmllcnMuSU9wdGlvbnMpIG9wdGlvbnM6IElPcHRpb25zXG4gICAgKSB7XG4gICAgICAgIHN1cGVyKHJhbmRvbUdlbmVyYXRvciwgb3B0aW9ucyk7XG5cbiAgICAgICAgdGhpcy5jb250cm9sRmxvd1N0b3JhZ2VGYWN0b3J5ID0gY29udHJvbEZsb3dTdG9yYWdlRmFjdG9yeTtcbiAgICAgICAgdGhpcy5jb250cm9sRmxvd1JlcGxhY2VyRmFjdG9yeSA9IGNvbnRyb2xGbG93UmVwbGFjZXJGYWN0b3J5O1xuICAgICAgICB0aGlzLmNvbnRyb2xGbG93Q3VzdG9tTm9kZUZhY3RvcnkgPSBjb250cm9sRmxvd0N1c3RvbU5vZGVGYWN0b3J5O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEByZXR1cm4ge0lWaXNpdG9yfVxuICAgICAqL1xuICAgIHB1YmxpYyBnZXRWaXNpdG9yICgpOiBJVmlzaXRvciB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBsZWF2ZTogKG5vZGU6IEVTVHJlZS5Ob2RlLCBwYXJlbnROb2RlOiBFU1RyZWUuTm9kZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgTm9kZS5pc0Z1bmN0aW9uRGVjbGFyYXRpb25Ob2RlKG5vZGUpIHx8XG4gICAgICAgICAgICAgICAgICAgIE5vZGUuaXNGdW5jdGlvbkV4cHJlc3Npb25Ob2RlKG5vZGUpIHx8XG4gICAgICAgICAgICAgICAgICAgIE5vZGUuaXNBcnJvd0Z1bmN0aW9uRXhwcmVzc2lvbk5vZGUobm9kZSlcbiAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNmb3JtTm9kZShub2RlLCBwYXJlbnROb2RlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuY3Rpb25Ob2RlXG4gICAgICogQHBhcmFtIHtOb2RlfSBwYXJlbnROb2RlXG4gICAgICogQHJldHVybnMge0Z1bmN0aW9ufVxuICAgICAqL1xuICAgIHB1YmxpYyB0cmFuc2Zvcm1Ob2RlIChmdW5jdGlvbk5vZGU6IEVTVHJlZS5GdW5jdGlvbiwgcGFyZW50Tm9kZTogRVNUcmVlLk5vZGUpOiBFU1RyZWUuRnVuY3Rpb24ge1xuICAgICAgICB0aGlzLnZpc2l0ZWRGdW5jdGlvbk5vZGVzLmFkZChmdW5jdGlvbk5vZGUpO1xuXG4gICAgICAgIGlmICghTm9kZS5pc0Jsb2NrU3RhdGVtZW50Tm9kZShmdW5jdGlvbk5vZGUuYm9keSkpIHtcbiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbk5vZGU7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBob3N0Tm9kZTogVE5vZGVXaXRoQmxvY2tTdGF0ZW1lbnQgPSB0aGlzLmdldEhvc3ROb2RlKGZ1bmN0aW9uTm9kZS5ib2R5KTtcbiAgICAgICAgY29uc3QgY29udHJvbEZsb3dTdG9yYWdlOiBJU3RvcmFnZTxJQ3VzdG9tTm9kZT4gPSB0aGlzLmdldENvbnRyb2xGbG93U3RvcmFnZShob3N0Tm9kZSk7XG5cbiAgICAgICAgdGhpcy5jb250cm9sRmxvd0RhdGEuc2V0KGhvc3ROb2RlLCBjb250cm9sRmxvd1N0b3JhZ2UpO1xuICAgICAgICB0aGlzLnRyYW5zZm9ybUZ1bmN0aW9uQm9keShmdW5jdGlvbk5vZGUuYm9keSwgY29udHJvbEZsb3dTdG9yYWdlKTtcblxuICAgICAgICBpZiAoIWNvbnRyb2xGbG93U3RvcmFnZS5nZXRMZW5ndGgoKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uTm9kZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNvbnRyb2xGbG93U3RvcmFnZUN1c3RvbU5vZGU6IElDdXN0b21Ob2RlID0gdGhpcy5jb250cm9sRmxvd0N1c3RvbU5vZGVGYWN0b3J5KFxuICAgICAgICAgICAgQ29udHJvbEZsb3dDdXN0b21Ob2RlLkNvbnRyb2xGbG93U3RvcmFnZU5vZGVcbiAgICAgICAgKTtcblxuICAgICAgICBjb250cm9sRmxvd1N0b3JhZ2VDdXN0b21Ob2RlLmluaXRpYWxpemUoY29udHJvbEZsb3dTdG9yYWdlKTtcbiAgICAgICAgTm9kZUFwcGVuZGVyLnByZXBlbmROb2RlKGhvc3ROb2RlLCBjb250cm9sRmxvd1N0b3JhZ2VDdXN0b21Ob2RlLmdldE5vZGUoKSk7XG4gICAgICAgIHRoaXMuaG9zdE5vZGVzV2l0aENvbnRyb2xGbG93Tm9kZS5hZGQoaG9zdE5vZGUpO1xuXG4gICAgICAgIHJldHVybiBmdW5jdGlvbk5vZGU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtUTm9kZVdpdGhCbG9ja1N0YXRlbWVudH0gaG9zdE5vZGVcbiAgICAgKiBAcmV0dXJucyB7SVN0b3JhZ2U8SUN1c3RvbU5vZGU+fVxuICAgICAqL1xuICAgIHByaXZhdGUgZ2V0Q29udHJvbEZsb3dTdG9yYWdlIChob3N0Tm9kZTogVE5vZGVXaXRoQmxvY2tTdGF0ZW1lbnQpOiBJU3RvcmFnZTxJQ3VzdG9tTm9kZT4ge1xuICAgICAgICBjb25zdCBjb250cm9sRmxvd1N0b3JhZ2U6IElTdG9yYWdlIDxJQ3VzdG9tTm9kZT4gPSB0aGlzLmNvbnRyb2xGbG93U3RvcmFnZUZhY3RvcnkoKTtcblxuICAgICAgICBpZiAodGhpcy5jb250cm9sRmxvd0RhdGEuaGFzKGhvc3ROb2RlKSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuaG9zdE5vZGVzV2l0aENvbnRyb2xGbG93Tm9kZS5oYXMoaG9zdE5vZGUpKSB7XG4gICAgICAgICAgICAgICAgaG9zdE5vZGUuYm9keS5zaGlmdCgpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBob3N0Q29udHJvbEZsb3dTdG9yYWdlOiBJU3RvcmFnZTxJQ3VzdG9tTm9kZT4gPSA8SVN0b3JhZ2U8SUN1c3RvbU5vZGU+PnRoaXMuY29udHJvbEZsb3dEYXRhLmdldChob3N0Tm9kZSk7XG5cbiAgICAgICAgICAgIGNvbnRyb2xGbG93U3RvcmFnZS5tZXJnZVdpdGgoaG9zdENvbnRyb2xGbG93U3RvcmFnZSwgdHJ1ZSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gY29udHJvbEZsb3dTdG9yYWdlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7QmxvY2tTdGF0ZW1lbnR9IGZ1bmN0aW9uTm9kZUJvZHlcbiAgICAgKiBAcmV0dXJucyB7VE5vZGVXaXRoQmxvY2tTdGF0ZW1lbnR9XG4gICAgICovXG4gICAgcHJpdmF0ZSBnZXRIb3N0Tm9kZSAoZnVuY3Rpb25Ob2RlQm9keTogRVNUcmVlLkJsb2NrU3RhdGVtZW50KTogVE5vZGVXaXRoQmxvY2tTdGF0ZW1lbnQge1xuICAgICAgICBjb25zdCBibG9ja1Njb3Blc09mTm9kZTogVE5vZGVXaXRoQmxvY2tTdGF0ZW1lbnRbXSA9IE5vZGVVdGlscy5nZXRCbG9ja1Njb3Blc09mTm9kZShmdW5jdGlvbk5vZGVCb2R5KTtcblxuICAgICAgICBpZiAoYmxvY2tTY29wZXNPZk5vZGUubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICByZXR1cm4gZnVuY3Rpb25Ob2RlQm9keTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGJsb2NrU2NvcGVzT2ZOb2RlLnBvcCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGJsb2NrU2NvcGVzT2ZOb2RlLmxlbmd0aCA+IEZ1bmN0aW9uQ29udHJvbEZsb3dUcmFuc2Zvcm1lci5ob3N0Tm9kZVNlYXJjaE1pbkRlcHRoKSB7XG4gICAgICAgICAgICBibG9ja1Njb3Blc09mTm9kZS5zcGxpY2UoMCwgRnVuY3Rpb25Db250cm9sRmxvd1RyYW5zZm9ybWVyLmhvc3ROb2RlU2VhcmNoTWluRGVwdGgpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGJsb2NrU2NvcGVzT2ZOb2RlLmxlbmd0aCA+IEZ1bmN0aW9uQ29udHJvbEZsb3dUcmFuc2Zvcm1lci5ob3N0Tm9kZVNlYXJjaE1heERlcHRoKSB7XG4gICAgICAgICAgICBibG9ja1Njb3Blc09mTm9kZS5sZW5ndGggPSBGdW5jdGlvbkNvbnRyb2xGbG93VHJhbnNmb3JtZXIuaG9zdE5vZGVTZWFyY2hNYXhEZXB0aDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLnJhbmRvbUdlbmVyYXRvci5nZXRSYW5kb21HZW5lcmF0b3IoKS5waWNrb25lKGJsb2NrU2NvcGVzT2ZOb2RlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge05vZGV9IG5vZGVcbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBwcml2YXRlIGlzVmlzaXRlZEZ1bmN0aW9uTm9kZSAobm9kZTogRVNUcmVlLk5vZGUpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIE5vZGUuaXNGdW5jdGlvbkRlY2xhcmF0aW9uTm9kZShub2RlKSB8fFxuICAgICAgICAgICAgTm9kZS5pc0Z1bmN0aW9uRXhwcmVzc2lvbk5vZGUobm9kZSkgfHxcbiAgICAgICAgICAgIE5vZGUuaXNBcnJvd0Z1bmN0aW9uRXhwcmVzc2lvbk5vZGUobm9kZSlcbiAgICAgICAgKSAmJiB0aGlzLnZpc2l0ZWRGdW5jdGlvbk5vZGVzLmhhcyhub2RlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge0Jsb2NrU3RhdGVtZW50fSBmdW5jdGlvbk5vZGVCb2R5XG4gICAgICogQHBhcmFtIHtJU3RvcmFnZTxJQ3VzdG9tTm9kZT59IGNvbnRyb2xGbG93U3RvcmFnZVxuICAgICAqL1xuICAgIHByaXZhdGUgdHJhbnNmb3JtRnVuY3Rpb25Cb2R5IChmdW5jdGlvbk5vZGVCb2R5OiBFU1RyZWUuQmxvY2tTdGF0ZW1lbnQsIGNvbnRyb2xGbG93U3RvcmFnZTogSVN0b3JhZ2U8SUN1c3RvbU5vZGU+KTogdm9pZCB7XG4gICAgICAgIGVzdHJhdmVyc2UucmVwbGFjZShmdW5jdGlvbk5vZGVCb2R5LCB7XG4gICAgICAgICAgICBlbnRlcjogKG5vZGU6IEVTVHJlZS5Ob2RlLCBwYXJlbnROb2RlOiBFU1RyZWUuTm9kZSk6IGFueSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNWaXNpdGVkRnVuY3Rpb25Ob2RlKG5vZGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBlc3RyYXZlcnNlLlZpc2l0b3JPcHRpb24uU2tpcDtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoIUZ1bmN0aW9uQ29udHJvbEZsb3dUcmFuc2Zvcm1lci5jb250cm9sRmxvd1JlcGxhY2Vyc01hcC5oYXMobm9kZS50eXBlKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAodGhpcy5yYW5kb21HZW5lcmF0b3IuZ2V0TWF0aFJhbmRvbSgpID4gdGhpcy5vcHRpb25zLmNvbnRyb2xGbG93RmxhdHRlbmluZ1RocmVzaG9sZCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCBjb250cm9sRmxvd1JlcGxhY2VyTmFtZTogQ29udHJvbEZsb3dSZXBsYWNlciA9IDxDb250cm9sRmxvd1JlcGxhY2VyPkZ1bmN0aW9uQ29udHJvbEZsb3dUcmFuc2Zvcm1lclxuICAgICAgICAgICAgICAgICAgICAuY29udHJvbEZsb3dSZXBsYWNlcnNNYXAuZ2V0KG5vZGUudHlwZSk7XG5cbiAgICAgICAgICAgICAgICBpZiAoY29udHJvbEZsb3dSZXBsYWNlck5hbWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAuLi50aGlzLmNvbnRyb2xGbG93UmVwbGFjZXJGYWN0b3J5KGNvbnRyb2xGbG93UmVwbGFjZXJOYW1lKS5yZXBsYWNlKG5vZGUsIHBhcmVudE5vZGUsIGNvbnRyb2xGbG93U3RvcmFnZSksXG4gICAgICAgICAgICAgICAgICAgIHBhcmVudE5vZGVcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=