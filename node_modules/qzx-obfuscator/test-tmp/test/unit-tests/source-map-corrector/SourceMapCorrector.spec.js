"use strict";

Object.defineProperty(exports, "__esModule", { value: true });
var ServiceIdentifiers_1 = require("../../../src/container/ServiceIdentifiers");
var chai_1 = require("chai");
var SourceMapMode_1 = require("../../../src/enums/SourceMapMode");
var InversifyContainerFacade_1 = require("../../../src/container/InversifyContainerFacade");
function getCorrectedObfuscationResult(obfuscatedCode, sourceMap, sourceMapBaseUrl, sourceMapFileName, sourceMapMode) {
    var inversifyContainerFacade = new InversifyContainerFacade_1.InversifyContainerFacade();
    inversifyContainerFacade.load('', {
        sourceMap: true,
        sourceMapBaseUrl: sourceMapBaseUrl,
        sourceMapFileName: sourceMapFileName,
        sourceMapMode: sourceMapMode
    });
    var sourceMapCorrector = inversifyContainerFacade.get(ServiceIdentifiers_1.ServiceIdentifiers.ISourceMapCorrector);
    return sourceMapCorrector.correct(obfuscatedCode, sourceMap);
}
describe('SourceMapCorrector', function () {
    describe('correct (): IObfuscationResult', function () {
        var expectedObfuscatedCode = 'var test = 1;';
        var sourceMap = 'test';
        var obfuscationResult = void 0,
            obfuscatedCode = void 0;
        describe('source map doest\'t exist', function () {
            before(function () {
                obfuscationResult = getCorrectedObfuscationResult(expectedObfuscatedCode, '', '', '', SourceMapMode_1.SourceMapMode.Separate);
                obfuscatedCode = obfuscationResult.getObfuscatedCode();
            });
            it('should return untouched obfuscated code', function () {
                chai_1.assert.equal(obfuscatedCode, expectedObfuscatedCode);
            });
        });
        describe('source map is set, source map mode is `inline`', function () {
            var regExp = /data:application\/json;base64/;
            before(function () {
                obfuscationResult = getCorrectedObfuscationResult(expectedObfuscatedCode, sourceMap, '', '', SourceMapMode_1.SourceMapMode.Inline);
                obfuscatedCode = obfuscationResult.getObfuscatedCode();
            });
            it('should add source map to obfuscated code as base64 encoded string', function () {
                chai_1.assert.match(obfuscatedCode, regExp);
            });
        });
        describe('source map mode is `separate`', function () {
            var regExp = /sourceMappingURL=http:\/\/example\.com\/output\.js\.map/;
            before(function () {
                obfuscationResult = getCorrectedObfuscationResult(expectedObfuscatedCode, sourceMap, 'http://example.com', 'output.js.map', SourceMapMode_1.SourceMapMode.Separate);
                obfuscatedCode = obfuscationResult.getObfuscatedCode();
            });
            it('should add source map import to obfuscated code', function () {
                chai_1.assert.match(obfuscatedCode, regExp);
            });
        });
        describe('source map mode is `separate`, `sourceMapUrl` is not set', function () {
            before(function () {
                obfuscationResult = getCorrectedObfuscationResult(expectedObfuscatedCode, sourceMap, '', '', SourceMapMode_1.SourceMapMode.Separate);
                obfuscatedCode = obfuscationResult.getObfuscatedCode();
            });
            it('should not touch obfuscated code', function () {
                chai_1.assert.equal(obfuscatedCode, expectedObfuscatedCode);
            });
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU291cmNlTWFwQ29ycmVjdG9yLnNwZWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi90ZXN0L3VuaXQtdGVzdHMvc291cmNlLW1hcC1jb3JyZWN0b3IvU291cmNlTWFwQ29ycmVjdG9yLnNwZWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsbUNBQStFO0FBRS9FLHFCQUE4QjtBQVE5Qiw4QkFBaUU7QUFFakUseUNBQTJGO0FBUzNGLHVDQUNJLEFBQXNCLGdCQUN0QixBQUFpQixXQUNqQixBQUF3QixrQkFDeEIsQUFBeUIsbUJBQ3pCLEFBQTZCO0FBRTdCLFFBQU0sQUFBd0IsMkJBQThCLElBQUksMkJBQXdCLEFBQUUsQUFBQztBQUUzRixBQUF3Qiw2QkFBQyxBQUFJLEtBQ3pCLEFBQUU7QUFFRSxBQUFTLG1CQUFFLEFBQUk7QUFDZixBQUFnQiwwQkFBRSxBQUFnQjtBQUNsQyxBQUFpQiwyQkFBRSxBQUFpQjtBQUNwQyxBQUFhLHVCQUFFLEFBQWEsQUFDL0IsQUFDSixBQUFDO0FBTkU7QUFRSixRQUFNLEFBQWtCLHFCQUF3QixBQUF3Qix5QkFDbkUsQUFBRyxJQUFzQixxQkFBa0IsbUJBQUMsQUFBbUIsQUFBQyxBQUFDO0FBRXRFLEFBQU0sV0FBQyxBQUFrQixtQkFBQyxBQUFPLFFBQUMsQUFBYyxnQkFBRSxBQUFTLEFBQUMsQUFBQyxBQUNqRTtBQUFDO0FBRUQsQUFBUSxTQUFDLEFBQW9CLHNCQUFFO0FBQzNCLEFBQVEsYUFBQyxBQUFnQyxrQ0FBRTtBQUN2QyxZQUFNLEFBQXNCLHlCQUFXLEFBQWUsQUFBQztBQUN2RCxZQUFNLEFBQVMsWUFBVyxBQUFNLEFBQUM7QUFFakMsWUFBSSxBQUFxQztZQUNyQyxBQUFzQixBQUFDO0FBRTNCLEFBQVEsaUJBQUMsQUFBMkIsNkJBQUU7QUFDbEMsQUFBTSxtQkFBQztBQUNILEFBQWlCLG9DQUFHLEFBQTZCLDhCQUM3QyxBQUFzQix3QkFDdEIsQUFBRSxJQUNGLEFBQUUsSUFDRixBQUFFLElBQ0YsZ0JBQWEsY0FBQyxBQUFRLEFBQ3pCLEFBQUM7QUFDRixBQUFjLGlDQUFHLEFBQWlCLGtCQUFDLEFBQWlCLEFBQUUsQUFBQyxBQUMzRDtBQUFDLEFBQUMsQUFBQztBQUVILEFBQUUsZUFBQyxBQUF5QywyQ0FBRTtBQUMxQyx1QkFBTSxPQUFDLEFBQUssTUFBQyxBQUFjLGdCQUFFLEFBQXNCLEFBQUMsQUFBQyxBQUN6RDtBQUFDLEFBQUMsQUFBQyxBQUNQO0FBQUMsQUFBQyxBQUFDO0FBRUgsQUFBUSxpQkFBQyxBQUFnRCxrREFBRTtBQUN2RCxnQkFBTSxBQUFNLFNBQVcsQUFBK0IsQUFBQztBQUV2RCxBQUFNLG1CQUFDO0FBQ0gsQUFBaUIsb0NBQUcsQUFBNkIsOEJBQzdDLEFBQXNCLHdCQUN0QixBQUFTLFdBQ1QsQUFBRSxJQUNGLEFBQUUsSUFDRixnQkFBYSxjQUFDLEFBQU0sQUFDdkIsQUFBQztBQUNGLEFBQWMsaUNBQUcsQUFBaUIsa0JBQUMsQUFBaUIsQUFBRSxBQUFDLEFBQzNEO0FBQUMsQUFBQyxBQUFDO0FBRUgsQUFBRSxlQUFDLEFBQW1FLHFFQUFFO0FBQ3BFLHVCQUFNLE9BQUMsQUFBSyxNQUFDLEFBQWMsZ0JBQUUsQUFBTSxBQUFDLEFBQUMsQUFDekM7QUFBQyxBQUFDLEFBQUMsQUFDUDtBQUFDLEFBQUMsQUFBQztBQUVILEFBQVEsaUJBQUMsQUFBK0IsaUNBQUU7QUFDdEMsZ0JBQU0sQUFBTSxTQUFXLEFBQXlELEFBQUM7QUFFakYsQUFBTSxtQkFBQztBQUNILEFBQWlCLG9DQUFHLEFBQTZCLDhCQUM3QyxBQUFzQix3QkFDdEIsQUFBUyxXQUNULEFBQW9CLHNCQUNwQixBQUFlLGlCQUNmLGdCQUFhLGNBQUMsQUFBUSxBQUN6QixBQUFDO0FBQ0YsQUFBYyxpQ0FBRyxBQUFpQixrQkFBQyxBQUFpQixBQUFFLEFBQUMsQUFDM0Q7QUFBQyxBQUFDLEFBQUM7QUFFSCxBQUFFLGVBQUMsQUFBaUQsbURBQUU7QUFDbEQsdUJBQU0sT0FBQyxBQUFLLE1BQUMsQUFBYyxnQkFBRSxBQUFNLEFBQUMsQUFBQyxBQUN6QztBQUFDLEFBQUMsQUFBQyxBQUNQO0FBQUMsQUFBQyxBQUFDO0FBRUgsQUFBUSxpQkFBQyxBQUEwRCw0REFBRTtBQUNqRSxBQUFNLG1CQUFDO0FBQ0gsQUFBaUIsb0NBQUcsQUFBNkIsOEJBQzdDLEFBQXNCLHdCQUN0QixBQUFTLFdBQ1QsQUFBRSxJQUNGLEFBQUUsSUFDRixnQkFBYSxjQUFDLEFBQVEsQUFDekIsQUFBQztBQUNGLEFBQWMsaUNBQUcsQUFBaUIsa0JBQUMsQUFBaUIsQUFBRSxBQUFDLEFBQzNEO0FBQUMsQUFBQyxBQUFDO0FBRUgsQUFBRSxlQUFDLEFBQWtDLG9DQUFFO0FBQ25DLHVCQUFNLE9BQUMsQUFBSyxNQUFDLEFBQWMsZ0JBQUUsQUFBc0IsQUFBQyxBQUFDLEFBQ3pEO0FBQUMsQUFBQyxBQUFDLEFBQ1A7QUFBQyxBQUFDLEFBQUMsQUFDUDtBQUFDLEFBQUMsQUFBQyxBQUNQO0FBQUMsQUFBQyxBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2VydmljZUlkZW50aWZpZXJzIH0gZnJvbSAnLi4vLi4vLi4vc3JjL2NvbnRhaW5lci9TZXJ2aWNlSWRlbnRpZmllcnMnO1xuXG5pbXBvcnQgeyBhc3NlcnQgfSBmcm9tICdjaGFpJztcblxuaW1wb3J0IHsgVFNvdXJjZU1hcE1vZGUgfSBmcm9tICcuLi8uLi8uLi9zcmMvdHlwZXMvVFNvdXJjZU1hcE1vZGUnO1xuXG5pbXBvcnQgeyBJSW52ZXJzaWZ5Q29udGFpbmVyRmFjYWRlIH0gZnJvbSAnLi4vLi4vLi4vc3JjL2ludGVyZmFjZXMvY29udGFpbmVyL0lJbnZlcnNpZnlDb250YWluZXJGYWNhZGUnO1xuaW1wb3J0IHsgSU9iZnVzY2F0aW9uUmVzdWx0IH0gZnJvbSAnLi4vLi4vLi4vc3JjL2ludGVyZmFjZXMvSU9iZnVzY2F0aW9uUmVzdWx0JztcbmltcG9ydCB7IElTb3VyY2VNYXBDb3JyZWN0b3IgfSBmcm9tICcuLi8uLi8uLi9zcmMvaW50ZXJmYWNlcy9JU291cmNlTWFwQ29ycmVjdG9yJztcblxuaW1wb3J0IHsgU291cmNlTWFwTW9kZSB9IGZyb20gJy4uLy4uLy4uL3NyYy9lbnVtcy9Tb3VyY2VNYXBNb2RlJztcblxuaW1wb3J0IHsgSW52ZXJzaWZ5Q29udGFpbmVyRmFjYWRlIH0gZnJvbSAnLi4vLi4vLi4vc3JjL2NvbnRhaW5lci9JbnZlcnNpZnlDb250YWluZXJGYWNhZGUnO1xuXG4vKipcbiAqIEBwYXJhbSBvYmZ1c2NhdGVkQ29kZVxuICogQHBhcmFtIHNvdXJjZU1hcFxuICogQHBhcmFtIHNvdXJjZU1hcEJhc2VVcmxcbiAqIEBwYXJhbSBzb3VyY2VNYXBGaWxlTmFtZVxuICogQHBhcmFtIHNvdXJjZU1hcE1vZGVcbiAqL1xuZnVuY3Rpb24gZ2V0Q29ycmVjdGVkT2JmdXNjYXRpb25SZXN1bHQgKFxuICAgIG9iZnVzY2F0ZWRDb2RlOiBzdHJpbmcsXG4gICAgc291cmNlTWFwOiBzdHJpbmcsXG4gICAgc291cmNlTWFwQmFzZVVybDogc3RyaW5nLFxuICAgIHNvdXJjZU1hcEZpbGVOYW1lOiBzdHJpbmcsXG4gICAgc291cmNlTWFwTW9kZTogVFNvdXJjZU1hcE1vZGVcbik6IElPYmZ1c2NhdGlvblJlc3VsdCB7XG4gICAgY29uc3QgaW52ZXJzaWZ5Q29udGFpbmVyRmFjYWRlOiBJSW52ZXJzaWZ5Q29udGFpbmVyRmFjYWRlID0gbmV3IEludmVyc2lmeUNvbnRhaW5lckZhY2FkZSgpO1xuXG4gICAgaW52ZXJzaWZ5Q29udGFpbmVyRmFjYWRlLmxvYWQoXG4gICAgICAgICcnLFxuICAgICAgICB7XG4gICAgICAgICAgICBzb3VyY2VNYXA6IHRydWUsXG4gICAgICAgICAgICBzb3VyY2VNYXBCYXNlVXJsOiBzb3VyY2VNYXBCYXNlVXJsLFxuICAgICAgICAgICAgc291cmNlTWFwRmlsZU5hbWU6IHNvdXJjZU1hcEZpbGVOYW1lLFxuICAgICAgICAgICAgc291cmNlTWFwTW9kZTogc291cmNlTWFwTW9kZVxuICAgICAgICB9XG4gICAgKTtcblxuICAgIGNvbnN0IHNvdXJjZU1hcENvcnJlY3RvcjogSVNvdXJjZU1hcENvcnJlY3RvciA9IGludmVyc2lmeUNvbnRhaW5lckZhY2FkZVxuICAgICAgICAuZ2V0PElTb3VyY2VNYXBDb3JyZWN0b3I+KFNlcnZpY2VJZGVudGlmaWVycy5JU291cmNlTWFwQ29ycmVjdG9yKTtcblxuICAgIHJldHVybiBzb3VyY2VNYXBDb3JyZWN0b3IuY29ycmVjdChvYmZ1c2NhdGVkQ29kZSwgc291cmNlTWFwKTtcbn1cblxuZGVzY3JpYmUoJ1NvdXJjZU1hcENvcnJlY3RvcicsICgpID0+IHtcbiAgICBkZXNjcmliZSgnY29ycmVjdCAoKTogSU9iZnVzY2F0aW9uUmVzdWx0JywgKCkgPT4ge1xuICAgICAgICBjb25zdCBleHBlY3RlZE9iZnVzY2F0ZWRDb2RlOiBzdHJpbmcgPSAndmFyIHRlc3QgPSAxOyc7XG4gICAgICAgIGNvbnN0IHNvdXJjZU1hcDogc3RyaW5nID0gJ3Rlc3QnO1xuXG4gICAgICAgIGxldCBvYmZ1c2NhdGlvblJlc3VsdDogSU9iZnVzY2F0aW9uUmVzdWx0LFxuICAgICAgICAgICAgb2JmdXNjYXRlZENvZGU6IHN0cmluZztcblxuICAgICAgICBkZXNjcmliZSgnc291cmNlIG1hcCBkb2VzdFxcJ3QgZXhpc3QnLCAoKSA9PiB7XG4gICAgICAgICAgICBiZWZvcmUoKCkgPT4ge1xuICAgICAgICAgICAgICAgIG9iZnVzY2F0aW9uUmVzdWx0ID0gZ2V0Q29ycmVjdGVkT2JmdXNjYXRpb25SZXN1bHQoXG4gICAgICAgICAgICAgICAgICAgIGV4cGVjdGVkT2JmdXNjYXRlZENvZGUsXG4gICAgICAgICAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgICAgICAgICAnJyxcbiAgICAgICAgICAgICAgICAgICAgJycsXG4gICAgICAgICAgICAgICAgICAgIFNvdXJjZU1hcE1vZGUuU2VwYXJhdGVcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIG9iZnVzY2F0ZWRDb2RlID0gb2JmdXNjYXRpb25SZXN1bHQuZ2V0T2JmdXNjYXRlZENvZGUoKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpdCgnc2hvdWxkIHJldHVybiB1bnRvdWNoZWQgb2JmdXNjYXRlZCBjb2RlJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGFzc2VydC5lcXVhbChvYmZ1c2NhdGVkQ29kZSwgZXhwZWN0ZWRPYmZ1c2NhdGVkQ29kZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgZGVzY3JpYmUoJ3NvdXJjZSBtYXAgaXMgc2V0LCBzb3VyY2UgbWFwIG1vZGUgaXMgYGlubGluZWAnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZWdFeHA6IFJlZ0V4cCA9IC9kYXRhOmFwcGxpY2F0aW9uXFwvanNvbjtiYXNlNjQvO1xuXG4gICAgICAgICAgICBiZWZvcmUoKCkgPT4ge1xuICAgICAgICAgICAgICAgIG9iZnVzY2F0aW9uUmVzdWx0ID0gZ2V0Q29ycmVjdGVkT2JmdXNjYXRpb25SZXN1bHQoXG4gICAgICAgICAgICAgICAgICAgIGV4cGVjdGVkT2JmdXNjYXRlZENvZGUsXG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZU1hcCxcbiAgICAgICAgICAgICAgICAgICAgJycsXG4gICAgICAgICAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgICAgICAgICBTb3VyY2VNYXBNb2RlLklubGluZVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgb2JmdXNjYXRlZENvZGUgPSBvYmZ1c2NhdGlvblJlc3VsdC5nZXRPYmZ1c2NhdGVkQ29kZSgpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGl0KCdzaG91bGQgYWRkIHNvdXJjZSBtYXAgdG8gb2JmdXNjYXRlZCBjb2RlIGFzIGJhc2U2NCBlbmNvZGVkIHN0cmluZycsICgpID0+IHtcbiAgICAgICAgICAgICAgICBhc3NlcnQubWF0Y2gob2JmdXNjYXRlZENvZGUsIHJlZ0V4cCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgZGVzY3JpYmUoJ3NvdXJjZSBtYXAgbW9kZSBpcyBgc2VwYXJhdGVgJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVnRXhwOiBSZWdFeHAgPSAvc291cmNlTWFwcGluZ1VSTD1odHRwOlxcL1xcL2V4YW1wbGVcXC5jb21cXC9vdXRwdXRcXC5qc1xcLm1hcC87XG5cbiAgICAgICAgICAgIGJlZm9yZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgb2JmdXNjYXRpb25SZXN1bHQgPSBnZXRDb3JyZWN0ZWRPYmZ1c2NhdGlvblJlc3VsdChcbiAgICAgICAgICAgICAgICAgICAgZXhwZWN0ZWRPYmZ1c2NhdGVkQ29kZSxcbiAgICAgICAgICAgICAgICAgICAgc291cmNlTWFwLFxuICAgICAgICAgICAgICAgICAgICAnaHR0cDovL2V4YW1wbGUuY29tJyxcbiAgICAgICAgICAgICAgICAgICAgJ291dHB1dC5qcy5tYXAnLFxuICAgICAgICAgICAgICAgICAgICBTb3VyY2VNYXBNb2RlLlNlcGFyYXRlXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBvYmZ1c2NhdGVkQ29kZSA9IG9iZnVzY2F0aW9uUmVzdWx0LmdldE9iZnVzY2F0ZWRDb2RlKCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaXQoJ3Nob3VsZCBhZGQgc291cmNlIG1hcCBpbXBvcnQgdG8gb2JmdXNjYXRlZCBjb2RlJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGFzc2VydC5tYXRjaChvYmZ1c2NhdGVkQ29kZSwgcmVnRXhwKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBkZXNjcmliZSgnc291cmNlIG1hcCBtb2RlIGlzIGBzZXBhcmF0ZWAsIGBzb3VyY2VNYXBVcmxgIGlzIG5vdCBzZXQnLCAoKSA9PiB7XG4gICAgICAgICAgICBiZWZvcmUoKCkgPT4ge1xuICAgICAgICAgICAgICAgIG9iZnVzY2F0aW9uUmVzdWx0ID0gZ2V0Q29ycmVjdGVkT2JmdXNjYXRpb25SZXN1bHQoXG4gICAgICAgICAgICAgICAgICAgIGV4cGVjdGVkT2JmdXNjYXRlZENvZGUsXG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZU1hcCxcbiAgICAgICAgICAgICAgICAgICAgJycsXG4gICAgICAgICAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgICAgICAgICBTb3VyY2VNYXBNb2RlLlNlcGFyYXRlXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBvYmZ1c2NhdGVkQ29kZSA9IG9iZnVzY2F0aW9uUmVzdWx0LmdldE9iZnVzY2F0ZWRDb2RlKCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaXQoJ3Nob3VsZCBub3QgdG91Y2ggb2JmdXNjYXRlZCBjb2RlJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGFzc2VydC5lcXVhbChvYmZ1c2NhdGVkQ29kZSwgZXhwZWN0ZWRPYmZ1c2NhdGVkQ29kZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59KTtcbiJdfQ==