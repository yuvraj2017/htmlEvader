"use strict";

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

Object.defineProperty(exports, "__esModule", { value: true });
var chai_1 = require("chai");
var ServiceIdentifiers_1 = require("../../../src/container/ServiceIdentifiers");
var ArrayStorage_1 = require("../../../src/storages/ArrayStorage");
var InversifyContainerFacade_1 = require("../../../src/container/InversifyContainerFacade");

var ConcreteStorage = function (_ArrayStorage_1$Array) {
    _inherits(ConcreteStorage, _ArrayStorage_1$Array);

    function ConcreteStorage() {
        _classCallCheck(this, ConcreteStorage);

        var inversifyContainerFacade = new InversifyContainerFacade_1.InversifyContainerFacade();
        inversifyContainerFacade.load('', {});
        return _possibleConstructorReturn(this, (ConcreteStorage.__proto__ || Object.getPrototypeOf(ConcreteStorage)).call(this, inversifyContainerFacade.get(ServiceIdentifiers_1.ServiceIdentifiers.IRandomGenerator)));
    }

    return ConcreteStorage;
}(ArrayStorage_1.ArrayStorage);

var getStorageInstance = function getStorageInstance() {
    var storage = new ConcreteStorage();
    storage.initialize();
    return storage;
};
describe('ArrayStorage', function () {
    var storageKey = 0;
    var storageValue = 'foo';
    var storage = void 0;
    describe('initialize (...args: any[]): void', function () {
        var expectedError = Error;
        var testFunc = void 0;
        before(function () {
            storage = new ConcreteStorage();
            testFunc = function testFunc() {
                return storage.set(storageKey, storageValue);
            };
        });
        it('should throws an error when storage isn\'t initialized', function () {
            chai_1.assert.throws(testFunc, expectedError);
        });
    });
    describe('getStorage (): T[]', function () {
        var expectedInstanceOf = Array;
        var arrayStorage = void 0;
        before(function () {
            storage = getStorageInstance();
            arrayStorage = storage.getStorage();
        });
        it('should return storage', function () {
            chai_1.assert.instanceOf(arrayStorage, expectedInstanceOf);
        });
    });
    describe('get (key: number): T', function () {
        describe('variant #1: value exist', function () {
            var expectedValue = storageValue;
            var value = void 0;
            before(function () {
                storage = getStorageInstance();
                storage.set(storageKey, storageValue);
                value = storage.get(storageKey);
            });
            it('should return value from storage by key', function () {
                chai_1.assert.equal(value, expectedValue);
            });
        });
        describe('variant #2: value isn\'t exist', function () {
            var expectedError = Error;
            var testFunc = void 0;
            before(function () {
                storage = getStorageInstance();
                testFunc = function testFunc() {
                    return storage.get(storageKey);
                };
            });
            it('should throw an error', function () {
                chai_1.assert.throws(testFunc, expectedError);
            });
        });
    });
    describe('getLength (): number', function () {
        var expectedStorageLength = 1;
        var storageLength = void 0;
        before(function () {
            storage = getStorageInstance();
            storage.set(storageKey, storageValue);
            storageLength = storage.getLength();
        });
        it('should return length of storage', function () {
            chai_1.assert.equal(storageLength, expectedStorageLength);
        });
    });
    describe('getKeyOf (value: T): number | null', function () {
        var key = void 0;
        describe('variant #1', function () {
            before(function () {
                storage = getStorageInstance();
                storage.set(storageKey, storageValue);
                key = storage.getKeyOf(storageValue);
            });
            it('should return key of string value', function () {
                chai_1.assert.equal(key, storageKey);
            });
        });
        describe('variant #2', function () {
            var object = {
                foo: 'bar'
            };
            before(function () {
                storage = getStorageInstance();
                storage.set(storageKey, object);
                key = storage.getKeyOf(object);
            });
            it('should return key of object if objects in `set` and `get` are two same objects', function () {
                chai_1.assert.equal(key, storageKey);
            });
        });
        describe('variant #3', function () {
            var expectedKey = null;
            var object = {
                foo: 'bar'
            };
            before(function () {
                storage = getStorageInstance();
                storage.set(storageKey, object);
                key = storage.getKeyOf(Object.assign({}, object));
            });
            it('should return `null` if objects in `set` and `get` are two different objects', function () {
                chai_1.assert.equal(key, expectedKey);
            });
        });
    });
    describe('set (key: number, value: T): void', function () {
        var value = void 0;
        before(function () {
            storage = getStorageInstance();
            storage.set(storageKey, storageValue);
            value = storage.get(storageKey);
        });
        it('should set value to the storage', function () {
            chai_1.assert.equal(value, storageValue);
        });
    });
    describe('mergeWith (storage: this, mergeId: boolean = false): void', function () {
        var secondStorageKey = 1;
        var secondStorageValue = 'bar';
        var expectedArray = [storageValue, secondStorageValue];
        var array = void 0;
        before(function () {
            storage = getStorageInstance();
            storage.set(storageKey, storageValue);
            var secondStorage = getStorageInstance();
            secondStorage.set(secondStorageKey, secondStorageValue);
            storage.mergeWith(secondStorage, false);
            array = storage.getStorage();
        });
        it('should merge two storages', function () {
            chai_1.assert.deepEqual(array, expectedArray);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXJyYXlTdG9yYWdlLnNwZWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi90ZXN0L3VuaXQtdGVzdHMvc3RvcmFnZXMvQXJyYXlTdG9yYWdlLnNwZWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEscUJBQThCO0FBRTlCLG1DQUErRTtBQU0vRSw2QkFBa0U7QUFDbEUseUNBQTJGLEFBRTNGOztJQUFzQjs7O0FBQ2xCOzs7QUFDSSxZQUFNLEFBQXdCLDJCQUE4QixJQUFJLDJCQUF3QixBQUFFLEFBQUM7QUFFM0YsQUFBd0IsaUNBQUMsQUFBSSxLQUFDLEFBQUUsSUFBRSxBQUFFLEFBQUMsQUFBQyxBQUV0QyxBQUFLO2lJQUFDLEFBQXdCLHlCQUFDLEFBQUcsSUFBbUIscUJBQWtCLG1CQUFDLEFBQWdCLEFBQUMsQUFBQyxBQUFDLEFBQy9GO0FBQUMsQUFDSjs7O0VBUjZCLGVBQXFCOztBQWFuRCxJQUFNLEFBQWtCLHFCQUFHO0FBQ3ZCLFFBQU0sQUFBTyxVQUFrQixJQUFJLEFBQWUsQUFBRSxBQUFDO0FBRXJELEFBQU8sWUFBQyxBQUFVLEFBQUUsQUFBQztBQUVyQixBQUFNLFdBQUMsQUFBTyxBQUFDLEFBQ25CO0FBQUMsQUFBQztBQUVGLEFBQVEsU0FBQyxBQUFjLGdCQUFFO0FBQ3JCLFFBQU0sQUFBVSxhQUFXLEFBQUMsQUFBQztBQUM3QixRQUFNLEFBQVksZUFBVyxBQUFLLEFBQUM7QUFFbkMsUUFBSSxBQUF1QixBQUFDO0FBRTVCLEFBQVEsYUFBQyxBQUFtQyxxQ0FBRTtBQUMxQyxZQUFNLEFBQWEsZ0JBQXFCLEFBQUssQUFBQztBQUU5QyxZQUFJLEFBQW9CLEFBQUM7QUFFekIsQUFBTSxlQUFDO0FBQ0gsQUFBTyxzQkFBRyxJQUFJLEFBQWUsQUFBRSxBQUFDO0FBQ2hDLEFBQVE7QUFBRyx1QkFBTSxBQUFPLFFBQUMsQUFBRyxJQUFDLEFBQVUsWUFBRSxBQUFZLEFBQUMsQUFBQyxBQUMzRDs7QUFB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QUFDLEFBQVMsVUFBQyxBQUFLLE9BQUUsQUFBYSxBQUFDLEFBQUMsQUFDM0M7QUFBQyxBQUFDLEFBQUMsQUFDUDtBQUFDLEFBQUMsQUFBQyxBQUNQO0FBQUMsQUFBQyxBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYXNzZXJ0IH0gZnJvbSAnY2hhaSc7XG5cbmltcG9ydCB7IFNlcnZpY2VJZGVudGlmaWVycyB9IGZyb20gJy4uLy4uLy4uL3NyYy9jb250YWluZXIvU2VydmljZUlkZW50aWZpZXJzJztcblxuaW1wb3J0IHsgSUludmVyc2lmeUNvbnRhaW5lckZhY2FkZSB9IGZyb20gJy4uLy4uLy4uL3NyYy9pbnRlcmZhY2VzL2NvbnRhaW5lci9JSW52ZXJzaWZ5Q29udGFpbmVyRmFjYWRlJztcbmltcG9ydCB7IElSYW5kb21HZW5lcmF0b3IgfSBmcm9tICcuLi8uLi8uLi9zcmMvaW50ZXJmYWNlcy91dGlscy9JUmFuZG9tR2VuZXJhdG9yJztcbmltcG9ydCB7IElTdG9yYWdlIH0gZnJvbSAnLi4vLi4vLi4vc3JjL2ludGVyZmFjZXMvc3RvcmFnZXMvSVN0b3JhZ2UnO1xuXG5pbXBvcnQgeyBBcnJheVN0b3JhZ2UgfSBmcm9tICcuLi8uLi8uLi9zcmMvc3RvcmFnZXMvQXJyYXlTdG9yYWdlJztcbmltcG9ydCB7IEludmVyc2lmeUNvbnRhaW5lckZhY2FkZSB9IGZyb20gJy4uLy4uLy4uL3NyYy9jb250YWluZXIvSW52ZXJzaWZ5Q29udGFpbmVyRmFjYWRlJztcblxuY2xhc3MgQ29uY3JldGVTdG9yYWdlIGV4dGVuZHMgQXJyYXlTdG9yYWdlIDxzdHJpbmc+IHtcbiAgICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgICAgIGNvbnN0IGludmVyc2lmeUNvbnRhaW5lckZhY2FkZTogSUludmVyc2lmeUNvbnRhaW5lckZhY2FkZSA9IG5ldyBJbnZlcnNpZnlDb250YWluZXJGYWNhZGUoKTtcblxuICAgICAgICBpbnZlcnNpZnlDb250YWluZXJGYWNhZGUubG9hZCgnJywge30pO1xuXG4gICAgICAgIHN1cGVyKGludmVyc2lmeUNvbnRhaW5lckZhY2FkZS5nZXQ8SVJhbmRvbUdlbmVyYXRvcj4oU2VydmljZUlkZW50aWZpZXJzLklSYW5kb21HZW5lcmF0b3IpKTtcbiAgICB9XG59XG5cbi8qKlxuICogQHR5cGUge0lTdG9yYWdlPGFueT59XG4gKi9cbmNvbnN0IGdldFN0b3JhZ2VJbnN0YW5jZSA9ICgpOiBJU3RvcmFnZSA8YW55PiA9PiB7XG4gICAgY29uc3Qgc3RvcmFnZTogSVN0b3JhZ2U8YW55PiA9IG5ldyBDb25jcmV0ZVN0b3JhZ2UoKTtcblxuICAgIHN0b3JhZ2UuaW5pdGlhbGl6ZSgpO1xuXG4gICAgcmV0dXJuIHN0b3JhZ2U7XG59O1xuXG5kZXNjcmliZSgnQXJyYXlTdG9yYWdlJywgKCkgPT4ge1xuICAgIGNvbnN0IHN0b3JhZ2VLZXk6IG51bWJlciA9IDA7XG4gICAgY29uc3Qgc3RvcmFnZVZhbHVlOiBzdHJpbmcgPSAnZm9vJztcblxuICAgIGxldCBzdG9yYWdlOiBJU3RvcmFnZSA8YW55PjtcblxuICAgIGRlc2NyaWJlKCdpbml0aWFsaXplICguLi5hcmdzOiBhbnlbXSk6IHZvaWQnLCAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGV4cGVjdGVkRXJyb3I6IEVycm9yQ29uc3RydWN0b3IgPSBFcnJvcjtcblxuICAgICAgICBsZXQgdGVzdEZ1bmM6ICgpID0+IHZvaWQ7XG5cbiAgICAgICAgYmVmb3JlKCgpID0+IHtcbiAgICAgICAgICAgIHN0b3JhZ2UgPSBuZXcgQ29uY3JldGVTdG9yYWdlKCk7XG4gICAgICAgICAgICB0ZXN0RnVuYyA9ICgpID0+IHN0b3JhZ2Uuc2V0KHN0b3JhZ2VLZXksIHN0b3JhZ2VWYWx1ZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgdGhyb3dzIGFuIGVycm9yIHdoZW4gc3RvcmFnZSBpc25cXCd0IGluaXRpYWxpemVkJywgKCkgPT4ge1xuICAgICAgICAgICAgYXNzZXJ0LnRocm93cyh0ZXN0RnVuYywgZXhwZWN0ZWRFcnJvcik7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2dldFN0b3JhZ2UgKCk6IFRbXScsICgpID0+IHtcbiAgICAgICAgY29uc3QgZXhwZWN0ZWRJbnN0YW5jZU9mOiBBcnJheUNvbnN0cnVjdG9yID0gQXJyYXk7XG5cbiAgICAgICAgbGV0IGFycmF5U3RvcmFnZTogc3RyaW5nW107XG5cbiAgICAgICAgYmVmb3JlKCgpID0+IHtcbiAgICAgICAgICAgIHN0b3JhZ2UgPSBnZXRTdG9yYWdlSW5zdGFuY2UoKTtcblxuICAgICAgICAgICAgYXJyYXlTdG9yYWdlID0gc3RvcmFnZS5nZXRTdG9yYWdlKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgcmV0dXJuIHN0b3JhZ2UnLCAoKSA9PiB7XG4gICAgICAgICAgICBhc3NlcnQuaW5zdGFuY2VPZihhcnJheVN0b3JhZ2UsIGV4cGVjdGVkSW5zdGFuY2VPZik7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2dldCAoa2V5OiBudW1iZXIpOiBUJywgKCkgPT4ge1xuICAgICAgICBkZXNjcmliZSgndmFyaWFudCAjMTogdmFsdWUgZXhpc3QnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBleHBlY3RlZFZhbHVlOiBzdHJpbmcgPSBzdG9yYWdlVmFsdWU7XG5cbiAgICAgICAgICAgIGxldCB2YWx1ZTogc3RyaW5nO1xuXG4gICAgICAgICAgICBiZWZvcmUoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHN0b3JhZ2UgPSBnZXRTdG9yYWdlSW5zdGFuY2UoKTtcbiAgICAgICAgICAgICAgICBzdG9yYWdlLnNldChzdG9yYWdlS2V5LCBzdG9yYWdlVmFsdWUpO1xuXG4gICAgICAgICAgICAgICAgdmFsdWUgPSBzdG9yYWdlLmdldChzdG9yYWdlS2V5KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpdCgnc2hvdWxkIHJldHVybiB2YWx1ZSBmcm9tIHN0b3JhZ2UgYnkga2V5JywgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGFzc2VydC5lcXVhbCh2YWx1ZSwgZXhwZWN0ZWRWYWx1ZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgZGVzY3JpYmUoJ3ZhcmlhbnQgIzI6IHZhbHVlIGlzblxcJ3QgZXhpc3QnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBleHBlY3RlZEVycm9yOiBFcnJvckNvbnN0cnVjdG9yID0gRXJyb3I7XG5cbiAgICAgICAgICAgIGxldCB0ZXN0RnVuYzogKCkgPT4gdm9pZDtcblxuICAgICAgICAgICAgYmVmb3JlKCgpID0+IHtcbiAgICAgICAgICAgICAgICBzdG9yYWdlID0gZ2V0U3RvcmFnZUluc3RhbmNlKCk7XG5cbiAgICAgICAgICAgICAgICB0ZXN0RnVuYyA9ICgpID0+IHN0b3JhZ2UuZ2V0KHN0b3JhZ2VLZXkpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGl0KCdzaG91bGQgdGhyb3cgYW4gZXJyb3InLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgYXNzZXJ0LnRocm93cyh0ZXN0RnVuYywgZXhwZWN0ZWRFcnJvcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnZ2V0TGVuZ3RoICgpOiBudW1iZXInLCAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGV4cGVjdGVkU3RvcmFnZUxlbmd0aDogbnVtYmVyID0gMTtcblxuICAgICAgICBsZXQgc3RvcmFnZUxlbmd0aDogbnVtYmVyO1xuXG4gICAgICAgIGJlZm9yZSgoKSA9PiB7XG4gICAgICAgICAgICBzdG9yYWdlID0gZ2V0U3RvcmFnZUluc3RhbmNlKCk7XG4gICAgICAgICAgICBzdG9yYWdlLnNldChzdG9yYWdlS2V5LCBzdG9yYWdlVmFsdWUpO1xuXG4gICAgICAgICAgICBzdG9yYWdlTGVuZ3RoID0gc3RvcmFnZS5nZXRMZW5ndGgoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCByZXR1cm4gbGVuZ3RoIG9mIHN0b3JhZ2UnLCAoKSA9PiB7XG4gICAgICAgICAgICBhc3NlcnQuZXF1YWwoc3RvcmFnZUxlbmd0aCwgZXhwZWN0ZWRTdG9yYWdlTGVuZ3RoKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnZ2V0S2V5T2YgKHZhbHVlOiBUKTogbnVtYmVyIHwgbnVsbCcsICgpID0+IHtcbiAgICAgICAgbGV0IGtleTogc3RyaW5nIHwgbnVtYmVyIHwgbnVsbDtcblxuICAgICAgICBkZXNjcmliZSgndmFyaWFudCAjMScsICgpID0+IHtcbiAgICAgICAgICAgIGJlZm9yZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgc3RvcmFnZSA9IGdldFN0b3JhZ2VJbnN0YW5jZSgpO1xuICAgICAgICAgICAgICAgIHN0b3JhZ2Uuc2V0KHN0b3JhZ2VLZXksIHN0b3JhZ2VWYWx1ZSk7XG5cbiAgICAgICAgICAgICAgICBrZXkgPSBzdG9yYWdlLmdldEtleU9mKHN0b3JhZ2VWYWx1ZSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaXQoJ3Nob3VsZCByZXR1cm4ga2V5IG9mIHN0cmluZyB2YWx1ZScsICgpID0+IHtcbiAgICAgICAgICAgICAgICBhc3NlcnQuZXF1YWwoa2V5LCBzdG9yYWdlS2V5KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBkZXNjcmliZSgndmFyaWFudCAjMicsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG9iamVjdDogT2JqZWN0ID0ge1xuICAgICAgICAgICAgICAgIGZvbzogJ2JhcidcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGJlZm9yZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgc3RvcmFnZSA9IGdldFN0b3JhZ2VJbnN0YW5jZSgpO1xuICAgICAgICAgICAgICAgIHN0b3JhZ2Uuc2V0KHN0b3JhZ2VLZXksIG9iamVjdCk7XG5cbiAgICAgICAgICAgICAgICBrZXkgPSBzdG9yYWdlLmdldEtleU9mKG9iamVjdCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaXQoJ3Nob3VsZCByZXR1cm4ga2V5IG9mIG9iamVjdCBpZiBvYmplY3RzIGluIGBzZXRgIGFuZCBgZ2V0YCBhcmUgdHdvIHNhbWUgb2JqZWN0cycsICgpID0+IHtcbiAgICAgICAgICAgICAgICBhc3NlcnQuZXF1YWwoa2V5LCBzdG9yYWdlS2V5KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBkZXNjcmliZSgndmFyaWFudCAjMycsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGV4cGVjdGVkS2V5OiBudWxsID0gbnVsbDtcbiAgICAgICAgICAgIGNvbnN0IG9iamVjdDogT2JqZWN0ID0ge1xuICAgICAgICAgICAgICAgIGZvbzogJ2JhcidcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGJlZm9yZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgc3RvcmFnZSA9IGdldFN0b3JhZ2VJbnN0YW5jZSgpO1xuICAgICAgICAgICAgICAgIHN0b3JhZ2Uuc2V0KHN0b3JhZ2VLZXksIG9iamVjdCk7XG5cbiAgICAgICAgICAgICAgICBrZXkgPSBzdG9yYWdlLmdldEtleU9mKHsuLi5vYmplY3R9KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpdCgnc2hvdWxkIHJldHVybiBgbnVsbGAgaWYgb2JqZWN0cyBpbiBgc2V0YCBhbmQgYGdldGAgYXJlIHR3byBkaWZmZXJlbnQgb2JqZWN0cycsICgpID0+IHtcbiAgICAgICAgICAgICAgICBhc3NlcnQuZXF1YWwoa2V5LCBleHBlY3RlZEtleSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnc2V0IChrZXk6IG51bWJlciwgdmFsdWU6IFQpOiB2b2lkJywgKCkgPT4ge1xuICAgICAgICBsZXQgdmFsdWU6IHN0cmluZztcblxuICAgICAgICBiZWZvcmUoKCkgPT4ge1xuICAgICAgICAgICAgc3RvcmFnZSA9IGdldFN0b3JhZ2VJbnN0YW5jZSgpO1xuICAgICAgICAgICAgc3RvcmFnZS5zZXQoc3RvcmFnZUtleSwgc3RvcmFnZVZhbHVlKTtcblxuICAgICAgICAgICAgdmFsdWUgPSBzdG9yYWdlLmdldChzdG9yYWdlS2V5KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBzZXQgdmFsdWUgdG8gdGhlIHN0b3JhZ2UnLCAoKSA9PiB7XG4gICAgICAgICAgICBhc3NlcnQuZXF1YWwodmFsdWUsIHN0b3JhZ2VWYWx1ZSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ21lcmdlV2l0aCAoc3RvcmFnZTogdGhpcywgbWVyZ2VJZDogYm9vbGVhbiA9IGZhbHNlKTogdm9pZCcsICgpID0+IHtcbiAgICAgICAgY29uc3Qgc2Vjb25kU3RvcmFnZUtleTogbnVtYmVyID0gMTtcbiAgICAgICAgY29uc3Qgc2Vjb25kU3RvcmFnZVZhbHVlOiBzdHJpbmcgPSAnYmFyJztcblxuICAgICAgICBjb25zdCBleHBlY3RlZEFycmF5OiBzdHJpbmdbXSA9IFtzdG9yYWdlVmFsdWUsIHNlY29uZFN0b3JhZ2VWYWx1ZV07XG5cbiAgICAgICAgbGV0IGFycmF5OiBzdHJpbmdbXTtcblxuICAgICAgICBiZWZvcmUoKCkgPT4ge1xuICAgICAgICAgICAgc3RvcmFnZSA9IGdldFN0b3JhZ2VJbnN0YW5jZSgpO1xuICAgICAgICAgICAgc3RvcmFnZS5zZXQoc3RvcmFnZUtleSwgc3RvcmFnZVZhbHVlKTtcblxuICAgICAgICAgICAgY29uc3Qgc2Vjb25kU3RvcmFnZTogSVN0b3JhZ2UgPHN0cmluZz4gPSBnZXRTdG9yYWdlSW5zdGFuY2UoKTtcbiAgICAgICAgICAgIHNlY29uZFN0b3JhZ2Uuc2V0KHNlY29uZFN0b3JhZ2VLZXksIHNlY29uZFN0b3JhZ2VWYWx1ZSk7XG5cbiAgICAgICAgICAgIHN0b3JhZ2UubWVyZ2VXaXRoKHNlY29uZFN0b3JhZ2UsIGZhbHNlKTtcblxuICAgICAgICAgICAgYXJyYXkgPSBzdG9yYWdlLmdldFN0b3JhZ2UoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBtZXJnZSB0d28gc3RvcmFnZXMnLCAoKSA9PiB7XG4gICAgICAgICAgICBhc3NlcnQuZGVlcEVxdWFsKGFycmF5LCBleHBlY3RlZEFycmF5KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59KTtcbiJdfQ==