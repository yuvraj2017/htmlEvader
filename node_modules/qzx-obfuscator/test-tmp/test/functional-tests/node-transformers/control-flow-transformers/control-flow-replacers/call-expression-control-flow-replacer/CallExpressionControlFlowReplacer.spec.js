"use strict";

Object.defineProperty(exports, "__esModule", { value: true });
var chai_1 = require("chai");
var NoCustomNodes_1 = require("../../../../../../src/options/presets/NoCustomNodes");
var readFileAsString_1 = require("../../../../../helpers/readFileAsString");
var JavaScriptObfuscator_1 = require("../../../../../../src/JavaScriptObfuscator");
describe('CallExpressionControlFlowReplacer', function () {
    this.timeout(100000);
    describe('replace (callExpressionNode: ESTree.CallExpression,parentNode: ESTree.Node,controlFlowStorage: IStorage <ICustomNode>)', function () {
        describe('variant #1 - single call expression', function () {
            var controlFlowStorageCallRegExp = /var *_0x([a-f0-9]){4,6} *= *_0x([a-f0-9]){4,6}\['\w{5}'\]\(_0x([a-f0-9]){4,6}, *0x1, *0x2\);/;
            var obfuscatedCode = void 0;
            before(function () {
                var code = readFileAsString_1.readFileAsString(__dirname + '/fixtures/input-1.js');
                var obfuscationResult = JavaScriptObfuscator_1.JavaScriptObfuscator.obfuscate(code, Object.assign({}, NoCustomNodes_1.NO_CUSTOM_NODES_PRESET, { controlFlowFlattening: true, controlFlowFlatteningThreshold: 1 }));
                obfuscatedCode = obfuscationResult.getObfuscatedCode();
            });
            it('should replace call expression node with call to control flow storage node', function () {
                chai_1.assert.match(obfuscatedCode, controlFlowStorageCallRegExp);
            });
        });
        describe('variant #2 - multiple call expressions with threshold = 1', function () {
            var expectedMatchErrorsCount = 0;
            var expectedChance = 0.5;
            var samplesCount = 1000;
            var delta = 0.1;
            var controlFlowStorageCallRegExp1 = /var *_0x(?:[a-f0-9]){4,6} *= *(_0x([a-f0-9]){4,6}\['\w{5}'\])\(_0x([a-f0-9]){4,6}, *0x1, *0x2\);/;
            var controlFlowStorageCallRegExp2 = /var *_0x(?:[a-f0-9]){4,6} *= *(_0x([a-f0-9]){4,6}\['\w{5}'\])\(_0x([a-f0-9]){4,6}, *0x2, *0x3\);/;
            var matchErrorsCount = 0,
                usingExistingIdentifierChance = void 0;
            before(function () {
                var code = readFileAsString_1.readFileAsString(__dirname + '/fixtures/input-2.js');
                var obfuscationResult = void 0,
                    obfuscatedCode = void 0,
                    firstMatchArray = void 0,
                    secondMatchArray = void 0,
                    firstMatch = void 0,
                    secondMatch = void 0,
                    equalsValue = 0;
                for (var i = 0; i < samplesCount; i++) {
                    obfuscationResult = JavaScriptObfuscator_1.JavaScriptObfuscator.obfuscate(code, Object.assign({}, NoCustomNodes_1.NO_CUSTOM_NODES_PRESET, { controlFlowFlattening: true, controlFlowFlatteningThreshold: 1 }));
                    obfuscatedCode = obfuscationResult.getObfuscatedCode();
                    firstMatchArray = obfuscatedCode.match(controlFlowStorageCallRegExp1);
                    secondMatchArray = obfuscatedCode.match(controlFlowStorageCallRegExp2);
                    if (!firstMatchArray || !secondMatchArray) {
                        matchErrorsCount++;
                        continue;
                    }
                    firstMatch = firstMatchArray ? firstMatchArray[1] : undefined;
                    secondMatch = secondMatchArray ? secondMatchArray[1] : undefined;
                    if (firstMatch === secondMatch) {
                        equalsValue++;
                    }
                }
                usingExistingIdentifierChance = equalsValue / samplesCount;
            });
            it('should replace call expression node by call to control flow storage node', function () {
                chai_1.assert.equal(matchErrorsCount, expectedMatchErrorsCount);
            });
            it('should use existing identifier for control flow storage with expected chance', function () {
                chai_1.assert.closeTo(usingExistingIdentifierChance, expectedChance, delta);
            });
        });
        describe('variant #3 - call expression callee is member expression node', function () {
            var regExp = /var *_0x([a-f0-9]){4,6} *= *_0x([a-f0-9]){4,6}\['sum'\]\(0x1, *0x2\);/;
            var obfuscatedCode = void 0;
            before(function () {
                var code = readFileAsString_1.readFileAsString(__dirname + '/fixtures/input-3.js');
                var obfuscationResult = JavaScriptObfuscator_1.JavaScriptObfuscator.obfuscate(code, Object.assign({}, NoCustomNodes_1.NO_CUSTOM_NODES_PRESET, { controlFlowFlattening: true, controlFlowFlatteningThreshold: 1 }));
                obfuscatedCode = obfuscationResult.getObfuscatedCode();
            });
            it('shouldn\'t replace call expression node with call to control flow storage node', function () {
                chai_1.assert.match(obfuscatedCode, regExp);
            });
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2FsbEV4cHJlc3Npb25Db250cm9sRmxvd1JlcGxhY2VyLnNwZWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi90ZXN0L2Z1bmN0aW9uYWwtdGVzdHMvbm9kZS10cmFuc2Zvcm1lcnMvY29udHJvbC1mbG93LXRyYW5zZm9ybWVycy9jb250cm9sLWZsb3ctcmVwbGFjZXJzL2NhbGwtZXhwcmVzc2lvbi1jb250cm9sLWZsb3ctcmVwbGFjZXIvQ2FsbEV4cHJlc3Npb25Db250cm9sRmxvd1JlcGxhY2VyLnNwZWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEscUJBQThCO0FBSTlCLDhCQUE2RjtBQUU3RixpQ0FBMkU7QUFFM0UscUNBQWtGO0FBRWxGLEFBQVEsU0FBQyxBQUFtQyxxQ0FBRTtBQUMxQyxBQUFJLFNBQUMsQUFBTyxRQUFDLEFBQU0sQUFBQyxBQUFDO0FBRXJCLEFBQVEsYUFBQyxBQUF3SCwwSEFBRTtBQUMvSCxBQUFRLGlCQUFDLEFBQXFDLHVDQUFFO0FBQzVDLGdCQUFNLEFBQTRCLCtCQUFXLEFBQThGLEFBQUM7QUFFNUksZ0JBQUksQUFBc0IsQUFBQztBQUUzQixBQUFNLG1CQUFDO0FBQ0gsb0JBQU0sQUFBSSxPQUFXLG1CQUFnQixpQkFBQyxBQUFTLFlBQUcsQUFBc0IsQUFBQyxBQUFDO0FBQzFFLG9CQUFNLEFBQWlCLG9CQUF1Qix1QkFBb0IscUJBQUMsQUFBUyxVQUN4RSxBQUFJLHdCQUVHLGdCQUFzQiwwQkFDekIsQUFBcUIsdUJBQUUsQUFBSSxNQUMzQixBQUE4QixnQ0FBRSxBQUFDLEFBRXhDLEFBQUM7QUFFRixBQUFjLGlDQUFHLEFBQWlCLGtCQUFDLEFBQWlCLEFBQUUsQUFBQyxBQUMzRDtBQUFDLEFBQUMsQUFBQztBQUVILEFBQUUsZUFBQyxBQUE0RSw4RUFBRTtBQUM3RSx1QkFBTSxPQUFDLEFBQUssTUFBQyxBQUFjLGdCQUFFLEFBQTRCLEFBQUMsQUFBQyxBQUMvRDtB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aUIsQUFBRSxBQUFDLEFBQzNEO0FBQUMsQUFBQyxBQUFDO0FBRUgsQUFBRSxlQUFDLEFBQWdGLGtGQUFFO0FBQ2pGLHVCQUFNLE9BQUMsQUFBSyxNQUFDLEFBQWMsZ0JBQUUsQUFBTSxBQUFDLEFBQUMsQUFDekM7QUFBQyxBQUFDLEFBQUMsQUFDUDtBQUFDLEFBQUMsQUFBQyxBQUNQO0FBQUMsQUFBQyxBQUFDLEFBQ1A7QUFBQyxBQUFDLEFBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhc3NlcnQgfSBmcm9tICdjaGFpJztcblxuaW1wb3J0IHsgSU9iZnVzY2F0aW9uUmVzdWx0IH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2ludGVyZmFjZXMvSU9iZnVzY2F0aW9uUmVzdWx0JztcblxuaW1wb3J0IHsgTk9fQ1VTVE9NX05PREVTX1BSRVNFVCB9IGZyb20gJy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9vcHRpb25zL3ByZXNldHMvTm9DdXN0b21Ob2Rlcyc7XG5cbmltcG9ydCB7IHJlYWRGaWxlQXNTdHJpbmcgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9oZWxwZXJzL3JlYWRGaWxlQXNTdHJpbmcnO1xuXG5pbXBvcnQgeyBKYXZhU2NyaXB0T2JmdXNjYXRvciB9IGZyb20gJy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9KYXZhU2NyaXB0T2JmdXNjYXRvcic7XG5cbmRlc2NyaWJlKCdDYWxsRXhwcmVzc2lvbkNvbnRyb2xGbG93UmVwbGFjZXInLCBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy50aW1lb3V0KDEwMDAwMCk7XG5cbiAgICBkZXNjcmliZSgncmVwbGFjZSAoY2FsbEV4cHJlc3Npb25Ob2RlOiBFU1RyZWUuQ2FsbEV4cHJlc3Npb24scGFyZW50Tm9kZTogRVNUcmVlLk5vZGUsY29udHJvbEZsb3dTdG9yYWdlOiBJU3RvcmFnZSA8SUN1c3RvbU5vZGU+KScsICgpID0+IHtcbiAgICAgICAgZGVzY3JpYmUoJ3ZhcmlhbnQgIzEgLSBzaW5nbGUgY2FsbCBleHByZXNzaW9uJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29udHJvbEZsb3dTdG9yYWdlQ2FsbFJlZ0V4cDogUmVnRXhwID0gL3ZhciAqXzB4KFthLWYwLTldKXs0LDZ9ICo9ICpfMHgoW2EtZjAtOV0pezQsNn1cXFsnXFx3ezV9J1xcXVxcKF8weChbYS1mMC05XSl7NCw2fSwgKjB4MSwgKjB4MlxcKTsvO1xuXG4gICAgICAgICAgICBsZXQgb2JmdXNjYXRlZENvZGU6IHN0cmluZztcblxuICAgICAgICAgICAgYmVmb3JlKCgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb2RlOiBzdHJpbmcgPSByZWFkRmlsZUFzU3RyaW5nKF9fZGlybmFtZSArICcvZml4dHVyZXMvaW5wdXQtMS5qcycpO1xuICAgICAgICAgICAgICAgIGNvbnN0IG9iZnVzY2F0aW9uUmVzdWx0OiBJT2JmdXNjYXRpb25SZXN1bHQgPSBKYXZhU2NyaXB0T2JmdXNjYXRvci5vYmZ1c2NhdGUoXG4gICAgICAgICAgICAgICAgICAgIGNvZGUsXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLk5PX0NVU1RPTV9OT0RFU19QUkVTRVQsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sRmxvd0ZsYXR0ZW5pbmc6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sRmxvd0ZsYXR0ZW5pbmdUaHJlc2hvbGQ6IDFcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICBvYmZ1c2NhdGVkQ29kZSA9IG9iZnVzY2F0aW9uUmVzdWx0LmdldE9iZnVzY2F0ZWRDb2RlKCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaXQoJ3Nob3VsZCByZXBsYWNlIGNhbGwgZXhwcmVzc2lvbiBub2RlIHdpdGggY2FsbCB0byBjb250cm9sIGZsb3cgc3RvcmFnZSBub2RlJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGFzc2VydC5tYXRjaChvYmZ1c2NhdGVkQ29kZSwgY29udHJvbEZsb3dTdG9yYWdlQ2FsbFJlZ0V4cCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgZGVzY3JpYmUoJ3ZhcmlhbnQgIzIgLSBtdWx0aXBsZSBjYWxsIGV4cHJlc3Npb25zIHdpdGggdGhyZXNob2xkID0gMScsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGV4cGVjdGVkTWF0Y2hFcnJvcnNDb3VudDogbnVtYmVyID0gMDtcbiAgICAgICAgICAgIGNvbnN0IGV4cGVjdGVkQ2hhbmNlOiBudW1iZXIgPSAwLjU7XG5cbiAgICAgICAgICAgIGNvbnN0IHNhbXBsZXNDb3VudDogbnVtYmVyID0gMTAwMDtcbiAgICAgICAgICAgIGNvbnN0IGRlbHRhOiBudW1iZXIgPSAwLjE7XG5cbiAgICAgICAgICAgIGNvbnN0IGNvbnRyb2xGbG93U3RvcmFnZUNhbGxSZWdFeHAxOiBSZWdFeHAgPSAvdmFyICpfMHgoPzpbYS1mMC05XSl7NCw2fSAqPSAqKF8weChbYS1mMC05XSl7NCw2fVxcWydcXHd7NX0nXFxdKVxcKF8weChbYS1mMC05XSl7NCw2fSwgKjB4MSwgKjB4MlxcKTsvO1xuICAgICAgICAgICAgY29uc3QgY29udHJvbEZsb3dTdG9yYWdlQ2FsbFJlZ0V4cDI6IFJlZ0V4cCA9IC92YXIgKl8weCg/OlthLWYwLTldKXs0LDZ9ICo9ICooXzB4KFthLWYwLTldKXs0LDZ9XFxbJ1xcd3s1fSdcXF0pXFwoXzB4KFthLWYwLTldKXs0LDZ9LCAqMHgyLCAqMHgzXFwpOy87XG5cbiAgICAgICAgICAgIGxldCBtYXRjaEVycm9yc0NvdW50OiBudW1iZXIgPSAwLFxuICAgICAgICAgICAgICAgIHVzaW5nRXhpc3RpbmdJZGVudGlmaWVyQ2hhbmNlOiBudW1iZXI7XG5cbiAgICAgICAgICAgIGJlZm9yZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgY29kZTogc3RyaW5nID0gcmVhZEZpbGVBc1N0cmluZyhfX2Rpcm5hbWUgKyAnL2ZpeHR1cmVzL2lucHV0LTIuanMnKTtcblxuICAgICAgICAgICAgICAgIGxldCBvYmZ1c2NhdGlvblJlc3VsdDogSU9iZnVzY2F0aW9uUmVzdWx0LFxuICAgICAgICAgICAgICAgICAgICBvYmZ1c2NhdGVkQ29kZTogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICBmaXJzdE1hdGNoQXJyYXk6IFJlZ0V4cE1hdGNoQXJyYXkgfCBudWxsLFxuICAgICAgICAgICAgICAgICAgICBzZWNvbmRNYXRjaEFycmF5OiBSZWdFeHBNYXRjaEFycmF5IHwgbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgZmlyc3RNYXRjaDogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgICAgICBzZWNvbmRNYXRjaDogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgICAgICBlcXVhbHNWYWx1ZTogbnVtYmVyID0gMDtcblxuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2FtcGxlc0NvdW50OyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgb2JmdXNjYXRpb25SZXN1bHQgPSBKYXZhU2NyaXB0T2JmdXNjYXRvci5vYmZ1c2NhdGUoXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2RlLFxuICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC4uLk5PX0NVU1RPTV9OT0RFU19QUkVTRVQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbEZsb3dGbGF0dGVuaW5nOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xGbG93RmxhdHRlbmluZ1RocmVzaG9sZDogMVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgICAgIG9iZnVzY2F0ZWRDb2RlID0gb2JmdXNjYXRpb25SZXN1bHQuZ2V0T2JmdXNjYXRlZENvZGUoKTtcblxuICAgICAgICAgICAgICAgICAgICBmaXJzdE1hdGNoQXJyYXkgPSBvYmZ1c2NhdGVkQ29kZS5tYXRjaChjb250cm9sRmxvd1N0b3JhZ2VDYWxsUmVnRXhwMSk7XG4gICAgICAgICAgICAgICAgICAgIHNlY29uZE1hdGNoQXJyYXkgPSBvYmZ1c2NhdGVkQ29kZS5tYXRjaChjb250cm9sRmxvd1N0b3JhZ2VDYWxsUmVnRXhwMik7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKCFmaXJzdE1hdGNoQXJyYXkgfHwgIXNlY29uZE1hdGNoQXJyYXkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoRXJyb3JzQ291bnQrKztcblxuICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBmaXJzdE1hdGNoID0gZmlyc3RNYXRjaEFycmF5ID8gZmlyc3RNYXRjaEFycmF5WzFdIDogdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICBzZWNvbmRNYXRjaCA9IHNlY29uZE1hdGNoQXJyYXkgPyBzZWNvbmRNYXRjaEFycmF5WzFdIDogdW5kZWZpbmVkO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChmaXJzdE1hdGNoID09PSBzZWNvbmRNYXRjaCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXF1YWxzVmFsdWUrKztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHVzaW5nRXhpc3RpbmdJZGVudGlmaWVyQ2hhbmNlID0gZXF1YWxzVmFsdWUgLyBzYW1wbGVzQ291bnQ7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaXQoJ3Nob3VsZCByZXBsYWNlIGNhbGwgZXhwcmVzc2lvbiBub2RlIGJ5IGNhbGwgdG8gY29udHJvbCBmbG93IHN0b3JhZ2Ugbm9kZScsICgpID0+IHtcbiAgICAgICAgICAgICAgICBhc3NlcnQuZXF1YWwobWF0Y2hFcnJvcnNDb3VudCwgZXhwZWN0ZWRNYXRjaEVycm9yc0NvdW50KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpdCgnc2hvdWxkIHVzZSBleGlzdGluZyBpZGVudGlmaWVyIGZvciBjb250cm9sIGZsb3cgc3RvcmFnZSB3aXRoIGV4cGVjdGVkIGNoYW5jZScsICgpID0+IHtcbiAgICAgICAgICAgICAgICBhc3NlcnQuY2xvc2VUbyh1c2luZ0V4aXN0aW5nSWRlbnRpZmllckNoYW5jZSwgZXhwZWN0ZWRDaGFuY2UsIGRlbHRhKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBkZXNjcmliZSgndmFyaWFudCAjMyAtIGNhbGwgZXhwcmVzc2lvbiBjYWxsZWUgaXMgbWVtYmVyIGV4cHJlc3Npb24gbm9kZScsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlZ0V4cDogUmVnRXhwID0gL3ZhciAqXzB4KFthLWYwLTldKXs0LDZ9ICo9ICpfMHgoW2EtZjAtOV0pezQsNn1cXFsnc3VtJ1xcXVxcKDB4MSwgKjB4MlxcKTsvO1xuXG4gICAgICAgICAgICBsZXQgb2JmdXNjYXRlZENvZGU6IHN0cmluZztcblxuICAgICAgICAgICAgYmVmb3JlKCgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb2RlOiBzdHJpbmcgPSByZWFkRmlsZUFzU3RyaW5nKF9fZGlybmFtZSArICcvZml4dHVyZXMvaW5wdXQtMy5qcycpO1xuICAgICAgICAgICAgICAgIGNvbnN0IG9iZnVzY2F0aW9uUmVzdWx0OiBJT2JmdXNjYXRpb25SZXN1bHQgPSBKYXZhU2NyaXB0T2JmdXNjYXRvci5vYmZ1c2NhdGUoXG4gICAgICAgICAgICAgICAgICAgIGNvZGUsXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLk5PX0NVU1RPTV9OT0RFU19QUkVTRVQsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sRmxvd0ZsYXR0ZW5pbmc6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sRmxvd0ZsYXR0ZW5pbmdUaHJlc2hvbGQ6IDFcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICBvYmZ1c2NhdGVkQ29kZSA9IG9iZnVzY2F0aW9uUmVzdWx0LmdldE9iZnVzY2F0ZWRDb2RlKCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaXQoJ3Nob3VsZG5cXCd0IHJlcGxhY2UgY2FsbCBleHByZXNzaW9uIG5vZGUgd2l0aCBjYWxsIHRvIGNvbnRyb2wgZmxvdyBzdG9yYWdlIG5vZGUnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgYXNzZXJ0Lm1hdGNoKG9iZnVzY2F0ZWRDb2RlLCByZWdFeHApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufSk7XG4iXX0=