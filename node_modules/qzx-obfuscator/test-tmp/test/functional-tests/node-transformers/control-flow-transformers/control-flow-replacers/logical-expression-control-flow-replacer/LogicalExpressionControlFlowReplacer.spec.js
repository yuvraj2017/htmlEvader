"use strict";

Object.defineProperty(exports, "__esModule", { value: true });
var chai_1 = require("chai");
var NoCustomNodes_1 = require("../../../../../../src/options/presets/NoCustomNodes");
var readFileAsString_1 = require("../../../../../helpers/readFileAsString");
var JavaScriptObfuscator_1 = require("../../../../../../src/JavaScriptObfuscator");
describe('LogicalExpressionControlFlowReplacer', function () {
    this.timeout(100000);
    describe('replace (logicalExpressionNode: ESTree.LogicalExpression,parentNode: ESTree.Node,controlFlowStorage: IStorage <ICustomNode>)', function () {
        describe('variant #1 - single logical expression', function () {
            var controlFlowStorageCallRegExp = /var *_0x([a-f0-9]){4,6} *= *_0x([a-f0-9]){4,6}\['\w{5}'\]\(!!\[\], *!\[\]\);/;
            var obfuscatedCode = void 0;
            before(function () {
                var code = readFileAsString_1.readFileAsString(__dirname + '/fixtures/input-1.js');
                var obfuscationResult = JavaScriptObfuscator_1.JavaScriptObfuscator.obfuscate(code, Object.assign({}, NoCustomNodes_1.NO_CUSTOM_NODES_PRESET, { controlFlowFlattening: true, controlFlowFlatteningThreshold: 1 }));
                obfuscatedCode = obfuscationResult.getObfuscatedCode();
            });
            it('should replace logical expression node with call to control flow storage node', function () {
                chai_1.assert.match(obfuscatedCode, controlFlowStorageCallRegExp);
            });
        });
        describe('variant #2 - multiple logical expressions with threshold = 1', function () {
            var expectedMatchErrorsCount = 0;
            var expectedChance = 0.5;
            var samplesCount = 1000;
            var delta = 0.1;
            var controlFlowStorageCallRegExp1 = /var *_0x(?:[a-f0-9]){4,6} *= *(_0x([a-f0-9]){4,6}\['\w{5}'\])\(!!\[\], *!\[\]\);/;
            var controlFlowStorageCallRegExp2 = /var *_0x(?:[a-f0-9]){4,6} *= *(_0x([a-f0-9]){4,6}\['\w{5}'\])\(!\[\], *!!\[\]\);/;
            var matchErrorsCount = 0,
                usingExistingIdentifierChance = void 0;
            before(function () {
                var code = readFileAsString_1.readFileAsString(__dirname + '/fixtures/input-2.js');
                var obfuscationResult = void 0,
                    obfuscatedCode = void 0,
                    firstMatchArray = void 0,
                    secondMatchArray = void 0,
                    firstMatch = void 0,
                    secondMatch = void 0,
                    equalsValue = 0;
                for (var i = 0; i < samplesCount; i++) {
                    obfuscationResult = JavaScriptObfuscator_1.JavaScriptObfuscator.obfuscate(code, Object.assign({}, NoCustomNodes_1.NO_CUSTOM_NODES_PRESET, { controlFlowFlattening: true, controlFlowFlatteningThreshold: 1 }));
                    obfuscatedCode = obfuscationResult.getObfuscatedCode();
                    firstMatchArray = obfuscatedCode.match(controlFlowStorageCallRegExp1);
                    secondMatchArray = obfuscatedCode.match(controlFlowStorageCallRegExp2);
                    if (!firstMatchArray || !secondMatchArray) {
                        matchErrorsCount++;
                        continue;
                    }
                    firstMatch = firstMatchArray ? firstMatchArray[1] : undefined;
                    secondMatch = secondMatchArray ? secondMatchArray[1] : undefined;
                    if (firstMatch === secondMatch) {
                        equalsValue++;
                    }
                }
                usingExistingIdentifierChance = equalsValue / samplesCount;
            });
            it('should replace logical expression node by call to control flow storage node', function () {
                chai_1.assert.equal(matchErrorsCount, expectedMatchErrorsCount);
            });
            it('should use existing identifier for control flow storage with expected chance', function () {
                chai_1.assert.closeTo(usingExistingIdentifierChance, expectedChance, delta);
            });
        });
        describe('variant #3 - single logical expression with unary expression', function () {
            var controlFlowStorageCallRegExp = /var *_0x([a-f0-9]){4,6} *= *_0x([a-f0-9]){4,6}\['\w{5}'\]\(!_0x([a-f0-9]){4,6}, *!_0x([a-f0-9]){4,6}\);/;
            var obfuscatedCode = void 0;
            before(function () {
                var code = readFileAsString_1.readFileAsString(__dirname + '/fixtures/input-3.js');
                var obfuscationResult = JavaScriptObfuscator_1.JavaScriptObfuscator.obfuscate(code, Object.assign({}, NoCustomNodes_1.NO_CUSTOM_NODES_PRESET, { controlFlowFlattening: true, controlFlowFlatteningThreshold: 1 }));
                obfuscatedCode = obfuscationResult.getObfuscatedCode();
            });
            it('should replace logical unary expression with call to control flow storage node', function () {
                chai_1.assert.match(obfuscatedCode, controlFlowStorageCallRegExp);
            });
        });
        describe('prohibited nodes variant #1', function () {
            var regExp = /var *_0x([a-f0-9]){4,6} *= *_0x([a-f0-9]){4,6}\[_0x([a-f0-9]){4,6}\] *&& *!\[\];/;
            var obfuscatedCode = void 0;
            before(function () {
                var code = readFileAsString_1.readFileAsString(__dirname + '/fixtures/prohibited-nodes.js');
                var obfuscationResult = JavaScriptObfuscator_1.JavaScriptObfuscator.obfuscate(code, Object.assign({}, NoCustomNodes_1.NO_CUSTOM_NODES_PRESET, { controlFlowFlattening: true, controlFlowFlatteningThreshold: .1 }));
                obfuscatedCode = obfuscationResult.getObfuscatedCode();
            });
            it('shouldn\'t replace prohibited expression nodes', function () {
                chai_1.assert.match(obfuscatedCode, regExp);
            });
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTG9naWNhbEV4cHJlc3Npb25Db250cm9sRmxvd1JlcGxhY2VyLnNwZWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi90ZXN0L2Z1bmN0aW9uYWwtdGVzdHMvbm9kZS10cmFuc2Zvcm1lcnMvY29udHJvbC1mbG93LXRyYW5zZm9ybWVycy9jb250cm9sLWZsb3ctcmVwbGFjZXJzL2xvZ2ljYWwtZXhwcmVzc2lvbi1jb250cm9sLWZsb3ctcmVwbGFjZXIvTG9naWNhbEV4cHJlc3Npb25Db250cm9sRmxvd1JlcGxhY2VyLnNwZWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEscUJBQThCO0FBSTlCLDhCQUE2RjtBQUU3RixpQ0FBMkU7QUFFM0UscUNBQWtGO0FBRWxGLEFBQVEsU0FBQyxBQUFzQyx3Q0FBRTtBQUM3QyxBQUFJLFNBQUMsQUFBTyxRQUFDLEFBQU0sQUFBQyxBQUFDO0FBRXJCLEFBQVEsYUFBQyxBQUE4SCxnSUFBRTtBQUNySSxBQUFRLGlCQUFDLEFBQXdDLDBDQUFFO0FBQy9DLGdCQUFNLEFBQTRCLCtCQUFXLEFBQThFLEFBQUM7QUFFNUgsZ0JBQUksQUFBc0IsQUFBQztBQUUzQixBQUFNLG1CQUFDO0FBQ0gsb0JBQU0sQUFBSSxPQUFXLG1CQUFnQixpQkFBQyxBQUFTLFlBQUcsQUFBc0IsQUFBQyxBQUFDO0FBQzFFLG9CQUFNLEFBQWlCLG9CQUF1Qix1QkFBb0IscUJBQUMsQUFBUyxVQUN4RSxBQUFJLHdCQUVHLGdCQUFzQiwwQkFDekIsQUFBcUIsdUJBQUUsQUFBSSxNQUMzQixBQUE4QixnQ0FBRSxBQUFDLEFBRXhDLEFBQUM7QUFFRixBQUFjLGlDQUFHLEFBQWlCLGtCQUFDLEFBQWlCLEFBQUUsQUFBQyxBQUMzRDtBQUFDLEFBQUMsQUFBQztBQUVILEFBQUUsZUFBQyxBQUErRSxpRkFBRTtBQUNoRix1QkFBTSxPQUFDLEFBQUssTUFBQyxBQUFjLGdCQUFFLEFBQTRCLEFBQUMsQUFB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QixrQkFBQyxBQUFpQixBQUFFLEFBQUMsQUFDM0Q7QUFBQyxBQUFDLEFBQUM7QUFFSCxBQUFFLGVBQUMsQUFBZ0Ysa0ZBQUU7QUFDakYsdUJBQU0sT0FBQyxBQUFLLE1BQUMsQUFBYyxnQkFBRSxBQUE0QixBQUFDLEFBQUMsQUFDL0Q7QUFBQyxBQUFDLEFBQUMsQUFDUDtBQUFDLEFBQUMsQUFBQztBQUVILEFBQVEsaUJBQUMsQUFBNkIsK0JBQUU7QUFDcEMsZ0JBQU0sQUFBTSxTQUFXLEFBQWtGLEFBQUM7QUFFMUcsZ0JBQUksQUFBc0IsQUFBQztBQUUzQixBQUFNLG1CQUFDO0FBQ0gsb0JBQU0sQUFBSSxPQUFXLG1CQUFnQixpQkFBQyxBQUFTLFlBQUcsQUFBK0IsQUFBQyxBQUFDO0FBQ25GLG9CQUFNLEFBQWlCLG9CQUF1Qix1QkFBb0IscUJBQUMsQUFBUyxVQUN4RSxBQUFJLHdCQUVHLGdCQUFzQiwwQkFDekIsQUFBcUIsdUJBQUUsQUFBSSxNQUMzQixBQUE4QixnQ0FBRSxBQUFFLEFBRXpDLEFBQUM7QUFFRixBQUFjLGlDQUFHLEFBQWlCLGtCQUFDLEFBQWlCLEFBQUUsQUFBQyxBQUMzRDtBQUFDLEFBQUMsQUFBQztBQUVILEFBQUUsZUFBQyxBQUFnRCxrREFBRTtBQUNqRCx1QkFBTSxPQUFDLEFBQUssTUFBQyxBQUFjLGdCQUFFLEFBQU0sQUFBQyxBQUFDLEFBQ3pDO0FBQUMsQUFBQyxBQUFDLEFBQ1A7QUFBQyxBQUFDLEFBQUMsQUFDUDtBQUFDLEFBQUMsQUFBQyxBQUNQO0FBQUMsQUFBQyxBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYXNzZXJ0IH0gZnJvbSAnY2hhaSc7XG5cbmltcG9ydCB7IElPYmZ1c2NhdGlvblJlc3VsdCB9IGZyb20gJy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9pbnRlcmZhY2VzL0lPYmZ1c2NhdGlvblJlc3VsdCc7XG5cbmltcG9ydCB7IE5PX0NVU1RPTV9OT0RFU19QUkVTRVQgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi8uLi9zcmMvb3B0aW9ucy9wcmVzZXRzL05vQ3VzdG9tTm9kZXMnO1xuXG5pbXBvcnQgeyByZWFkRmlsZUFzU3RyaW5nIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vaGVscGVycy9yZWFkRmlsZUFzU3RyaW5nJztcblxuaW1wb3J0IHsgSmF2YVNjcmlwdE9iZnVzY2F0b3IgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi8uLi9zcmMvSmF2YVNjcmlwdE9iZnVzY2F0b3InO1xuXG5kZXNjcmliZSgnTG9naWNhbEV4cHJlc3Npb25Db250cm9sRmxvd1JlcGxhY2VyJywgZnVuY3Rpb24gKCkge1xuICAgIHRoaXMudGltZW91dCgxMDAwMDApO1xuXG4gICAgZGVzY3JpYmUoJ3JlcGxhY2UgKGxvZ2ljYWxFeHByZXNzaW9uTm9kZTogRVNUcmVlLkxvZ2ljYWxFeHByZXNzaW9uLHBhcmVudE5vZGU6IEVTVHJlZS5Ob2RlLGNvbnRyb2xGbG93U3RvcmFnZTogSVN0b3JhZ2UgPElDdXN0b21Ob2RlPiknLCAoKSA9PiB7XG4gICAgICAgIGRlc2NyaWJlKCd2YXJpYW50ICMxIC0gc2luZ2xlIGxvZ2ljYWwgZXhwcmVzc2lvbicsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRyb2xGbG93U3RvcmFnZUNhbGxSZWdFeHA6IFJlZ0V4cCA9IC92YXIgKl8weChbYS1mMC05XSl7NCw2fSAqPSAqXzB4KFthLWYwLTldKXs0LDZ9XFxbJ1xcd3s1fSdcXF1cXCghIVxcW1xcXSwgKiFcXFtcXF1cXCk7LztcblxuICAgICAgICAgICAgbGV0IG9iZnVzY2F0ZWRDb2RlOiBzdHJpbmc7XG5cbiAgICAgICAgICAgIGJlZm9yZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgY29kZTogc3RyaW5nID0gcmVhZEZpbGVBc1N0cmluZyhfX2Rpcm5hbWUgKyAnL2ZpeHR1cmVzL2lucHV0LTEuanMnKTtcbiAgICAgICAgICAgICAgICBjb25zdCBvYmZ1c2NhdGlvblJlc3VsdDogSU9iZnVzY2F0aW9uUmVzdWx0ID0gSmF2YVNjcmlwdE9iZnVzY2F0b3Iub2JmdXNjYXRlKFxuICAgICAgICAgICAgICAgICAgICBjb2RlLFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAuLi5OT19DVVNUT01fTk9ERVNfUFJFU0VULFxuICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbEZsb3dGbGF0dGVuaW5nOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbEZsb3dGbGF0dGVuaW5nVGhyZXNob2xkOiAxXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgb2JmdXNjYXRlZENvZGUgPSBvYmZ1c2NhdGlvblJlc3VsdC5nZXRPYmZ1c2NhdGVkQ29kZSgpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGl0KCdzaG91bGQgcmVwbGFjZSBsb2dpY2FsIGV4cHJlc3Npb24gbm9kZSB3aXRoIGNhbGwgdG8gY29udHJvbCBmbG93IHN0b3JhZ2Ugbm9kZScsICgpID0+IHtcbiAgICAgICAgICAgICAgICBhc3NlcnQubWF0Y2gob2JmdXNjYXRlZENvZGUsIGNvbnRyb2xGbG93U3RvcmFnZUNhbGxSZWdFeHApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGRlc2NyaWJlKCd2YXJpYW50ICMyIC0gbXVsdGlwbGUgbG9naWNhbCBleHByZXNzaW9ucyB3aXRoIHRocmVzaG9sZCA9IDEnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBleHBlY3RlZE1hdGNoRXJyb3JzQ291bnQ6IG51bWJlciA9IDA7XG4gICAgICAgICAgICBjb25zdCBleHBlY3RlZENoYW5jZTogbnVtYmVyID0gMC41O1xuXG4gICAgICAgICAgICBjb25zdCBzYW1wbGVzQ291bnQ6IG51bWJlciA9IDEwMDA7XG4gICAgICAgICAgICBjb25zdCBkZWx0YTogbnVtYmVyID0gMC4xO1xuXG4gICAgICAgICAgICBjb25zdCBjb250cm9sRmxvd1N0b3JhZ2VDYWxsUmVnRXhwMTogUmVnRXhwID0gL3ZhciAqXzB4KD86W2EtZjAtOV0pezQsNn0gKj0gKihfMHgoW2EtZjAtOV0pezQsNn1cXFsnXFx3ezV9J1xcXSlcXCghIVxcW1xcXSwgKiFcXFtcXF1cXCk7LztcbiAgICAgICAgICAgIGNvbnN0IGNvbnRyb2xGbG93U3RvcmFnZUNhbGxSZWdFeHAyOiBSZWdFeHAgPSAvdmFyICpfMHgoPzpbYS1mMC05XSl7NCw2fSAqPSAqKF8weChbYS1mMC05XSl7NCw2fVxcWydcXHd7NX0nXFxdKVxcKCFcXFtcXF0sICohIVxcW1xcXVxcKTsvO1xuXG4gICAgICAgICAgICBsZXQgbWF0Y2hFcnJvcnNDb3VudDogbnVtYmVyID0gMCxcbiAgICAgICAgICAgICAgICB1c2luZ0V4aXN0aW5nSWRlbnRpZmllckNoYW5jZTogbnVtYmVyO1xuXG4gICAgICAgICAgICBiZWZvcmUoKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNvZGU6IHN0cmluZyA9IHJlYWRGaWxlQXNTdHJpbmcoX19kaXJuYW1lICsgJy9maXh0dXJlcy9pbnB1dC0yLmpzJyk7XG5cbiAgICAgICAgICAgICAgICBsZXQgb2JmdXNjYXRpb25SZXN1bHQ6IElPYmZ1c2NhdGlvblJlc3VsdCxcbiAgICAgICAgICAgICAgICAgICAgb2JmdXNjYXRlZENvZGU6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgZmlyc3RNYXRjaEFycmF5OiBSZWdFeHBNYXRjaEFycmF5IHwgbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgc2Vjb25kTWF0Y2hBcnJheTogUmVnRXhwTWF0Y2hBcnJheSB8IG51bGwsXG4gICAgICAgICAgICAgICAgICAgIGZpcnN0TWF0Y2g6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgc2Vjb25kTWF0Y2g6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgZXF1YWxzVmFsdWU6IG51bWJlciA9IDA7XG5cbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNhbXBsZXNDb3VudDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIG9iZnVzY2F0aW9uUmVzdWx0ID0gSmF2YVNjcmlwdE9iZnVzY2F0b3Iub2JmdXNjYXRlKFxuICAgICAgICAgICAgICAgICAgICAgICAgY29kZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5OT19DVVNUT01fTk9ERVNfUFJFU0VULFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xGbG93RmxhdHRlbmluZzogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sRmxvd0ZsYXR0ZW5pbmdUaHJlc2hvbGQ6IDFcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgICAgICBvYmZ1c2NhdGVkQ29kZSA9IG9iZnVzY2F0aW9uUmVzdWx0LmdldE9iZnVzY2F0ZWRDb2RlKCk7XG5cbiAgICAgICAgICAgICAgICAgICAgZmlyc3RNYXRjaEFycmF5ID0gb2JmdXNjYXRlZENvZGUubWF0Y2goY29udHJvbEZsb3dTdG9yYWdlQ2FsbFJlZ0V4cDEpO1xuICAgICAgICAgICAgICAgICAgICBzZWNvbmRNYXRjaEFycmF5ID0gb2JmdXNjYXRlZENvZGUubWF0Y2goY29udHJvbEZsb3dTdG9yYWdlQ2FsbFJlZ0V4cDIpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICghZmlyc3RNYXRjaEFycmF5IHx8ICFzZWNvbmRNYXRjaEFycmF5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtYXRjaEVycm9yc0NvdW50Kys7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgZmlyc3RNYXRjaCA9IGZpcnN0TWF0Y2hBcnJheSA/IGZpcnN0TWF0Y2hBcnJheVsxXSA6IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgc2Vjb25kTWF0Y2ggPSBzZWNvbmRNYXRjaEFycmF5ID8gc2Vjb25kTWF0Y2hBcnJheVsxXSA6IHVuZGVmaW5lZDtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoZmlyc3RNYXRjaCA9PT0gc2Vjb25kTWF0Y2gpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVxdWFsc1ZhbHVlKys7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB1c2luZ0V4aXN0aW5nSWRlbnRpZmllckNoYW5jZSA9IGVxdWFsc1ZhbHVlIC8gc2FtcGxlc0NvdW50O1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGl0KCdzaG91bGQgcmVwbGFjZSBsb2dpY2FsIGV4cHJlc3Npb24gbm9kZSBieSBjYWxsIHRvIGNvbnRyb2wgZmxvdyBzdG9yYWdlIG5vZGUnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgYXNzZXJ0LmVxdWFsKG1hdGNoRXJyb3JzQ291bnQsIGV4cGVjdGVkTWF0Y2hFcnJvcnNDb3VudCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaXQoJ3Nob3VsZCB1c2UgZXhpc3RpbmcgaWRlbnRpZmllciBmb3IgY29udHJvbCBmbG93IHN0b3JhZ2Ugd2l0aCBleHBlY3RlZCBjaGFuY2UnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgYXNzZXJ0LmNsb3NlVG8odXNpbmdFeGlzdGluZ0lkZW50aWZpZXJDaGFuY2UsIGV4cGVjdGVkQ2hhbmNlLCBkZWx0YSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgZGVzY3JpYmUoJ3ZhcmlhbnQgIzMgLSBzaW5nbGUgbG9naWNhbCBleHByZXNzaW9uIHdpdGggdW5hcnkgZXhwcmVzc2lvbicsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRyb2xGbG93U3RvcmFnZUNhbGxSZWdFeHA6IFJlZ0V4cCA9IC92YXIgKl8weChbYS1mMC05XSl7NCw2fSAqPSAqXzB4KFthLWYwLTldKXs0LDZ9XFxbJ1xcd3s1fSdcXF1cXCghXzB4KFthLWYwLTldKXs0LDZ9LCAqIV8weChbYS1mMC05XSl7NCw2fVxcKTsvO1xuXG4gICAgICAgICAgICBsZXQgb2JmdXNjYXRlZENvZGU6IHN0cmluZztcblxuICAgICAgICAgICAgYmVmb3JlKCgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb2RlOiBzdHJpbmcgPSByZWFkRmlsZUFzU3RyaW5nKF9fZGlybmFtZSArICcvZml4dHVyZXMvaW5wdXQtMy5qcycpO1xuICAgICAgICAgICAgICAgIGNvbnN0IG9iZnVzY2F0aW9uUmVzdWx0OiBJT2JmdXNjYXRpb25SZXN1bHQgPSBKYXZhU2NyaXB0T2JmdXNjYXRvci5vYmZ1c2NhdGUoXG4gICAgICAgICAgICAgICAgICAgIGNvZGUsXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLk5PX0NVU1RPTV9OT0RFU19QUkVTRVQsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sRmxvd0ZsYXR0ZW5pbmc6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sRmxvd0ZsYXR0ZW5pbmdUaHJlc2hvbGQ6IDFcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICBvYmZ1c2NhdGVkQ29kZSA9IG9iZnVzY2F0aW9uUmVzdWx0LmdldE9iZnVzY2F0ZWRDb2RlKCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaXQoJ3Nob3VsZCByZXBsYWNlIGxvZ2ljYWwgdW5hcnkgZXhwcmVzc2lvbiB3aXRoIGNhbGwgdG8gY29udHJvbCBmbG93IHN0b3JhZ2Ugbm9kZScsICgpID0+IHtcbiAgICAgICAgICAgICAgICBhc3NlcnQubWF0Y2gob2JmdXNjYXRlZENvZGUsIGNvbnRyb2xGbG93U3RvcmFnZUNhbGxSZWdFeHApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGRlc2NyaWJlKCdwcm9oaWJpdGVkIG5vZGVzIHZhcmlhbnQgIzEnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZWdFeHA6IFJlZ0V4cCA9IC92YXIgKl8weChbYS1mMC05XSl7NCw2fSAqPSAqXzB4KFthLWYwLTldKXs0LDZ9XFxbXzB4KFthLWYwLTldKXs0LDZ9XFxdIComJiAqIVxcW1xcXTsvO1xuXG4gICAgICAgICAgICBsZXQgb2JmdXNjYXRlZENvZGU6IHN0cmluZztcblxuICAgICAgICAgICAgYmVmb3JlKCgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb2RlOiBzdHJpbmcgPSByZWFkRmlsZUFzU3RyaW5nKF9fZGlybmFtZSArICcvZml4dHVyZXMvcHJvaGliaXRlZC1ub2Rlcy5qcycpO1xuICAgICAgICAgICAgICAgIGNvbnN0IG9iZnVzY2F0aW9uUmVzdWx0OiBJT2JmdXNjYXRpb25SZXN1bHQgPSBKYXZhU2NyaXB0T2JmdXNjYXRvci5vYmZ1c2NhdGUoXG4gICAgICAgICAgICAgICAgICAgIGNvZGUsXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLk5PX0NVU1RPTV9OT0RFU19QUkVTRVQsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sRmxvd0ZsYXR0ZW5pbmc6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sRmxvd0ZsYXR0ZW5pbmdUaHJlc2hvbGQ6IC4xXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgb2JmdXNjYXRlZENvZGUgPSBvYmZ1c2NhdGlvblJlc3VsdC5nZXRPYmZ1c2NhdGVkQ29kZSgpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGl0KCdzaG91bGRuXFwndCByZXBsYWNlIHByb2hpYml0ZWQgZXhwcmVzc2lvbiBub2RlcycsICgpID0+IHtcbiAgICAgICAgICAgICAgICBhc3NlcnQubWF0Y2gob2JmdXNjYXRlZENvZGUsIHJlZ0V4cCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59KTtcbiJdfQ==