"use strict";

Object.defineProperty(exports, "__esModule", { value: true });
var chai_1 = require("chai");
var NoCustomNodes_1 = require("../../../../../src/options/presets/NoCustomNodes");
var readFileAsString_1 = require("../../../../helpers/readFileAsString");
var JavaScriptObfuscator_1 = require("../../../../../src/JavaScriptObfuscator");
describe('FunctionControlFlowTransformer', function () {
    this.timeout(100000);
    var variableMatch = '_0x([a-f0-9]){4,6}';
    var rootControlFlowStorageNodeMatch = "" + ("var *" + variableMatch + " *= *\\{") + ("'\\w{5}' *: *function *" + variableMatch + " *\\(" + variableMatch + ", *" + variableMatch + "\\) *\\{") + ("return *" + variableMatch + " *\\+ *" + variableMatch + ";") + "\\}" + "\\};" + "";
    var innerControlFlowStorageNodeMatch = "" + ("var *" + variableMatch + " *= *\\{") + ("'\\w{5}' *: *function *" + variableMatch + " *\\(" + variableMatch + ", *" + variableMatch + "\\) *\\{") + ("return *" + variableMatch + "\\['\\w{5}'\\]\\(" + variableMatch + ", *" + variableMatch + "\\);") + "\\}" + "\\};" + "";
    describe('transformNode (functionNode: ESTree.Function): ESTree.Node', function () {
        describe('variant #1 - single `control flow storage` node with single item', function () {
            var regexp = new RegExp(rootControlFlowStorageNodeMatch);
            var obfuscatedCode = void 0;
            before(function () {
                var code = readFileAsString_1.readFileAsString(__dirname + '/fixtures/input-1.js');
                var obfuscationResult = JavaScriptObfuscator_1.JavaScriptObfuscator.obfuscate(code, Object.assign({}, NoCustomNodes_1.NO_CUSTOM_NODES_PRESET, { controlFlowFlattening: true, controlFlowFlatteningThreshold: 1 }));
                obfuscatedCode = obfuscationResult.getObfuscatedCode();
            });
            it('should add `control flow storage` node to the obfuscated code', function () {
                chai_1.assert.match(obfuscatedCode, regexp);
            });
        });
        describe('variant #2 - two `control flow storage` nodes: root and inner', function () {
            var expectedAppendToScopeThreshold = 0.5;
            var samplesCount = 1000;
            var delta = 0.1;
            var regExp1 = new RegExp("\\(function\\(\\) *\\{ *" + rootControlFlowStorageNodeMatch, 'g');
            var regExp2 = new RegExp("function *" + variableMatch + " *\\(\\) *\\{ *" + innerControlFlowStorageNodeMatch, 'g');
            var appendToScopeThreshold = 0;
            before(function () {
                var code = readFileAsString_1.readFileAsString(__dirname + '/fixtures/input-2.js');
                var obfuscationResult = void 0,
                    obfuscatedCode = void 0,
                    totalValue = 0;
                for (var i = 0; i < samplesCount; i++) {
                    obfuscationResult = JavaScriptObfuscator_1.JavaScriptObfuscator.obfuscate(code, Object.assign({}, NoCustomNodes_1.NO_CUSTOM_NODES_PRESET, { controlFlowFlattening: true, controlFlowFlatteningThreshold: 1 }));
                    obfuscatedCode = obfuscationResult.getObfuscatedCode();
                    if (regExp1.test(obfuscatedCode)) {
                        totalValue += obfuscatedCode.match(regExp1).length;
                        if (regExp2.test(obfuscatedCode)) {
                            totalValue += obfuscatedCode.match(regExp2).length;
                        }
                    }
                }
                appendToScopeThreshold = (totalValue - samplesCount) / samplesCount;
            });
            it('should add two `control flow storage` nodes (root and inner) to the obfuscated code in different scopes', function () {
                chai_1.assert.closeTo(appendToScopeThreshold, expectedAppendToScopeThreshold, delta);
            });
        });
        describe('variant #3 - single `control flow storage` node with multiple items', function () {
            var regexp = new RegExp("var *" + variableMatch + " *= *\\{" + ("'\\w{5}' *: *function *" + variableMatch + " *\\(" + variableMatch + ", *" + variableMatch + "\\) *\\{") + ("return *" + variableMatch + " *\\+ *" + variableMatch + ";") + "\\}, *" + ("'\\w{5}' *: *function *" + variableMatch + " *\\(" + variableMatch + ", *" + variableMatch + "\\) *\\{") + ("return *" + variableMatch + " *- *" + variableMatch + ";") + "\\}" + "\\};");
            var obfuscatedCode = void 0;
            before(function () {
                var code = readFileAsString_1.readFileAsString(__dirname + '/fixtures/multiple-items.js');
                var obfuscationResult = JavaScriptObfuscator_1.JavaScriptObfuscator.obfuscate(code, Object.assign({}, NoCustomNodes_1.NO_CUSTOM_NODES_PRESET, { controlFlowFlattening: true, controlFlowFlatteningThreshold: 1 }));
                obfuscatedCode = obfuscationResult.getObfuscatedCode();
            });
            it('should add `control flow storage` node with multiple items to the obfuscated code', function () {
                chai_1.assert.match(obfuscatedCode, regexp);
            });
        });
        describe('variant #4 - transformed node in the root block scope', function () {
            var regExp = /^var *test *= *0x1 *\+ *0x2;$/;
            var obfuscatedCode = void 0;
            before(function () {
                var code = readFileAsString_1.readFileAsString(__dirname + '/fixtures/root-block-scope-1.js');
                var obfuscationResult = JavaScriptObfuscator_1.JavaScriptObfuscator.obfuscate(code, Object.assign({}, NoCustomNodes_1.NO_CUSTOM_NODES_PRESET, { controlFlowFlattening: true, controlFlowFlatteningThreshold: 1 }));
                obfuscatedCode = obfuscationResult.getObfuscatedCode();
            });
            it('should\'t add control flow storage node', function () {
                chai_1.assert.match(obfuscatedCode, regExp);
            });
        });
        describe('variant #5 - transformed nodes not in the root block scope', function () {
            var expectedValue = 0;
            var samplesCount = 20;
            var regExp = new RegExp("var *[a-zA-Z]{6} *= *\\{" + ("'\\w{5}' *: *function *_0x[0-9] *\\(" + variableMatch + ", *" + variableMatch + "\\) *\\{") + ("return *" + variableMatch + " *\\+ *" + variableMatch + ";") + "\\}" + "\\};");
            var code = readFileAsString_1.readFileAsString(__dirname + '/fixtures/root-block-scope-2.js');
            var totalValue = 0;
            before(function () {
                for (var i = 0; i < samplesCount; i++) {
                    var obfuscationResult = JavaScriptObfuscator_1.JavaScriptObfuscator.obfuscate(code, Object.assign({}, NoCustomNodes_1.NO_CUSTOM_NODES_PRESET, { controlFlowFlattening: true, controlFlowFlatteningThreshold: 1 }));
                    var obfuscatedCode = obfuscationResult.getObfuscatedCode();
                    if (regExp.test(obfuscatedCode)) {
                        totalValue++;
                    }
                }
            });
            it('should\'t add control flow storage node to the root block scope', function () {
                chai_1.assert.equal(totalValue, expectedValue);
            });
        });
        describe('variant #6 - threshold is `0`', function () {
            var regexp = /var *_0x([a-f0-9]){4,6} *= *0x1 *\+ *0x2;/;
            var controlFlowStorageRegExp = new RegExp(rootControlFlowStorageNodeMatch);
            var obfuscatedCode = void 0;
            before(function () {
                var code = readFileAsString_1.readFileAsString(__dirname + '/fixtures/zero-threshold.js');
                var obfuscationResult = JavaScriptObfuscator_1.JavaScriptObfuscator.obfuscate(code, Object.assign({}, NoCustomNodes_1.NO_CUSTOM_NODES_PRESET, { controlFlowFlattening: true, controlFlowFlatteningThreshold: 0 }));
                obfuscatedCode = obfuscationResult.getObfuscatedCode();
            });
            it('shouldn\'t add call to control flow storage node to the obfuscated code', function () {
                chai_1.assert.match(obfuscatedCode, regexp);
            });
            it('shouldn\'t add `control flow storage` node to the obfuscated code', function () {
                chai_1.assert.notMatch(obfuscatedCode, controlFlowStorageRegExp);
            });
        });
        describe('arrow function expression', function () {
            describe('variant #1 - arrow function expression with body', function () {
                var regexp = new RegExp(rootControlFlowStorageNodeMatch);
                var obfuscatedCode = void 0;
                before(function () {
                    var code = readFileAsString_1.readFileAsString(__dirname + '/fixtures/arrow-function-expression-with-body.js');
                    var obfuscationResult = JavaScriptObfuscator_1.JavaScriptObfuscator.obfuscate(code, Object.assign({}, NoCustomNodes_1.NO_CUSTOM_NODES_PRESET, { controlFlowFlattening: true, controlFlowFlatteningThreshold: 1 }));
                    obfuscatedCode = obfuscationResult.getObfuscatedCode();
                });
                it('should add `control flow storage` node to the obfuscated code', function () {
                    chai_1.assert.match(obfuscatedCode, regexp);
                });
            });
            describe('variant #2 - arrow function expression without body', function () {
                var regexp = new RegExp("var *" + variableMatch + " *= *\\(\\) *=> *0x1 *\\+ *0x2;");
                var obfuscatedCode = void 0;
                before(function () {
                    var code = readFileAsString_1.readFileAsString(__dirname + '/fixtures/arrow-function-expression-without-body.js');
                    var obfuscationResult = JavaScriptObfuscator_1.JavaScriptObfuscator.obfuscate(code, Object.assign({}, NoCustomNodes_1.NO_CUSTOM_NODES_PRESET, { controlFlowFlattening: true, controlFlowFlatteningThreshold: 1 }));
                    obfuscatedCode = obfuscationResult.getObfuscatedCode();
                });
                it('shouldn\'t add `control flow storage` node to the obfuscated code', function () {
                    chai_1.assert.match(obfuscatedCode, regexp);
                });
            });
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRnVuY3Rpb25Db250cm9sRmxvd1RyYW5zZm9ybWVyLnNwZWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi90ZXN0L2Z1bmN0aW9uYWwtdGVzdHMvbm9kZS10cmFuc2Zvcm1lcnMvY29udHJvbC1mbG93LXRyYW5zZm9ybWVycy9mdW5jdGlvbi1jb250cm9sLWZsb3ctdHJhbnNmb3JtZXIvRnVuY3Rpb25Db250cm9sRmxvd1RyYW5zZm9ybWVyLnNwZWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEscUJBQThCO0FBSTlCLDhCQUEwRjtBQUUxRixpQ0FBd0U7QUFFeEUscUNBQStFO0FBRS9FLEFBQVEsU0FBQyxBQUFnQyxrQ0FBRTtBQUN2QyxBQUFJLFNBQUMsQUFBTyxRQUFDLEFBQU0sQUFBQyxBQUFDO0FBRXJCLFFBQU0sQUFBYSxnQkFBVyxBQUFvQixBQUFDO0FBQ25ELFFBQU0sQUFBK0Isa0NBQVcsQUFBRSxBQUM5QyxnQkFBUSxBQUFhLEFBQVUsQUFDM0IsMkRBQTBCLEFBQWEsMEJBQVEsQUFBYSx3QkFBTSxBQUFhLEFBQVUsQUFDckYsNENBQVcsQUFBYSw0QkFBVSxBQUFhLEFBQUcsQUFDdEQsQUFBSyxBQUNULEFBQU0sQUFDVixBQUFFLEFBQUM7QUFDSCxRQUFNLEFBQWdDLG1DQUFXLEFBQUUsQUFDL0MsZ0JBQVEsQUFBYSxBQUFVLEFBQzNCLDJEQUEwQixBQUFhLDBCQUFRLEFBQWEsd0JBQU0sQUFBYSxBQUFVLEFBQ3JGLDRDQUFXLEFBQWEsc0NBQW9CLEFBQWEsd0JBQU0sQUFBYSxBQUFNLEFBQ3RGLEFBQUssQUFDVCxBQUFNLEFBQ1YsQUFBRSxBQUFDO0FBRUgsQUFBUSxhQUFDLEFBQTRELDhEQUFFO0FBQ25FLEFBQVEsaUJBQUMsQUFBa0Usb0VBQUU7QUFDekUsZ0JBQU0sQUFBTSxTQUFXLElBQUksQUFBTSxPQUFDLEFBQStCLEFBQUMsQUFBQztBQUVuRSxnQkFBSSxBQUFzQixBQUFDO0FB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dGlvblJlc3VsdCB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL3NyYy9pbnRlcmZhY2VzL0lPYmZ1c2NhdGlvblJlc3VsdCc7XG5cbmltcG9ydCB7IE5PX0NVU1RPTV9OT0RFU19QUkVTRVQgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9zcmMvb3B0aW9ucy9wcmVzZXRzL05vQ3VzdG9tTm9kZXMnO1xuXG5pbXBvcnQgeyByZWFkRmlsZUFzU3RyaW5nIH0gZnJvbSAnLi4vLi4vLi4vLi4vaGVscGVycy9yZWFkRmlsZUFzU3RyaW5nJztcblxuaW1wb3J0IHsgSmF2YVNjcmlwdE9iZnVzY2F0b3IgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9zcmMvSmF2YVNjcmlwdE9iZnVzY2F0b3InO1xuXG5kZXNjcmliZSgnRnVuY3Rpb25Db250cm9sRmxvd1RyYW5zZm9ybWVyJywgZnVuY3Rpb24gKCkge1xuICAgIHRoaXMudGltZW91dCgxMDAwMDApO1xuXG4gICAgY29uc3QgdmFyaWFibGVNYXRjaDogc3RyaW5nID0gJ18weChbYS1mMC05XSl7NCw2fSc7XG4gICAgY29uc3Qgcm9vdENvbnRyb2xGbG93U3RvcmFnZU5vZGVNYXRjaDogc3RyaW5nID0gYGAgK1xuICAgICAgICBgdmFyICoke3ZhcmlhYmxlTWF0Y2h9ICo9ICpcXFxce2AgK1xuICAgICAgICAgICAgYCdcXFxcd3s1fScgKjogKmZ1bmN0aW9uICoke3ZhcmlhYmxlTWF0Y2h9ICpcXFxcKCR7dmFyaWFibGVNYXRjaH0sICoke3ZhcmlhYmxlTWF0Y2h9XFxcXCkgKlxcXFx7YCArXG4gICAgICAgICAgICAgICAgYHJldHVybiAqJHt2YXJpYWJsZU1hdGNofSAqXFxcXCsgKiR7dmFyaWFibGVNYXRjaH07YCArXG4gICAgICAgICAgICBgXFxcXH1gICtcbiAgICAgICAgYFxcXFx9O2AgK1xuICAgIGBgO1xuICAgIGNvbnN0IGlubmVyQ29udHJvbEZsb3dTdG9yYWdlTm9kZU1hdGNoOiBzdHJpbmcgPSBgYCArXG4gICAgICAgIGB2YXIgKiR7dmFyaWFibGVNYXRjaH0gKj0gKlxcXFx7YCArXG4gICAgICAgICAgICBgJ1xcXFx3ezV9JyAqOiAqZnVuY3Rpb24gKiR7dmFyaWFibGVNYXRjaH0gKlxcXFwoJHt2YXJpYWJsZU1hdGNofSwgKiR7dmFyaWFibGVNYXRjaH1cXFxcKSAqXFxcXHtgICtcbiAgICAgICAgICAgICAgICBgcmV0dXJuICoke3ZhcmlhYmxlTWF0Y2h9XFxcXFsnXFxcXHd7NX0nXFxcXF1cXFxcKCR7dmFyaWFibGVNYXRjaH0sICoke3ZhcmlhYmxlTWF0Y2h9XFxcXCk7YCArXG4gICAgICAgICAgICBgXFxcXH1gICtcbiAgICAgICAgYFxcXFx9O2AgK1xuICAgIGBgO1xuXG4gICAgZGVzY3JpYmUoJ3RyYW5zZm9ybU5vZGUgKGZ1bmN0aW9uTm9kZTogRVNUcmVlLkZ1bmN0aW9uKTogRVNUcmVlLk5vZGUnLCAoKSA9PiB7XG4gICAgICAgIGRlc2NyaWJlKCd2YXJpYW50ICMxIC0gc2luZ2xlIGBjb250cm9sIGZsb3cgc3RvcmFnZWAgbm9kZSB3aXRoIHNpbmdsZSBpdGVtJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVnZXhwOiBSZWdFeHAgPSBuZXcgUmVnRXhwKHJvb3RDb250cm9sRmxvd1N0b3JhZ2VOb2RlTWF0Y2gpO1xuXG4gICAgICAgICAgICBsZXQgb2JmdXNjYXRlZENvZGU6IHN0cmluZztcblxuICAgICAgICAgICAgYmVmb3JlKCgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb2RlOiBzdHJpbmcgPSByZWFkRmlsZUFzU3RyaW5nKF9fZGlybmFtZSArICcvZml4dHVyZXMvaW5wdXQtMS5qcycpO1xuICAgICAgICAgICAgICAgIGNvbnN0IG9iZnVzY2F0aW9uUmVzdWx0OiBJT2JmdXNjYXRpb25SZXN1bHQgPSBKYXZhU2NyaXB0T2JmdXNjYXRvci5vYmZ1c2NhdGUoXG4gICAgICAgICAgICAgICAgICAgIGNvZGUsXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLk5PX0NVU1RPTV9OT0RFU19QUkVTRVQsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sRmxvd0ZsYXR0ZW5pbmc6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sRmxvd0ZsYXR0ZW5pbmdUaHJlc2hvbGQ6IDFcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICBvYmZ1c2NhdGVkQ29kZSA9IG9iZnVzY2F0aW9uUmVzdWx0LmdldE9iZnVzY2F0ZWRDb2RlKCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaXQoJ3Nob3VsZCBhZGQgYGNvbnRyb2wgZmxvdyBzdG9yYWdlYCBub2RlIHRvIHRoZSBvYmZ1c2NhdGVkIGNvZGUnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgYXNzZXJ0Lm1hdGNoKG9iZnVzY2F0ZWRDb2RlLCByZWdleHApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGRlc2NyaWJlKCd2YXJpYW50ICMyIC0gdHdvIGBjb250cm9sIGZsb3cgc3RvcmFnZWAgbm9kZXM6IHJvb3QgYW5kIGlubmVyJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZXhwZWN0ZWRBcHBlbmRUb1Njb3BlVGhyZXNob2xkOiBudW1iZXIgPSAwLjU7XG5cbiAgICAgICAgICAgIGNvbnN0IHNhbXBsZXNDb3VudDogbnVtYmVyID0gMTAwMDtcbiAgICAgICAgICAgIGNvbnN0IGRlbHRhOiBudW1iZXIgPSAwLjE7XG5cbiAgICAgICAgICAgIGNvbnN0IHJlZ0V4cDE6IFJlZ0V4cCA9IG5ldyBSZWdFeHAoXG4gICAgICAgICAgICAgICAgYFxcXFwoZnVuY3Rpb25cXFxcKFxcXFwpICpcXFxceyAqJHtyb290Q29udHJvbEZsb3dTdG9yYWdlTm9kZU1hdGNofWAsXG4gICAgICAgICAgICAgICAgJ2cnXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgY29uc3QgcmVnRXhwMjogUmVnRXhwID0gbmV3IFJlZ0V4cChcbiAgICAgICAgICAgICAgICBgZnVuY3Rpb24gKiR7dmFyaWFibGVNYXRjaH0gKlxcXFwoXFxcXCkgKlxcXFx7ICoke2lubmVyQ29udHJvbEZsb3dTdG9yYWdlTm9kZU1hdGNofWAsXG4gICAgICAgICAgICAgICAgJ2cnXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBsZXQgYXBwZW5kVG9TY29wZVRocmVzaG9sZDogbnVtYmVyID0gMDtcblxuICAgICAgICAgICAgYmVmb3JlKCgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb2RlOiBzdHJpbmcgPSByZWFkRmlsZUFzU3RyaW5nKF9fZGlybmFtZSArICcvZml4dHVyZXMvaW5wdXQtMi5qcycpO1xuXG4gICAgICAgICAgICAgICAgbGV0IG9iZnVzY2F0aW9uUmVzdWx0OiBJT2JmdXNjYXRpb25SZXN1bHQsXG4gICAgICAgICAgICAgICAgICAgIG9iZnVzY2F0ZWRDb2RlOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgIHRvdGFsVmFsdWU6IG51bWJlciA9IDA7XG5cbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNhbXBsZXNDb3VudDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIG9iZnVzY2F0aW9uUmVzdWx0ID0gSmF2YVNjcmlwdE9iZnVzY2F0b3Iub2JmdXNjYXRlKFxuICAgICAgICAgICAgICAgICAgICAgICAgY29kZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5OT19DVVNUT01fTk9ERVNfUFJFU0VULFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xGbG93RmxhdHRlbmluZzogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sRmxvd0ZsYXR0ZW5pbmdUaHJlc2hvbGQ6IDFcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgb2JmdXNjYXRlZENvZGUgPSBvYmZ1c2NhdGlvblJlc3VsdC5nZXRPYmZ1c2NhdGVkQ29kZSgpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZWdFeHAxLnRlc3Qob2JmdXNjYXRlZENvZGUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0b3RhbFZhbHVlICs9IG9iZnVzY2F0ZWRDb2RlLm1hdGNoKHJlZ0V4cDEpIS5sZW5ndGg7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWdFeHAyLnRlc3Qob2JmdXNjYXRlZENvZGUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG90YWxWYWx1ZSArPSBvYmZ1c2NhdGVkQ29kZS5tYXRjaChyZWdFeHAyKSEubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgYXBwZW5kVG9TY29wZVRocmVzaG9sZCA9ICh0b3RhbFZhbHVlIC0gc2FtcGxlc0NvdW50KSAvIHNhbXBsZXNDb3VudDtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpdCgnc2hvdWxkIGFkZCB0d28gYGNvbnRyb2wgZmxvdyBzdG9yYWdlYCBub2RlcyAocm9vdCBhbmQgaW5uZXIpIHRvIHRoZSBvYmZ1c2NhdGVkIGNvZGUgaW4gZGlmZmVyZW50IHNjb3BlcycsICgpID0+IHtcbiAgICAgICAgICAgICAgICBhc3NlcnQuY2xvc2VUbyhhcHBlbmRUb1Njb3BlVGhyZXNob2xkLCBleHBlY3RlZEFwcGVuZFRvU2NvcGVUaHJlc2hvbGQsIGRlbHRhKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBkZXNjcmliZSgndmFyaWFudCAjMyAtIHNpbmdsZSBgY29udHJvbCBmbG93IHN0b3JhZ2VgIG5vZGUgd2l0aCBtdWx0aXBsZSBpdGVtcycsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlZ2V4cDogUmVnRXhwID0gbmV3IFJlZ0V4cChcbiAgICAgICAgICAgICAgICBgdmFyICoke3ZhcmlhYmxlTWF0Y2h9ICo9ICpcXFxce2AgK1xuICAgICAgICAgICAgICAgICAgICBgJ1xcXFx3ezV9JyAqOiAqZnVuY3Rpb24gKiR7dmFyaWFibGVNYXRjaH0gKlxcXFwoJHt2YXJpYWJsZU1hdGNofSwgKiR7dmFyaWFibGVNYXRjaH1cXFxcKSAqXFxcXHtgICtcbiAgICAgICAgICAgICAgICAgICAgICAgIGByZXR1cm4gKiR7dmFyaWFibGVNYXRjaH0gKlxcXFwrICoke3ZhcmlhYmxlTWF0Y2h9O2AgK1xuICAgICAgICAgICAgICAgICAgICBgXFxcXH0sICpgICtcbiAgICAgICAgICAgICAgICAgICAgYCdcXFxcd3s1fScgKjogKmZ1bmN0aW9uICoke3ZhcmlhYmxlTWF0Y2h9ICpcXFxcKCR7dmFyaWFibGVNYXRjaH0sICoke3ZhcmlhYmxlTWF0Y2h9XFxcXCkgKlxcXFx7YCArXG4gICAgICAgICAgICAgICAgICAgICAgICBgcmV0dXJuICoke3ZhcmlhYmxlTWF0Y2h9ICotICoke3ZhcmlhYmxlTWF0Y2h9O2AgK1xuICAgICAgICAgICAgICAgICAgICBgXFxcXH1gICtcbiAgICAgICAgICAgICAgICBgXFxcXH07YFxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgbGV0IG9iZnVzY2F0ZWRDb2RlOiBzdHJpbmc7XG5cbiAgICAgICAgICAgIGJlZm9yZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgY29kZTogc3RyaW5nID0gcmVhZEZpbGVBc1N0cmluZyhfX2Rpcm5hbWUgKyAnL2ZpeHR1cmVzL211bHRpcGxlLWl0ZW1zLmpzJyk7XG4gICAgICAgICAgICAgICAgY29uc3Qgb2JmdXNjYXRpb25SZXN1bHQ6IElPYmZ1c2NhdGlvblJlc3VsdCA9IEphdmFTY3JpcHRPYmZ1c2NhdG9yLm9iZnVzY2F0ZShcbiAgICAgICAgICAgICAgICAgICAgY29kZSxcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgLi4uTk9fQ1VTVE9NX05PREVTX1BSRVNFVCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xGbG93RmxhdHRlbmluZzogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xGbG93RmxhdHRlbmluZ1RocmVzaG9sZDogMVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgIG9iZnVzY2F0ZWRDb2RlID0gb2JmdXNjYXRpb25SZXN1bHQuZ2V0T2JmdXNjYXRlZENvZGUoKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpdCgnc2hvdWxkIGFkZCBgY29udHJvbCBmbG93IHN0b3JhZ2VgIG5vZGUgd2l0aCBtdWx0aXBsZSBpdGVtcyB0byB0aGUgb2JmdXNjYXRlZCBjb2RlJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGFzc2VydC5tYXRjaChvYmZ1c2NhdGVkQ29kZSwgcmVnZXhwKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBkZXNjcmliZSgndmFyaWFudCAjNCAtIHRyYW5zZm9ybWVkIG5vZGUgaW4gdGhlIHJvb3QgYmxvY2sgc2NvcGUnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZWdFeHA6IFJlZ0V4cCA9IC9edmFyICp0ZXN0ICo9ICoweDEgKlxcKyAqMHgyOyQvO1xuXG4gICAgICAgICAgICBsZXQgb2JmdXNjYXRlZENvZGU6IHN0cmluZztcblxuICAgICAgICAgICAgYmVmb3JlKCgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb2RlOiBzdHJpbmcgPSByZWFkRmlsZUFzU3RyaW5nKF9fZGlybmFtZSArICcvZml4dHVyZXMvcm9vdC1ibG9jay1zY29wZS0xLmpzJyk7XG4gICAgICAgICAgICAgICAgY29uc3Qgb2JmdXNjYXRpb25SZXN1bHQ6IElPYmZ1c2NhdGlvblJlc3VsdCA9IEphdmFTY3JpcHRPYmZ1c2NhdG9yLm9iZnVzY2F0ZShcbiAgICAgICAgICAgICAgICAgICAgY29kZSxcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgLi4uTk9fQ1VTVE9NX05PREVTX1BSRVNFVCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xGbG93RmxhdHRlbmluZzogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xGbG93RmxhdHRlbmluZ1RocmVzaG9sZDogMVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgIG9iZnVzY2F0ZWRDb2RlID0gb2JmdXNjYXRpb25SZXN1bHQuZ2V0T2JmdXNjYXRlZENvZGUoKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpdCgnc2hvdWxkXFwndCBhZGQgY29udHJvbCBmbG93IHN0b3JhZ2Ugbm9kZScsICgpID0+IHtcbiAgICAgICAgICAgICAgICBhc3NlcnQubWF0Y2gob2JmdXNjYXRlZENvZGUsIHJlZ0V4cCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgZGVzY3JpYmUoJ3ZhcmlhbnQgIzUgLSB0cmFuc2Zvcm1lZCBub2RlcyBub3QgaW4gdGhlIHJvb3QgYmxvY2sgc2NvcGUnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBleHBlY3RlZFZhbHVlOiBudW1iZXIgPSAwO1xuICAgICAgICAgICAgY29uc3Qgc2FtcGxlc0NvdW50OiBudW1iZXIgPSAyMDtcblxuICAgICAgICAgICAgY29uc3QgcmVnRXhwOiBSZWdFeHAgPSBuZXcgUmVnRXhwKFxuICAgICAgICAgICAgICAgIGB2YXIgKlthLXpBLVpdezZ9ICo9ICpcXFxce2AgK1xuICAgICAgICAgICAgICAgICAgICBgJ1xcXFx3ezV9JyAqOiAqZnVuY3Rpb24gKl8weFswLTldICpcXFxcKCR7dmFyaWFibGVNYXRjaH0sICoke3ZhcmlhYmxlTWF0Y2h9XFxcXCkgKlxcXFx7YCArXG4gICAgICAgICAgICAgICAgICAgICAgICBgcmV0dXJuICoke3ZhcmlhYmxlTWF0Y2h9ICpcXFxcKyAqJHt2YXJpYWJsZU1hdGNofTtgICtcbiAgICAgICAgICAgICAgICAgICAgYFxcXFx9YCArXG4gICAgICAgICAgICAgICAgYFxcXFx9O2BcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGNvbnN0IGNvZGU6IHN0cmluZyA9IHJlYWRGaWxlQXNTdHJpbmcoX19kaXJuYW1lICsgJy9maXh0dXJlcy9yb290LWJsb2NrLXNjb3BlLTIuanMnKTtcblxuICAgICAgICAgICAgbGV0IHRvdGFsVmFsdWU6IG51bWJlciA9IDA7XG5cbiAgICAgICAgICAgIGJlZm9yZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzYW1wbGVzQ291bnQ7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBvYmZ1c2NhdGlvblJlc3VsdDogSU9iZnVzY2F0aW9uUmVzdWx0ID0gSmF2YVNjcmlwdE9iZnVzY2F0b3Iub2JmdXNjYXRlKFxuICAgICAgICAgICAgICAgICAgICAgICAgY29kZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5OT19DVVNUT01fTk9ERVNfUFJFU0VULFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xGbG93RmxhdHRlbmluZzogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sRmxvd0ZsYXR0ZW5pbmdUaHJlc2hvbGQ6IDFcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2JmdXNjYXRlZENvZGU6IHN0cmluZyA9IG9iZnVzY2F0aW9uUmVzdWx0LmdldE9iZnVzY2F0ZWRDb2RlKCk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlZ0V4cC50ZXN0KG9iZnVzY2F0ZWRDb2RlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdG90YWxWYWx1ZSsrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGl0KCdzaG91bGRcXCd0IGFkZCBjb250cm9sIGZsb3cgc3RvcmFnZSBub2RlIHRvIHRoZSByb290IGJsb2NrIHNjb3BlJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGFzc2VydC5lcXVhbCh0b3RhbFZhbHVlLCBleHBlY3RlZFZhbHVlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBkZXNjcmliZSgndmFyaWFudCAjNiAtIHRocmVzaG9sZCBpcyBgMGAnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZWdleHA6IFJlZ0V4cCA9IC92YXIgKl8weChbYS1mMC05XSl7NCw2fSAqPSAqMHgxICpcXCsgKjB4MjsvO1xuICAgICAgICAgICAgY29uc3QgY29udHJvbEZsb3dTdG9yYWdlUmVnRXhwOiBSZWdFeHAgPSBuZXcgUmVnRXhwKHJvb3RDb250cm9sRmxvd1N0b3JhZ2VOb2RlTWF0Y2gpO1xuXG4gICAgICAgICAgICBsZXQgb2JmdXNjYXRlZENvZGU6IHN0cmluZztcblxuICAgICAgICAgICAgYmVmb3JlKCgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb2RlOiBzdHJpbmcgPSByZWFkRmlsZUFzU3RyaW5nKF9fZGlybmFtZSArICcvZml4dHVyZXMvemVyby10aHJlc2hvbGQuanMnKTtcbiAgICAgICAgICAgICAgICBjb25zdCBvYmZ1c2NhdGlvblJlc3VsdDogSU9iZnVzY2F0aW9uUmVzdWx0ID0gSmF2YVNjcmlwdE9iZnVzY2F0b3Iub2JmdXNjYXRlKFxuICAgICAgICAgICAgICAgICAgICBjb2RlLFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAuLi5OT19DVVNUT01fTk9ERVNfUFJFU0VULFxuICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbEZsb3dGbGF0dGVuaW5nOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbEZsb3dGbGF0dGVuaW5nVGhyZXNob2xkOiAwXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgb2JmdXNjYXRlZENvZGUgPSBvYmZ1c2NhdGlvblJlc3VsdC5nZXRPYmZ1c2NhdGVkQ29kZSgpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGl0KCdzaG91bGRuXFwndCBhZGQgY2FsbCB0byBjb250cm9sIGZsb3cgc3RvcmFnZSBub2RlIHRvIHRoZSBvYmZ1c2NhdGVkIGNvZGUnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgYXNzZXJ0Lm1hdGNoKG9iZnVzY2F0ZWRDb2RlLCByZWdleHApO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGl0KCdzaG91bGRuXFwndCBhZGQgYGNvbnRyb2wgZmxvdyBzdG9yYWdlYCBub2RlIHRvIHRoZSBvYmZ1c2NhdGVkIGNvZGUnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgYXNzZXJ0Lm5vdE1hdGNoKG9iZnVzY2F0ZWRDb2RlLCBjb250cm9sRmxvd1N0b3JhZ2VSZWdFeHApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGRlc2NyaWJlKCdhcnJvdyBmdW5jdGlvbiBleHByZXNzaW9uJywgKCkgPT4ge1xuICAgICAgICAgICAgZGVzY3JpYmUoJ3ZhcmlhbnQgIzEgLSBhcnJvdyBmdW5jdGlvbiBleHByZXNzaW9uIHdpdGggYm9keScsICgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCByZWdleHA6IFJlZ0V4cCA9IG5ldyBSZWdFeHAocm9vdENvbnRyb2xGbG93U3RvcmFnZU5vZGVNYXRjaCk7XG5cbiAgICAgICAgICAgICAgICBsZXQgb2JmdXNjYXRlZENvZGU6IHN0cmluZztcblxuICAgICAgICAgICAgICAgIGJlZm9yZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvZGU6IHN0cmluZyA9IHJlYWRGaWxlQXNTdHJpbmcoX19kaXJuYW1lICsgJy9maXh0dXJlcy9hcnJvdy1mdW5jdGlvbi1leHByZXNzaW9uLXdpdGgtYm9keS5qcycpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBvYmZ1c2NhdGlvblJlc3VsdDogSU9iZnVzY2F0aW9uUmVzdWx0ID0gSmF2YVNjcmlwdE9iZnVzY2F0b3Iub2JmdXNjYXRlKFxuICAgICAgICAgICAgICAgICAgICAgICAgY29kZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5OT19DVVNUT01fTk9ERVNfUFJFU0VULFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xGbG93RmxhdHRlbmluZzogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sRmxvd0ZsYXR0ZW5pbmdUaHJlc2hvbGQ6IDFcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgICAgICBvYmZ1c2NhdGVkQ29kZSA9IG9iZnVzY2F0aW9uUmVzdWx0LmdldE9iZnVzY2F0ZWRDb2RlKCk7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBpdCgnc2hvdWxkIGFkZCBgY29udHJvbCBmbG93IHN0b3JhZ2VgIG5vZGUgdG8gdGhlIG9iZnVzY2F0ZWQgY29kZScsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0Lm1hdGNoKG9iZnVzY2F0ZWRDb2RlLCByZWdleHApO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGRlc2NyaWJlKCd2YXJpYW50ICMyIC0gYXJyb3cgZnVuY3Rpb24gZXhwcmVzc2lvbiB3aXRob3V0IGJvZHknLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVnZXhwOiBSZWdFeHAgPSBuZXcgUmVnRXhwKGB2YXIgKiR7dmFyaWFibGVNYXRjaH0gKj0gKlxcXFwoXFxcXCkgKj0+ICoweDEgKlxcXFwrICoweDI7YCk7XG5cbiAgICAgICAgICAgICAgICBsZXQgb2JmdXNjYXRlZENvZGU6IHN0cmluZztcblxuICAgICAgICAgICAgICAgIGJlZm9yZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvZGU6IHN0cmluZyA9IHJlYWRGaWxlQXNTdHJpbmcoX19kaXJuYW1lICsgJy9maXh0dXJlcy9hcnJvdy1mdW5jdGlvbi1leHByZXNzaW9uLXdpdGhvdXQtYm9keS5qcycpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBvYmZ1c2NhdGlvblJlc3VsdDogSU9iZnVzY2F0aW9uUmVzdWx0ID0gSmF2YVNjcmlwdE9iZnVzY2F0b3Iub2JmdXNjYXRlKFxuICAgICAgICAgICAgICAgICAgICAgICAgY29kZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5OT19DVVNUT01fTk9ERVNfUFJFU0VULFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xGbG93RmxhdHRlbmluZzogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sRmxvd0ZsYXR0ZW5pbmdUaHJlc2hvbGQ6IDFcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgICAgICBvYmZ1c2NhdGVkQ29kZSA9IG9iZnVzY2F0aW9uUmVzdWx0LmdldE9iZnVzY2F0ZWRDb2RlKCk7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBpdCgnc2hvdWxkblxcJ3QgYWRkIGBjb250cm9sIGZsb3cgc3RvcmFnZWAgbm9kZSB0byB0aGUgb2JmdXNjYXRlZCBjb2RlJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBhc3NlcnQubWF0Y2gob2JmdXNjYXRlZENvZGUsIHJlZ2V4cCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59KTtcbiJdfQ==